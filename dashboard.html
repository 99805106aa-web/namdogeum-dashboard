<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
<meta name="theme-color" content="#2563EB">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<title>ë‚¨ë„ê¸ˆí˜• ìŠ¤ë§ˆíŠ¸ í’ˆì§ˆ ëª¨ë‹ˆí„°ë§</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root {
  --primary: #2563EB;
  --danger: #DC2626;
  --success: #16A34A;
  --warning: #F59E0B;
  --gray: #6B7280;
  --bg: #F3F4F6;
  --card: #FFFFFF;
  --border: #E5E7EB;
  --text: #1F2937;
  --text-light: #6B7280;
  --sidebar-w: 320px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
}
body::before {
  content: '';
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(135deg, rgba(27,42,107,0.08) 0%, rgba(180,30,40,0.04) 100%), url('bg-factory.jpg') center/cover no-repeat fixed;
  opacity: 0.12;
  z-index: 0;
  pointer-events: none;
}
body.dark::before {
  background: linear-gradient(135deg, rgba(27,42,107,0.3) 0%, rgba(180,30,40,0.1) 100%), url('bg-factory.jpg') center/cover no-repeat fixed;
  opacity: 0.3;
}

/* â”€â”€ í–„ë²„ê±° ë²„íŠ¼ (ëª¨ë°”ì¼) â”€â”€ */
.menu-toggle {
  display: none;
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 1100;
  width: 44px;
  height: 44px;
  border: none;
  border-radius: 10px;
  background: var(--primary);
  color: #fff;
  font-size: 22px;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
  -webkit-tap-highlight-color: transparent;
}

/* â”€â”€ ì˜¤ë²„ë ˆì´ (ëª¨ë°”ì¼) â”€â”€ */
.sidebar-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.4);
  z-index: 999;
  -webkit-tap-highlight-color: transparent;
}

/* â”€â”€ ì‚¬ì´ë“œë°” â”€â”€ */
.sidebar {
  width: var(--sidebar-w);
  min-width: var(--sidebar-w);
  background: var(--card);
  border-right: 1px solid var(--border);
  padding: 24px 20px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 16px;
  z-index: 1000;
  -webkit-overflow-scrolling: touch;
}
.sidebar h2 { font-size: 18px; color: var(--primary); margin-bottom: 4px; }
.sidebar h3 { font-size: 14px; color: var(--text-light); margin-bottom: 4px; }
.sidebar label { font-size: 13px; font-weight: 600; display: block; margin-bottom: 4px; }

.file-drop {
  border: 2px dashed var(--border);
  border-radius: 12px;
  padding: 28px 16px;
  text-align: center;
  cursor: pointer;
  transition: border-color .2s, background .2s;
  font-size: 14px;
  color: var(--text-light);
  -webkit-tap-highlight-color: transparent;
}
.file-drop:hover, .file-drop.dragover {
  border-color: var(--primary);
  background: #EFF6FF;
}
.file-drop input { display: none; }

select, input[type=date] {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 8px;
  font-size: 14px;
  background: #fff;
  -webkit-appearance: none;
  appearance: none;
  min-height: 44px;
}
select[multiple] { height: 130px; min-height: 130px; }

.slider-wrap { display: flex; align-items: center; gap: 8px; }
.slider-wrap input[type=range] { flex: 1; height: 36px; }
.slider-wrap .val { font-weight: 700; color: var(--danger); min-width: 48px; text-align: right; font-size: 14px; }
.slider-wrap .val-input { width: 60px; padding: 2px 4px; border: 1px solid var(--border); border-radius: 4px; font-weight: 700; color: var(--danger); text-align: right; font-size: 14px; background: var(--card-bg); }
.slider-wrap .val-input:focus { outline: 2px solid var(--primary); border-color: var(--primary); }

.btn {
  display: block;
  width: 100%;
  padding: 14px;
  border: none;
  border-radius: 10px;
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  transition: opacity .2s;
  -webkit-tap-highlight-color: transparent;
  min-height: 48px;
}
.btn:hover { opacity: .85; }
.btn:active { opacity: .7; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-success { background: var(--success); color: #fff; }
.btn-danger  { background: var(--danger);  color: #fff; }
.btn-sm { padding: 10px 16px; font-size: 13px; width: auto; display: inline-block; min-height: 40px; }

.info-box {
  padding: 10px 14px;
  border-radius: 8px;
  font-size: 13px;
}
.info-box.info    { background: #DBEAFE; color: #1E40AF; }
.info-box.success { background: #D1FAE5; color: #065F46; }
.info-box.warn    { background: #FEF3C7; color: #92400E; }

/* â”€â”€ ë©”ì¸ â”€â”€ */
.main {
  flex: 1;
  padding: 24px 28px;
  overflow-y: auto;
  min-width: 0;
  position: relative;
  z-index: 1;
}
.main h1 {
  font-size: 24px;
  margin-bottom: 20px;
}

/* íƒ­ */
.tabs {
  display: flex;
  gap: 0;
  border-bottom: 2px solid var(--border);
  margin-bottom: 20px;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.tabs::-webkit-scrollbar { display: none; }
.tab-btn {
  padding: 12px 20px;
  border: none;
  background: none;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  color: var(--text-light);
  border-bottom: 3px solid transparent;
  margin-bottom: -2px;
  transition: color .2s, border-color .2s;
  white-space: nowrap;
  flex-shrink: 0;
  -webkit-tap-highlight-color: transparent;
  min-height: 44px;
}
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-btn:hover { color: var(--primary); }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* KPI ì¹´ë“œ */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 14px;
  margin-bottom: 24px;
}
.kpi-card {
  background: var(--card);
  border-radius: 12px;
  padding: 18px 12px;
  text-align: center;
  border: 1px solid var(--border);
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
}
.kpi-card .value { font-size: 28px; font-weight: 800; }
.kpi-card .label { font-size: 12px; color: var(--text-light); margin-top: 4px; }

/* ì°¨íŠ¸ ë˜í¼ */
.chart-box {
  background: var(--card);
  border-radius: 12px;
  border: 1px solid var(--border);
  padding: 16px;
  margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}
.chart-box h3 { font-size: 15px; margin-bottom: 12px; }

/* í…Œì´ë¸” */
.tbl-wrap {
  overflow-x: auto;
  margin-bottom: 16px;
  -webkit-overflow-scrolling: touch;
}
table.data-tbl {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  min-width: 500px;
}
table.data-tbl th {
  background: var(--primary);
  color: #fff;
  padding: 10px 10px;
  text-align: left;
  position: sticky;
  top: 0;
  white-space: nowrap;
}
table.data-tbl td {
  padding: 9px 10px;
  border-bottom: 1px solid var(--border);
  white-space: nowrap;
}
table.data-tbl tr:hover td { background: #F0F7FF; }
table.data-tbl tr:active td { background: #DBEAFE; }

.placeholder {
  text-align: center;
  padding: 80px 20px;
  color: var(--text-light);
  font-size: 16px;
}
.placeholder .icon { font-size: 48px; margin-bottom: 12px; }
.placeholder-mobile { display: none; }
.placeholder-pc { display: inline; }

.export-bar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }

.section-divider {
  border: none;
  border-top: 1px solid var(--border);
  margin: 20px 0;
}

/* â”€â”€ í„°ì¹˜ ìŠ¤í¬ë¡¤ íŒíŠ¸ â”€â”€ */
.scroll-hint {
  text-align: center;
  font-size: 11px;
  color: var(--text-light);
  padding: 4px 0;
  display: none;
}

/* â”€â”€ í•˜ë‹¨ ê³ ì • ì•¡ì…˜ë°” (ëª¨ë°”ì¼) â”€â”€ */
.bottom-bar {
  display: none;
  position: fixed;
  bottom: 0; left: 0; right: 0;
  z-index: 1050;
  background: var(--card);
  border-top: 1px solid var(--border);
  padding: 8px 12px;
  padding-bottom: max(8px, env(safe-area-inset-bottom));
  box-shadow: 0 -2px 10px rgba(0,0,0,.1);
  gap: 8px;
  justify-content: space-around;
}
.bottom-bar button {
  flex: 1;
  padding: 10px 6px;
  border: none;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  min-height: 44px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
  background: var(--bg);
  color: var(--text);
}
.bottom-bar button .bar-icon { font-size: 18px; }
.bottom-bar button:active { background: var(--primary); color: #fff; }

/* â”€â”€ ëª¨ë°”ì¼ ë¶„ì„ì‹œì‘ í”Œë¡œíŒ… ë²„íŠ¼ â”€â”€ */
.mobile-analyze-fab {
  display: none;
  position: fixed;
  bottom: 76px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1060;
  padding: 14px 36px;
  border: none;
  border-radius: 50px;
  background: linear-gradient(135deg, #2563EB 0%, #1D4ED8 100%);
  color: #fff;
  font-size: 16px;
  font-weight: 800;
  cursor: pointer;
  box-shadow: 0 4px 20px rgba(37, 99, 235, 0.5), 0 2px 8px rgba(0,0,0,.15);
  -webkit-tap-highlight-color: transparent;
  animation: fab-pulse 2s ease-in-out infinite;
  white-space: nowrap;
  min-height: 52px;
  letter-spacing: 0.5px;
}
.mobile-analyze-fab:active {
  transform: translateX(-50%) scale(0.95);
  box-shadow: 0 2px 10px rgba(37, 99, 235, 0.4);
}
@keyframes fab-pulse {
  0%, 100% { box-shadow: 0 4px 20px rgba(37, 99, 235, 0.5), 0 2px 8px rgba(0,0,0,.15); }
  50% { box-shadow: 0 4px 30px rgba(37, 99, 235, 0.7), 0 4px 12px rgba(0,0,0,.2); }
}
body.dark .mobile-analyze-fab {
  background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%);
  box-shadow: 0 4px 20px rgba(59, 130, 246, 0.5), 0 2px 8px rgba(0,0,0,.3);
}

/* â”€â”€ ë“œë¦´ë‹¤ìš´ ëª¨ë‹¬ (ëª¨ë°”ì¼) â”€â”€ */
.drill-modal {
  display: none;
  position: fixed;
  inset: 0;
  z-index: 2000;
  background: var(--bg);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 16px;
  padding-top: 56px;
}
.drill-modal.open { display: block; }
.drill-modal-close {
  position: fixed;
  top: 10px; right: 10px;
  z-index: 2001;
  width: 40px; height: 40px;
  border: none; border-radius: 50%;
  background: var(--danger); color: #fff;
  font-size: 20px; font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,.2);
}

/* â”€â”€ í—¤ë” ë°” â”€â”€ */
.header-bar {
  display: flex;
  justify-content: space-between;
  align-items: flex-end;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 20px;
}
.header-info {
  text-align: right;
  font-size: 12px;
  color: var(--text-light);
  line-height: 1.6;
}
.header-author {
  font-weight: 700;
  color: var(--text);
  font-size: 13px;
}

/* â”€â”€ ëª¨ë°”ì¼ íƒ­ ê·¸ë¦¬ë“œ â”€â”€ */
.tabs-mobile-grid {
  display: none;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ëª¨ë°”ì¼ ë°˜ì‘í˜• (768px ì´í•˜)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 768px) {
  .menu-toggle { display: flex; align-items: center; justify-content: center; }

  .sidebar {
    position: fixed;
    top: 0; left: 0;
    height: 100vh; height: 100dvh;
    transform: translateX(-100%);
    transition: transform .3s ease;
    box-shadow: 2px 0 12px rgba(0,0,0,.15);
    width: 85vw;
    min-width: 280px;
    max-width: 360px;
    padding-top: 64px;
  }
  .sidebar.open { transform: translateX(0); }
  .sidebar-overlay.open { display: block; }

  /* ë‹¤í¬ëª¨ë“œ ë²„íŠ¼ â†’ ìœ„ì¹˜ ì¡°ì • */
  .dark-toggle { top: 12px; right: 56px; }

  .main {
    padding: 60px 10px 80px 10px; /* í•˜ë‹¨ ì•¡ì…˜ë°” ê³µê°„ í™•ë³´ */
    width: 100vw;
  }

  /* í—¤ë” ì„¸ë¡œ ë°°ì¹˜ */
  .header-bar {
    flex-direction: column;
    align-items: flex-start;
    gap: 4px;
  }
  .header-bar h1 { font-size: 18px; margin-bottom: 0; }
  .header-info { text-align: left; font-size: 11px; }

  /* íƒ­: ê°€ë¡œ ìŠ¤í¬ë¡¤ ìˆ¨ê¸°ê³  2ì—´ ê·¸ë¦¬ë“œ */
  .tabs { display: none !important; }
  .tabs-mobile-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 6px;
    margin-bottom: 16px;
  }
  .tabs-mobile-grid .tab-m-btn {
    padding: 10px 8px;
    border: 2px solid var(--border);
    border-radius: 10px;
    background: var(--card);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    color: var(--text-light);
    transition: all .2s;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 4px;
  }
  .tabs-mobile-grid .tab-m-btn.active {
    border-color: var(--primary);
    color: var(--primary);
    background: #EFF6FF;
  }
  body.dark .tabs-mobile-grid .tab-m-btn.active { background: #1E3A5F; }

  /* KPI */
  .kpi-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  .kpi-card { padding: 12px 8px; }
  .kpi-card .value { font-size: 20px; }
  .kpi-card .label { font-size: 10px; }

  /* ì „ì£¼ë¹„êµ ì¹´ë“œ â†’ 1í–‰ ê°€ë¡œ */
  .week-compare-grid {
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 6px !important;
  }
  .week-compare-grid .kpi-card { padding: 8px 4px; }
  .week-compare-grid .kpi-card .value { font-size: 14px; }
  .week-compare-grid .kpi-card .label { font-size: 9px; }

  /* ì°¨íŠ¸ */
  .chart-box { padding: 8px; margin-bottom: 12px; }
  .chart-box h3 { font-size: 13px; margin-bottom: 8px; }
  .chart-box p { font-size: 10px !important; }

  /* Plotly ëª¨ë“œë°” ëª¨ë°”ì¼ ìµœì í™” */
  .modebar-container { top: 0 !important; right: 0 !important; }
  .modebar-group { display: flex !important; }
  .modebar-btn { font-size: 16px !important; padding: 6px !important; }
  .modebar-btn svg { width: 20px !important; height: 20px !important; }

  .placeholder { padding: 50px 16px; font-size: 14px; cursor: pointer; }
  .placeholder-pc { display: none; }
  .placeholder-mobile { display: inline; }
  .scroll-hint { display: block; }

  /* í…Œì´ë¸” ì²«ì—´ ê³ ì • */
  table.data-tbl { font-size: 11px; }
  table.data-tbl th, table.data-tbl td { padding: 6px 7px; }
  table.data-tbl th:first-child,
  table.data-tbl td:first-child {
    position: sticky;
    left: 0;
    z-index: 2;
    background: inherit;
    box-shadow: 2px 0 4px rgba(0,0,0,.08);
    max-width: 140px;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  table.data-tbl th:first-child { background: var(--primary); z-index: 3; }

  /* í•˜ë‹¨ ê³ ì • ì•¡ì…˜ë°” */
  .bottom-bar { display: flex; }

  /* ëª¨ë°”ì¼ ë¶„ì„ì‹œì‘ í”Œë¡œíŒ… ë²„íŠ¼ */
  .mobile-analyze-fab.show { display: block; }

  /* ì• ë‹ˆë©”ì´ì…˜ ì»¨íŠ¸ë¡¤ 2í–‰ */
  .anim-controls {
    flex-direction: column !important;
    gap: 8px !important;
  }
  .anim-controls .anim-row1 {
    display: flex; gap: 8px; align-items: center; width: 100%;
  }
  .anim-controls .anim-row2 {
    width: 100%;
  }
  .anim-controls .anim-speed { display: none; }

  /* ê¸°ê°„ë¹„êµ ì„¸ë¡œ ìŠ¤íƒ */
  .cmp-periods {
    flex-direction: column !important;
  }
  .cmp-periods input[type=date] {
    width: 100% !important;
    display: block !important;
    margin-bottom: 6px;
  }

  /* ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ */
  .export-bar { flex-direction: column; }
  .export-bar button { width: 100% !important; min-width: unset !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì´ˆì†Œí˜• ëª¨ë°”ì¼ (480px ì´í•˜)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 480px) {
  .kpi-card .value { font-size: 17px; }
  .main { padding: 56px 6px 80px 6px; }
  .sidebar { padding: 56px 12px 20px 12px; }
  .tabs-mobile-grid { grid-template-columns: repeat(2, 1fr); gap: 4px; }
  .tabs-mobile-grid .tab-m-btn { font-size: 11px; padding: 8px 4px; }
  .week-compare-grid .kpi-card .value { font-size: 12px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PC ëŒ€í˜• í™”ë©´ (1200px ì´ìƒ)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 1200px) {
  .main { padding: 28px 40px; }
  .kpi-grid { grid-template-columns: repeat(3, 1fr); gap: 16px; }
  .kpi-card .value { font-size: 32px; }
  .chart-box { padding: 20px; margin-bottom: 24px; }
  .chart-box h3 { font-size: 16px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ì´ˆëŒ€í˜• í™”ë©´ (1600px ì´ìƒ)
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 1600px) {
  .main { padding: 32px 60px; max-width: 1500px; }
  .kpi-card .value { font-size: 36px; }
}

/* â”€â”€ ë‹¤í¬ ëª¨ë“œ â”€â”€ */
.dark-toggle {
  position: fixed; top: 12px; right: 12px; z-index: 1100;
  width: 44px; height: 44px; border: none; border-radius: 10px;
  background: var(--card); color: var(--text); font-size: 20px;
  cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,.15);
  border: 1px solid var(--border);
}

body.dark {
  --primary: #60A5FA; --danger: #F87171; --success: #4ADE80;
  --warning: #FBBF24; --gray: #9CA3AF; --bg: #111827;
  --card: #1F2937; --border: #374151; --text: #F9FAFB; --text-light: #9CA3AF;
}
body.dark .header-logo { filter: none !important; }
body.dark .file-drop { border-color: #4B5563; }
body.dark .file-drop:hover { background: #1E3A5F; border-color: var(--primary); }
body.dark select, body.dark input[type=date], body.dark input[type=text] {
  background: #374151; color: #F9FAFB; border-color: #4B5563;
}
body.dark table.data-tbl th { background: #1E40AF; }
body.dark table.data-tbl tr:hover td { background: #1E3A5F; }
body.dark .info-box.info { background: #1E3A5F; color: #93C5FD; }
body.dark .info-box.success { background: #064E3B; color: #6EE7B7; }
body.dark .info-box.warn { background: #78350F; color: #FCD34D; }

/* â”€â”€ ë‹¤ì¤‘íŒŒì¼ í‘œì‹œ â”€â”€ */
.file-list { font-size: 12px; margin-top: 6px; }
.file-list .file-tag {
  display: inline-block; padding: 3px 8px; margin: 2px;
  background: #DBEAFE; color: #1E40AF; border-radius: 6px; font-size: 11px;
}
body.dark .file-list .file-tag { background: #1E3A5F; color: #93C5FD; }

/* â”€â”€ ì „ì²´ ìš”ì•½ (Tab1) ê°œì„  â”€â”€ */
.t1-status-banner {
  display: flex; align-items: center; gap: 16px;
  padding: 16px 20px; border-radius: 12px; margin-bottom: 16px;
  font-weight: 700; font-size: 16px; box-shadow: 0 2px 8px rgba(0,0,0,.06);
}
.t1-status-banner.safe { background: #D1FAE5; color: #065F46; border: 1px solid #6EE7B7; }
.t1-status-banner.warn { background: #FEF3C7; color: #92400E; border: 1px solid #FCD34D; }
.t1-status-banner.danger { background: #FEE2E2; color: #991B1B; border: 1px solid #FCA5A5; }
body.dark .t1-status-banner.safe { background: #064E3B; color: #A7F3D0; border-color: #34D399; }
body.dark .t1-status-banner.warn { background: #78350F; color: #FDE68A; border-color: #F59E0B; }
body.dark .t1-status-banner.danger { background: #7F1D1D; color: #FCA5A5; border-color: #F87171; }
.t1-status-banner .t1-sb-score { font-size: 28px; font-weight: 900; }
.t1-status-banner .t1-sb-text { flex: 1; }
.t1-status-banner .t1-sb-sub { font-size: 12px; font-weight: 400; opacity: .8; margin-top: 2px; }

.t1-top5-bar { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.t1-top5-bar:last-child { border-bottom: none; }
.t1-top5-rank { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 800; color: #fff; flex-shrink: 0; }
.t1-top5-name { flex: 1; font-size: 13px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; }
.t1-top5-rate { font-size: 13px; font-weight: 800; min-width: 55px; text-align: right; }
.t1-top5-barwrap { width: 100px; height: 10px; background: var(--border); border-radius: 5px; overflow: hidden; flex-shrink: 0; }
.t1-top5-fill { height: 100%; border-radius: 5px; }

.t1-chart-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px; }

.t1-mini-scroll { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px; -webkit-overflow-scrolling: touch; }
.t1-mini-card { flex-shrink: 0; width: 130px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px; text-align: center; }
.t1-mini-card .t1-mc-date { font-size: 11px; color: var(--text-light); margin-bottom: 4px; }
.t1-mini-card .t1-mc-rate { font-size: 20px; font-weight: 800; }
.t1-mini-card .t1-mc-detail { font-size: 10px; color: var(--text-light); margin-top: 4px; }
.t1-mini-card .t1-mc-change { font-size: 11px; font-weight: 700; margin-top: 2px; }
.t1-mini-card .t1-mc-bar { height: 4px; border-radius: 2px; margin-top: 6px; }

.t1-insight-box {
  background: linear-gradient(135deg, #EFF6FF 0%, #F5F3FF 100%);
  border: 1px solid var(--border); border-radius: 12px;
  padding: 16px 20px; line-height: 1.7; font-size: 14px;
}
body.dark .t1-insight-box { background: linear-gradient(135deg, #1E293B 0%, #1E1B4B 100%); }
.t1-insight-box .t1-ins-item { padding: 3px 0; }
.t1-insight-box .t1-ins-item::before { content: 'ğŸ’¡ '; }

@media (max-width: 768px) {
  .t1-chart-row { grid-template-columns: 1fr; }
  .t1-top5-barwrap { width: 60px; }
  .t1-mini-card { width: 110px; }
  .t1-mini-card .t1-mc-rate { font-size: 16px; }
  .t1-status-banner { flex-wrap: wrap; font-size: 14px; }
  .t1-status-banner .t1-sb-score { font-size: 22px; }
}

/* â”€â”€ AI í’ˆì§ˆì§„ë‹¨ (Tab9) â”€â”€ */
.ai-risk-badge {
  display: inline-flex; align-items: center; gap: 10px;
  padding: 16px 28px; border-radius: 16px; font-size: 22px; font-weight: 800;
  margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,.1);
}
.ai-risk-badge.safe   { background: #D1FAE5; color: #065F46; border: 2px solid #16A34A; }
.ai-risk-badge.warn   { background: #FEF3C7; color: #92400E; border: 2px solid #F59E0B; }
.ai-risk-badge.danger { background: #FEE2E2; color: #991B1B; border: 2px solid #DC2626; }
body.dark .ai-risk-badge.safe   { background: #064E3B; color: #6EE7B7; border-color: #4ADE80; }
body.dark .ai-risk-badge.warn   { background: #78350F; color: #FCD34D; border-color: #FBBF24; }
body.dark .ai-risk-badge.danger { background: #7F1D1D; color: #FCA5A5; border-color: #F87171; }

.ai-kpi-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; margin-bottom: 20px; }
.ai-kpi-card {
  background: var(--card); border-radius: 12px; padding: 16px 12px; text-align: center;
  border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,.06);
}
.ai-kpi-card .ai-kpi-val { font-size: 26px; font-weight: 800; }
.ai-kpi-card .ai-kpi-sub { font-size: 11px; color: var(--text-light); margin-top: 2px; }
.ai-kpi-card .ai-kpi-lbl { font-size: 12px; color: var(--text-light); margin-top: 4px; }

.ai-diagnosis-box {
  background: var(--card); border-radius: 12px; border: 1px solid var(--border);
  padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.06);
}
.ai-diagnosis-box h3 { font-size: 15px; margin-bottom: 14px; }
.ai-diagnosis-section { margin-bottom: 16px; line-height: 1.8; font-size: 14px; padding: 12px 14px; border-radius: 8px; background: var(--bg); }
.ai-diagnosis-section .ai-ds-title { font-weight: 700; color: var(--primary); font-size: 13px; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
.ai-diagnosis-section .ai-ds-body { color: var(--text); }
.ai-diagnosis-section .ai-ds-detail { font-size: 12px; color: var(--text-light); margin-top: 4px; line-height: 1.6; }
.ai-diagnosis-section.ai-ds-danger { border-left: 4px solid #DC2626; }
.ai-diagnosis-section.ai-ds-warn { border-left: 4px solid #F59E0B; }
.ai-diagnosis-section.ai-ds-safe { border-left: 4px solid #16A34A; }
.ai-diagnosis-section.ai-ds-info { border-left: 4px solid #2563EB; }

.ai-stat-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; margin-bottom: 20px; }
.ai-stat-card {
  background: var(--card); border-radius: 10px; padding: 14px 10px; text-align: center;
  border: 1px solid var(--border);
}
.ai-stat-card .ai-st-val { font-size: 20px; font-weight: 800; }
.ai-stat-card .ai-st-lbl { font-size: 11px; color: var(--text-light); margin-top: 3px; }
.ai-stat-card .ai-st-sub { font-size: 10px; color: var(--text-light); margin-top: 2px; }

.ai-warning-card {
  background: var(--card); border-radius: 12px; border-left: 5px solid;
  padding: 14px 16px; margin-bottom: 10px; display: flex; align-items: center; gap: 14px;
  box-shadow: 0 1px 3px rgba(0,0,0,.06);
}
.ai-warning-card.danger { border-left-color: #DC2626; }
.ai-warning-card.warn   { border-left-color: #F59E0B; }
.ai-warning-card .ai-wc-info { flex: 1; }
.ai-warning-card .ai-wc-title { font-weight: 700; font-size: 14px; margin-bottom: 4px; }
.ai-warning-card .ai-wc-desc  { font-size: 12px; color: var(--text-light); line-height: 1.5; }
.ai-warning-card .ai-wc-score { font-size: 11px; font-weight: 700; margin-top: 4px; }
.ai-warning-card .ai-wc-spark { width: 100px; height: 32px; flex-shrink: 0; }

.ai-item-detail { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 16px; margin-bottom: 20px; }
.ai-item-detail h3 { font-size: 15px; margin-bottom: 12px; }
.ai-item-row { display: flex; gap: 8px; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
.ai-item-row:last-child { border-bottom: none; }
.ai-item-rank { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 12px; color: #fff; flex-shrink: 0; }
.ai-item-name-wrap { flex: 1; min-width: 0; }
.ai-item-name { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ai-item-meta { font-size: 11px; color: var(--text-light); margin-top: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.ai-item-tags { display: flex; gap: 4px; margin-top: 4px; }
.ai-item-tag {
  display: inline-block; padding: 1px 6px; border-radius: 999px; font-size: 10px; font-weight: 700;
  background: var(--bg); color: var(--text-light); border: 1px solid var(--border);
}
.ai-item-tag.danger { background: #FEE2E2; color: #991B1B; border-color: #FECACA; }
.ai-item-tag.warn { background: #FEF3C7; color: #92400E; border-color: #FDE68A; }
.ai-item-tag.info { background: #DBEAFE; color: #1E40AF; border-color: #BFDBFE; }
.ai-item-bars { display: flex; gap: 4px; align-items: center; flex-shrink: 0; }
.ai-item-bar { height: 8px; border-radius: 4px; }
.ai-item-score { min-width: 45px; text-align: right; font-weight: 700; font-size: 12px; flex-shrink: 0; }

.ai-timeline {
  background: var(--card); border-radius: 12px; border: 1px solid var(--border);
  padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,.06);
}
.ai-timeline h3 { font-size: 15px; margin-bottom: 14px; }
.ai-tl-item {
  display: flex; gap: 12px; padding: 8px 0; border-bottom: 1px solid var(--border);
  font-size: 13px; align-items: flex-start;
}
.ai-tl-item:last-child { border-bottom: none; }
.ai-tl-date { min-width: 60px; color: var(--text-light); font-weight: 600; flex-shrink: 0; }
.ai-tl-badge {
  display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 700;
  flex-shrink: 0;
}
.ai-tl-badge.danger { background: #FEE2E2; color: #991B1B; }
.ai-tl-badge.warn   { background: #FEF3C7; color: #92400E; }
body.dark .ai-tl-badge.danger { background: #7F1D1D; color: #FCA5A5; }
body.dark .ai-tl-badge.warn   { background: #78350F; color: #FCD34D; }
.ai-tl-text { flex: 1; }

.ai-defect-summary { display: grid; grid-template-columns: repeat(2,1fr); gap: 10px; margin-bottom: 20px; }
.ai-defect-card {
  background: var(--card); border-radius: 10px; padding: 12px; border: 1px solid var(--border);
}
.ai-defect-card .ai-dc-name { font-weight: 700; font-size: 13px; margin-bottom: 4px; }
.ai-defect-card .ai-dc-val { font-size: 11px; color: var(--text-light); }
.ai-defect-card .ai-dc-bar { height: 6px; border-radius: 3px; background: var(--border); margin-top: 6px; overflow: hidden; }
.ai-defect-card .ai-dc-fill { height: 100%; border-radius: 3px; }

@media (max-width: 768px) {
  .ai-risk-badge { font-size: 17px; padding: 12px 18px; }
  .ai-kpi-grid { grid-template-columns: repeat(2,1fr); gap: 8px; }
  .ai-kpi-card .ai-kpi-val { font-size: 20px; }
  .ai-stat-grid { grid-template-columns: repeat(2,1fr); gap: 8px; }
  .ai-stat-card .ai-st-val { font-size: 16px; }
  .ai-warning-card { flex-wrap: wrap; }
  .ai-warning-card .ai-wc-spark { width: 80px; }
  .ai-defect-summary { grid-template-columns: 1fr; }
  .ai-item-row { font-size: 12px; }
}

/* â”€â”€ ì¢…í•© í’ˆì§ˆ ì ìˆ˜ ê²Œì´ì§€ â”€â”€ */
.ai-gauge-section {
  display: flex; align-items: center; gap: 24px;
  background: var(--card); border-radius: 16px; border: 1px solid var(--border);
  padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 12px rgba(0,0,0,.08);
}
.ai-gauge-wrap { flex-shrink: 0; width: 200px; text-align: center; }
.ai-gauge-wrap svg text { fill: var(--text); }
.ai-gauge-verdict { flex: 1; }
.ai-gauge-grade { font-size: 28px; font-weight: 900; margin-bottom: 8px; }
.ai-gauge-text { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 6px; line-height: 1.5; }
.ai-gauge-sub { font-size: 12px; color: var(--text-light); }

/* â”€â”€ í•œëˆˆì— ë³´ëŠ” ìš”ì•½ â”€â”€ */
.ai-summary-box {
  background: linear-gradient(135deg, #EFF6FF 0%, #F0FDF4 100%);
  border: 1px solid var(--border); border-radius: 16px;
  padding: 20px; margin-bottom: 20px;
}
body.dark .ai-summary-box { background: linear-gradient(135deg, #1E293B 0%, #1A2E1A 100%); }
.ai-summary-hero { display: flex; align-items: center; gap: 14px; margin-bottom: 16px; }
.ai-summary-icon { font-size: 40px; }
.ai-summary-main { font-size: 18px; line-height: 1.5; }
.ai-summary-stats { display: grid; grid-template-columns: repeat(4,1fr); gap: 12px; }
.ai-ss-item { text-align: center; background: var(--card); border-radius: 10px; padding: 12px 8px; border: 1px solid var(--border); }
.ai-ss-label { font-size: 11px; color: var(--text-light); display: block; margin-bottom: 4px; }
.ai-ss-val { font-size: 18px; font-weight: 800; display: block; }
.ai-ss-sub { font-size: 10px; color: var(--text-light); display: block; margin-top: 2px; }

/* â”€â”€ í’ˆì§ˆ ê±´ê°• ì²´í¬ë¦¬ìŠ¤íŠ¸ â”€â”€ */
.ai-checklist-box {
  background: var(--card); border-radius: 12px; border: 1px solid var(--border);
  padding: 20px; margin-bottom: 20px;
}
.ai-checklist-box h3 { font-size: 15px; margin-bottom: 14px; }
.ai-checklist { display: flex; flex-direction: column; gap: 8px; }
.ai-check-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px; border-radius: 10px;
  border: 1px solid var(--border); transition: background .15s;
}
.ai-check-item.pass { background: #F0FDF4; border-color: #BBF7D0; }
.ai-check-item.fail { background: #FEF2F2; border-color: #FECACA; }
body.dark .ai-check-item.pass { background: rgba(20,83,45,.2); border-color: rgba(74,222,128,.3); }
body.dark .ai-check-item.fail { background: rgba(127,29,29,.2); border-color: rgba(248,113,113,.3); }
.ai-check-icon { font-size: 20px; flex-shrink: 0; }
.ai-check-content { flex: 1; }
.ai-check-label { font-size: 14px; font-weight: 700; margin-bottom: 2px; }
.ai-check-detail { font-size: 12px; color: var(--text-light); line-height: 1.4; }
.ai-check-badge { font-size: 11px; color: var(--text-light); text-align: right; min-width: 120px; flex-shrink: 0; }

/* â”€â”€ ê°„ì†Œí™” í†µê³„ ì¹´ë“œ â”€â”€ */
.ai-simple-stat-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 12px; margin-bottom: 20px; }
.ai-simple-stat-card {
  background: var(--card); border-radius: 12px; border: 1px solid var(--border);
  padding: 18px 12px; text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,.06);
}
.ai-ssc-icon { font-size: 24px; margin-bottom: 6px; }
.ai-ssc-val { font-size: 26px; font-weight: 800; display: block; }
.ai-ssc-lbl { font-size: 12px; color: var(--text-light); margin-top: 2px; }
.ai-ssc-tip { font-size: 11px; color: var(--text-light); margin-top: 4px; padding: 3px 6px; background: var(--bg); border-radius: 6px; display: inline-block; }

/* â”€â”€ ìƒì„¸ ë¶„ì„ í† ê¸€ â”€â”€ */
.ai-expand-toggle {
  display: flex; align-items: center; justify-content: center; gap: 10px;
  background: var(--card); border: 2px dashed var(--border); border-radius: 10px;
  padding: 14px 20px; margin-bottom: 16px; cursor: pointer;
  font-weight: 700; font-size: 14px; transition: all .15s;
  -webkit-tap-highlight-color: transparent; user-select: none;
}
.ai-expand-toggle:hover { background: var(--bg); border-color: var(--primary); color: var(--primary); }
.ai-expand-hint { font-size: 12px; color: var(--text-light); font-weight: 400; }

@media (max-width: 768px) {
  .ai-gauge-section { flex-direction: column; gap: 12px; padding: 16px; text-align: center; }
  .ai-gauge-wrap { width: 160px; }
  .ai-gauge-grade { font-size: 22px; }
  .ai-gauge-text { font-size: 14px; }
  .ai-summary-stats { grid-template-columns: repeat(2,1fr); gap: 6px; }
  .ai-summary-main { font-size: 15px; }
  .ai-ss-val { font-size: 15px; }
  .ai-simple-stat-grid { grid-template-columns: repeat(3,1fr); gap: 8px; }
  .ai-ssc-val { font-size: 20px; }
  .ai-check-badge { display: none; }
}

/* â”€â”€ TAB2: ìš”ì¼ë³„ ë¶ˆëŸ‰ë¥  íŒ¨í„´ â”€â”€ */
.weekday-chart-box { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
@media (max-width: 768px) { .weekday-chart-box { grid-template-columns: 1fr; } }

/* â”€â”€ TAB3: í’ˆëª© ì¶”ì„¸ ë°°ì§€ â”€â”€ */
.trend-badge { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; font-weight:700; margin-left:6px; vertical-align:middle; }
.trend-badge.up { background:#FEE2E2; color:#DC2626; }
.trend-badge.down { background:#D1FAE5; color:#16A34A; }
.trend-badge.stable { background:#F3F4F6; color:#6B7280; }
body.dark .trend-badge.up { background:#7F1D1D; color:#FCA5A5; }
body.dark .trend-badge.down { background:#064E3B; color:#6EE7B7; }
body.dark .trend-badge.stable { background:#374151; color:#9CA3AF; }

/* â”€â”€ TAB6: ìˆ˜ìœ¨ ëª©í‘œ/ë¶„í¬ â”€â”€ */
.yield-target-summary { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:16px; }
.yield-target-card { background:var(--white); border:1px solid var(--border); border-radius:12px; padding:16px; text-align:center; }
body.dark .yield-target-card { background:var(--card-dark); }
.yield-target-card .ytc-label { font-size:12px; color:var(--text-light); margin-bottom:4px; }
.yield-target-card .ytc-value { font-size:28px; font-weight:800; }
.yield-target-card .ytc-sub { font-size:11px; color:var(--text-light); margin-top:4px; }
.yield-target-card.pass .ytc-value { color:#16A34A; }
.yield-target-card.fail .ytc-value { color:#DC2626; }
.yield-target-card.total .ytc-value { color:#2563EB; }
@media (max-width: 768px) { .yield-target-summary { grid-template-columns: 1fr; } }

/* â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€ */
.loading-overlay { position:fixed; inset:0; background:rgba(255,255,255,0.85); z-index:99999; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; }
body.dark .loading-overlay { background:rgba(15,23,42,0.9); }
.loading-spinner { width:48px; height:48px; border:4px solid var(--border); border-top-color:var(--primary); border-radius:50%; animation:spin 0.8s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }
.loading-text { font-size:15px; font-weight:600; color:var(--text); }

/* â”€â”€ í† ìŠ¤íŠ¸ ì•Œë¦¼ â”€â”€ */
.toast-container { position:fixed; top:20px; right:20px; z-index:100000; display:flex; flex-direction:column; gap:8px; pointer-events:none; }
.toast { pointer-events:auto; padding:12px 20px; border-radius:10px; font-size:13px; font-weight:500; color:#fff; box-shadow:0 4px 12px rgba(0,0,0,0.15); opacity:0; transform:translateX(60px); transition:all 0.3s ease; max-width:360px; line-height:1.4; }
.toast.show { opacity:1; transform:translateX(0); }
.toast.error { background:#DC2626; }
.toast.success { background:#16A34A; }
.toast.warn { background:#F59E0B; color:#1F2937; }
.toast.info { background:#2563EB; }
@media (max-width: 768px) { .toast-container { top:10px; right:10px; left:10px; } .toast { max-width:100%; } }

/* â”€â”€ í•„í„° ë°ì´í„° ë²”ìœ„ ë¼ë²¨ â”€â”€ */
.filter-range-label { font-size:11px; color:var(--text-light); margin-top:2px; margin-bottom:6px; }

/* â”€â”€ ì •ë ¬ í‘œì‹œ â”€â”€ */
th[data-sort="asc"] { background:rgba(37,99,235,0.08); }
th[data-sort="desc"] { background:rgba(37,99,235,0.08); }
body.dark th[data-sort="asc"], body.dark th[data-sort="desc"] { background:rgba(96,165,250,0.12); }

/* â”€â”€ í’ˆëª© í•„í„° ë²„íŠ¼ â”€â”€ */
.item-filter-actions { display:flex; gap:6px; margin-bottom:4px; }
.item-filter-actions button { flex:1; padding:6px; font-size:11px; border:1px solid var(--border); border-radius:6px; background:var(--white); cursor:pointer; font-weight:600; color:var(--text); }
.item-filter-actions button:hover { background:var(--primary); color:#fff; }
body.dark .item-filter-actions button { background:var(--card-dark); border-color:#475569; }
</style>
</head>
<body>
<div class="toast-container" id="toastContainer"></div>

<!-- í–„ë²„ê±° í† ê¸€ -->
<button class="menu-toggle" id="menuToggle" aria-label="ë©”ë‰´ ì—´ê¸°">&#9776;</button>
<!-- ë‹¤í¬ëª¨ë“œ í† ê¸€ -->
<button class="dark-toggle" id="darkToggle" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜">&#9790;</button>

<!-- ì˜¤ë²„ë ˆì´ -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<!-- ===== ì‚¬ì´ë“œë°” ===== -->
<aside class="sidebar" id="sidebar">
  <h2>ë‚¨ë„ê¸ˆí˜• ìŠ¤ë§ˆíŠ¸ í’ˆì§ˆ</h2>

  <div>
    <label>ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</label>
    <div class="file-drop" id="fileDrop">
      <div style="font-size:28px;margin-bottom:6px;">&#128194;</div>
      íƒ­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ
      <input type="file" id="fileInput" accept=".xlsx,.xls" multiple>
    </div>
  </div>

  <div id="sheetArea" style="display:none">
    <label>ì‹œíŠ¸ ì„ íƒ</label>
    <select id="sheetSelect"></select>
  </div>

  <div id="mappingArea" style="display:none">
    <h3>ì»¬ëŸ¼ ë§¤í•‘</h3>
    <div id="mappingStatus"></div>
    <div id="mappingFields"></div>
  </div>

  <div id="analyzeArea">
    <button class="btn btn-primary" id="btnAnalyze">ë¶„ì„ ì‹œì‘</button>
  </div>

  <div id="filterArea">
    <hr class="section-divider">
    <h3>í•„í„°</h3>
    <label>ì‹œì‘ì¼</label>
    <input type="date" id="filterStart">
    <label style="margin-top:8px">ì¢…ë£Œì¼</label>
    <input type="date" id="filterEnd">
    <div class="filter-range-label" id="filterDateRange">ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ë²”ìœ„ê°€ í‘œì‹œë©ë‹ˆë‹¤</div>

    <label style="margin-top:10px">í’ˆëª© ì„ íƒ</label>
    <div id="itemFilterWrap"></div>

    <label style="margin-top:10px">ë¶ˆëŸ‰ë¥  ì„ê³„ì¹˜</label>
    <div class="slider-wrap">
      <input type="range" id="filterThreshold" min="0" max="30" step="0.1" value="5">
      <input type="number" class="val-input" id="thresholdInput" min="0" max="30" step="0.1" value="5.0">
      <span style="font-weight:700;color:var(--danger);font-size:14px">%</span>
    </div>

    <label style="margin-top:10px">ğŸ¯ ëª©í‘œ ë¶ˆëŸ‰ë¥ </label>
    <div class="slider-wrap">
      <input type="range" id="targetDefectRate" min="0.1" max="5" step="0.1" value="0.8">
      <input type="number" class="val-input" id="targetDefectInput" min="0.1" max="5" step="0.1" value="0.8">
      <span style="font-weight:700;color:var(--danger);font-size:14px">%</span>
    </div>
    <button class="btn btn-primary" id="btnApplyFilter" style="margin-top:12px">í•„í„° ì ìš©</button>
  </div>
</aside>

<!-- ===== ë©”ì¸ ===== -->
<div class="main" id="mainArea">
  <div class="header-bar">
    <div style="display:flex;align-items:center;gap:14px">
      <img src="logo-color.png" alt="ë‚¨ë„ê¸ˆí˜•" style="height:48px" class="header-logo">
      <h1 style="margin-bottom:0">ë‚¨ë„ê¸ˆí˜• ìŠ¤ë§ˆíŠ¸ í’ˆì§ˆ ëª¨ë‹ˆí„°ë§</h1>
    </div>
    <div class="header-info">
      <div class="header-author">í’ˆì§ˆë¶„ì„ ë‹´ë‹¹ ê¹€ì¤€í¬ ì°¨ì¥</div>
      <div id="lastAnalysisDate"></div>
    </div>
  </div>

  <div id="placeholder" class="placeholder" onclick="if(window.innerWidth<=768){openSidebar();}">
    <div class="icon">&#128202;</div>
    <span class="placeholder-pc">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</span>
    <span class="placeholder-mobile">ì—¬ê¸°ë¥¼ íƒ­í•˜ì—¬ ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.<br><small style="color:var(--primary);font-weight:600;margin-top:8px;display:inline-block;">ë˜ëŠ” ì¢Œì¸¡ ìƒë‹¨ â˜° ë©”ë‰´ë¥¼ íƒ­í•˜ì„¸ìš”</small></span>
  </div>

  <div id="dashboard" style="display:none">
    <!-- PC íƒ­ë°” -->
    <div class="tabs" id="tabsBar">
      <button class="tab-btn active" data-tab="tab1">ì „ì²´ ìš”ì•½</button>
      <button class="tab-btn" data-tab="tab2">ì¼ìë³„ ë¶„ì„</button>
      <button class="tab-btn" data-tab="tab3">í’ˆëª©ë³„ ë¶„ì„</button>
      <button class="tab-btn" data-tab="tab4">ì•Œë¦¼ & ë¦¬í¬íŠ¸</button>
      <button class="tab-btn" data-tab="tab5">SPC ê´€ë¦¬ë„</button>
      <button class="tab-btn" data-tab="tab6">ìˆ˜ìœ¨ ë¶„ì„</button>
      <button class="tab-btn" data-tab="tab7">ê¸°ê°„ ë¹„êµ</button>
      <button class="tab-btn" data-tab="tab8">í’ˆëª© ì‹¬ì¸µë¶„ì„</button>
      <button class="tab-btn" data-tab="tab9">AI í’ˆì§ˆì§„ë‹¨</button>
    </div>
    <!-- ëª¨ë°”ì¼ íƒ­ ê·¸ë¦¬ë“œ -->
    <div class="tabs-mobile-grid" id="tabsMobile">
      <button class="tab-m-btn active" data-tab="tab1">ğŸ“Š ì „ì²´ ìš”ì•½</button>
      <button class="tab-m-btn" data-tab="tab2">ğŸ“… ì¼ìë³„</button>
      <button class="tab-m-btn" data-tab="tab3">ğŸ“¦ í’ˆëª©ë³„</button>
      <button class="tab-m-btn" data-tab="tab4">ğŸ”” ì•Œë¦¼</button>
      <button class="tab-m-btn" data-tab="tab5">ğŸ“ˆ SPC</button>
      <button class="tab-m-btn" data-tab="tab6">âœ… ìˆ˜ìœ¨</button>
      <button class="tab-m-btn" data-tab="tab7">ğŸ”„ ê¸°ê°„ë¹„êµ</button>
      <button class="tab-m-btn" data-tab="tab8">ğŸ” ì‹¬ì¸µë¶„ì„</button>
      <button class="tab-m-btn" data-tab="tab9">ğŸ¤– AIì§„ë‹¨</button>
    </div>

    <div id="tab1" class="tab-content active"></div>
    <div id="tab2" class="tab-content"></div>
    <div id="tab3" class="tab-content"></div>
    <div id="tab4" class="tab-content"></div>
    <div id="tab5" class="tab-content"></div>
    <div id="tab6" class="tab-content"></div>
    <div id="tab7" class="tab-content"></div>
    <div id="tab8" class="tab-content"></div>
    <div id="tab9" class="tab-content"></div>
  </div>
</div>

<!-- ëª¨ë°”ì¼ ë¶„ì„ì‹œì‘ í”Œë¡œíŒ… ë²„íŠ¼ -->
<button class="mobile-analyze-fab" id="mobileAnalyzeFab" onclick="document.getElementById('btnAnalyze').click(); this.classList.remove('show');">
  â–¶ ë¶„ì„ ì‹œì‘
</button>

<!-- í•˜ë‹¨ ê³ ì • ì•¡ì…˜ë°” (ëª¨ë°”ì¼) -->
<div class="bottom-bar" id="bottomBar">
  <button onclick="openSidebar()"><span class="bar-icon">âš™</span>í•„í„°</button>
  <button onclick="document.getElementById('btnExportExcel')&&document.getElementById('btnExportExcel').click()"><span class="bar-icon">ğŸ“¥</span>Excel</button>
  <button onclick="document.getElementById('btnExportPDF')&&document.getElementById('btnExportPDF').click()"><span class="bar-icon">ğŸ“„</span>PDF</button>
  <button onclick="window.scrollTo({top:0,behavior:'smooth'})"><span class="bar-icon">â†‘</span>ìƒë‹¨</button>
</div>

<!-- ë“œë¦´ë‹¤ìš´ ëª¨ë‹¬ (ëª¨ë°”ì¼) -->
<div class="drill-modal" id="drillModal">
  <button class="drill-modal-close" id="drillModalClose">âœ•</button>
  <div id="drillModalContent"></div>
</div>

<script>
/* ================================================================
   ì „ì—­ ìƒíƒœ
   ================================================================ */
let workbook = null;
let rawData = [];
let columns = [];
let mapping = null;
let cleanedData = [];
let defectCols = [];
let selectedFilterItems = new Set();
let uploadedFiles = []; // ë‹¤ì¤‘ íŒŒì¼ ê´€ë¦¬

const isMobile = () => window.innerWidth <= 768;

/* ================================================================
   ìœ í‹¸
   ================================================================ */
const $ = id => document.getElementById(id);
const fmt = n => Number(n).toLocaleString('ko-KR');
const pct = (n, d=2) => Number(n).toFixed(d) + '%';

const TARGET_DEFECT_RATE_KEY = 'ndm_targetDefectRate';
const DEFAULT_TARGET_DEFECT_RATE = 0.8;
function loadTargetDefectRate() {
  try { const v = localStorage.getItem(TARGET_DEFECT_RATE_KEY); return v !== null ? Number(v) : DEFAULT_TARGET_DEFECT_RATE; } catch(e) { return DEFAULT_TARGET_DEFECT_RATE; }
}
function saveTargetDefectRate(val) {
  try { localStorage.setItem(TARGET_DEFECT_RATE_KEY, val); } catch(e) {}
}
let targetDefectRate = loadTargetDefectRate();

const AI_RISK_SETTINGS_KEY = 'ndm_aiRiskSettings';
const AI_RISK_HISTORY_KEY = 'ndm_aiRiskSettingsHistory';
const DEFAULT_AI_RISK_SETTINGS = Object.freeze({
  dangerRatePct: 10,
  warnRatePct: 5,
  watchRatePct: 3,
  dangerScoreFloor: 70,
  warnScoreFloor: 45,
  gradeDangerCut: 70,
  gradeWarnCut: 40,
  volMinSamples: 5
});

// â”€â”€ ë¡œë”© ì˜¤ë²„ë ˆì´ â”€â”€
function showLoading(msg) {
  let el = document.getElementById('loadingOverlay');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loadingOverlay';
    el.className = 'loading-overlay';
    document.body.appendChild(el);
  }
  el.innerHTML = `<div class="loading-spinner"></div><div class="loading-text">${msg || 'ë¶„ì„ ì¤‘...'}</div>`;
  el.style.display = 'flex';
}
function hideLoading() {
  const el = document.getElementById('loadingOverlay');
  if (el) el.style.display = 'none';
}

// â”€â”€ í† ìŠ¤íŠ¸ ì•Œë¦¼ â”€â”€
function showToast(message, type, duration) {
  type = type || 'info';
  duration = duration || 4000;
  const container = $('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast ' + type;
  toast.textContent = message;
  container.appendChild(toast);
  requestAnimationFrame(() => toast.classList.add('show'));
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

function sanitizeAiRiskSettings(raw) {
  const n = (v, d) => {
    const x = Number(v);
    return Number.isFinite(x) ? x : d;
  };
  const next = {
    dangerRatePct: Math.max(0.1, n(raw?.dangerRatePct, DEFAULT_AI_RISK_SETTINGS.dangerRatePct)),
    warnRatePct: Math.max(0, n(raw?.warnRatePct, DEFAULT_AI_RISK_SETTINGS.warnRatePct)),
    watchRatePct: Math.max(0, n(raw?.watchRatePct, DEFAULT_AI_RISK_SETTINGS.watchRatePct)),
    dangerScoreFloor: Math.min(100, Math.max(0, n(raw?.dangerScoreFloor, DEFAULT_AI_RISK_SETTINGS.dangerScoreFloor))),
    warnScoreFloor: Math.min(100, Math.max(0, n(raw?.warnScoreFloor, DEFAULT_AI_RISK_SETTINGS.warnScoreFloor))),
    gradeDangerCut: Math.min(100, Math.max(0, n(raw?.gradeDangerCut, DEFAULT_AI_RISK_SETTINGS.gradeDangerCut))),
    gradeWarnCut: Math.min(100, Math.max(0, n(raw?.gradeWarnCut, DEFAULT_AI_RISK_SETTINGS.gradeWarnCut))),
    volMinSamples: Math.max(3, Math.round(n(raw?.volMinSamples, DEFAULT_AI_RISK_SETTINGS.volMinSamples)))
  };
  if (next.warnRatePct > next.dangerRatePct) next.warnRatePct = next.dangerRatePct;
  if (next.watchRatePct > next.warnRatePct) next.watchRatePct = next.warnRatePct;
  if (next.warnScoreFloor > next.dangerScoreFloor) next.warnScoreFloor = next.dangerScoreFloor;
  if (next.gradeWarnCut > next.gradeDangerCut) next.gradeWarnCut = next.gradeDangerCut;
  return next;
}

function loadAiRiskSettings() {
  try {
    const saved = localStorage.getItem(AI_RISK_SETTINGS_KEY);
    if (!saved) return sanitizeAiRiskSettings(DEFAULT_AI_RISK_SETTINGS);
    return sanitizeAiRiskSettings(JSON.parse(saved));
  } catch (e) {
    return sanitizeAiRiskSettings(DEFAULT_AI_RISK_SETTINGS);
  }
}

function appendAiRiskSettingsHistory(settings) {
  try {
    const prev = JSON.parse(localStorage.getItem(AI_RISK_HISTORY_KEY) || '[]');
    const next = [{ at: new Date().toISOString(), settings }, ...prev].slice(0, 20);
    localStorage.setItem(AI_RISK_HISTORY_KEY, JSON.stringify(next));
  } catch (e) {}
}

function getAiRiskSettingsLastChangedLabel() {
  try {
    const hist = JSON.parse(localStorage.getItem(AI_RISK_HISTORY_KEY) || '[]');
    if (!hist.length || !hist[0].at) return 'default';
    const d = new Date(hist[0].at);
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
  } catch (e) {
    return 'default';
  }
}

function saveAiRiskSettings(settings) {
  aiRiskSettings = sanitizeAiRiskSettings(settings);
  try { localStorage.setItem(AI_RISK_SETTINGS_KEY, JSON.stringify(aiRiskSettings)); } catch (e) {}
  appendAiRiskSettingsHistory(aiRiskSettings);
}

function getRiskRuleLabel(forcedRule) {
  if (forcedRule === 'danger_rate_gate') return 'AbsRate Danger Gate';
  if (forcedRule === 'warn_rate_gate') return 'AbsRate Warn Gate';
  return 'Base Score';
}

let aiRiskSettings = loadAiRiskSettings();
let aiRenderContext = null;

function rerenderAIDiagnosis() {
  if (!aiRenderContext) return;
  renderAIDiagnosis(aiRenderContext.kpi, aiRenderContext.byDate, aiRenderContext.byItem, aiRenderContext.filtered);
}

function dateStr(v) {
  if (v instanceof Date) {
    // toISOString()ì€ UTC ê¸°ì¤€ì´ë¼ KSTì—ì„œ í•˜ë£¨ ë°€ë¦¼ â†’ ë¡œì»¬ ì‹œê°„ ë©”ì„œë“œ ì‚¬ìš©
    return v.getFullYear() + '-' +
      String(v.getMonth() + 1).padStart(2, '0') + '-' +
      String(v.getDate()).padStart(2, '0');
  }
  if (typeof v === 'number') {
    const d = new Date((v - 25569) * 86400000);
    return d.getUTCFullYear() + '-' +
      String(d.getUTCMonth() + 1).padStart(2, '0') + '-' +
      String(d.getUTCDate()).padStart(2, '0');
  }
  return String(v).slice(0,10);
}

/* í•œê¸€ ë‚ ì§œ í¬ë§· */
function dateKR(isoStr) {
  // "2024-03-15" â†’ "3/15"
  const parts = isoStr.split('-');
  return Number(parts[1]) + '/' + Number(parts[2]);
}
function dateKRFull(isoStr) {
  // "2024-03-15" â†’ "2024ë…„ 3ì›” 15ì¼"
  const parts = isoStr.split('-');
  return parts[0] + 'ë…„ ' + Number(parts[1]) + 'ì›” ' + Number(parts[2]) + 'ì¼';
}
function dateKRMonth(isoStr) {
  const parts = isoStr.split('-');
  return parts[0] + 'ë…„ ' + Number(parts[1]) + 'ì›”';
}
function weekLabel(isoStr) {
  const d = new Date(isoStr);
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const wk = Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
  return d.getFullYear() + 'ë…„ ' + wk + 'ì£¼ì°¨';
}

function toDate(v) {
  if (v instanceof Date) return v;
  if (typeof v === 'number') return new Date((v - 25569) * 86400000);
  return new Date(v);
}

function toNum(v) {
  if (v == null || v === '') return 0;
  const n = Number(v);
  return isNaN(n) ? 0 : n;
}

/* ================================================================
   ë‹¤í¬ëª¨ë“œ í† ê¸€
   ================================================================ */
const darkToggle = $('darkToggle');
function setDark(on) {
  document.body.classList.toggle('dark', on);
  darkToggle.textContent = on ? 'â˜€' : 'â˜½';
  localStorage.setItem('darkMode', on ? '1' : '0');
  // Plotly ì°¨íŠ¸ ë°°ê²½ ì—…ë°ì´íŠ¸
  document.querySelectorAll('.js-plotly-plot').forEach(p => {
    Plotly.relayout(p, {
      paper_bgcolor: on ? '#1F2937' : '#FFFFFF',
      plot_bgcolor: on ? '#1F2937' : '#FFFFFF',
      font: { color: on ? '#F9FAFB' : '#1F2937' }
    });
  });
}
darkToggle.addEventListener('click', () => setDark(!document.body.classList.contains('dark')));
if (localStorage.getItem('darkMode') === '1' || (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme:dark)').matches)) {
  setDark(true);
}

/* ================================================================
   í…Œì´ë¸” ì •ë ¬/ê²€ìƒ‰ ì „ì—­ í•¨ìˆ˜
   ================================================================ */
function sortTable(tableId, colIdx) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const tbody = table.querySelector('tbody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const th = table.querySelectorAll('th')[colIdx];
  const asc = th.dataset.sort !== 'asc';
  table.querySelectorAll('th').forEach(h => {
    h.dataset.sort = '';
    h.textContent = h.textContent.replace(/ [â†•â†‘â†“]$/, '') + ' â†•';
  });
  th.dataset.sort = asc ? 'asc' : 'desc';
  th.textContent = th.textContent.replace(/ [â†•â†‘â†“]$/, '') + (asc ? ' â†‘' : ' â†“');
  rows.sort((a, b) => {
    // ì…€ì˜ ì²« ë²ˆì§¸ í…ìŠ¤íŠ¸ ë…¸ë“œë§Œ ì¶”ì¶œ (ì¦ê° í‘œì‹œ span ì œì™¸)
    let va = getCellSortValue(a.cells[colIdx]);
    let vb = getCellSortValue(b.cells[colIdx]);

    // 1) ì¼ë³„ ë‚ ì§œ: YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}/.test(va) && /^\d{4}-\d{2}-\d{2}/.test(vb))
      return asc ? va.localeCompare(vb) : vb.localeCompare(va);

    // 2) ì›”ê°„: YYYY-MM
    if (/^\d{4}-\d{2}$/.test(va) && /^\d{4}-\d{2}$/.test(vb))
      return asc ? va.localeCompare(vb) : vb.localeCompare(va);

    // 3) ì£¼ê°„: YYYYë…„ Nì£¼ì°¨ â†’ ìˆ«ìë¡œ ë³€í™˜ (YYYY * 100 + ì£¼ì°¨)
    const wkA = va.match(/^(\d{4})ë…„\s*(\d+)ì£¼ì°¨$/);
    const wkB = vb.match(/^(\d{4})ë…„\s*(\d+)ì£¼ì°¨$/);
    if (wkA && wkB) {
      const nA = parseInt(wkA[1]) * 100 + parseInt(wkA[2]);
      const nB = parseInt(wkB[1]) * 100 + parseInt(wkB[2]);
      return asc ? nA - nB : nB - nA;
    }

    // 4) ìˆ«ì
    const cleanA = va.replace(/[,%â–²â–¼â–³â–½â†‘â†“\s]/g, '');
    const cleanB = vb.replace(/[,%â–²â–¼â–³â–½â†‘â†“\s]/g, '');
    const na = parseFloat(cleanA), nb = parseFloat(cleanB);
    if (!isNaN(na) && !isNaN(nb)) return asc ? na - nb : nb - na;

    // 5) ë¬¸ìì—´
    return asc ? va.localeCompare(vb, 'ko') : vb.localeCompare(va, 'ko');
  });
  rows.forEach(r => tbody.appendChild(r));
}
function getCellSortValue(cell) {
  // ì²« ë²ˆì§¸ í…ìŠ¤íŠ¸ ë…¸ë“œ ë˜ëŠ” ì§ì ‘ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ (span ì¦ê° í‘œì‹œ ì œì™¸)
  for (const node of cell.childNodes) {
    if (node.nodeType === 3) { // TEXT_NODE
      const t = node.textContent.trim();
      if (t) return t;
    }
  }
  return cell.textContent.trim();
}
function filterTable(tableId, query) {
  const table = document.getElementById(tableId);
  if (!table) return;
  const q = query.toLowerCase();
  table.querySelectorAll('tbody tr').forEach(row => {
    const text = row.textContent.toLowerCase();
    row.style.display = text.includes(q) ? '' : 'none';
  });
}

/* ================================================================
   ì‚¬ì´ë“œë°” í† ê¸€ (ëª¨ë°”ì¼)
   ================================================================ */
const menuToggle = $('menuToggle');
const sidebar = $('sidebar');
const overlay = $('sidebarOverlay');

function openSidebar() {
  sidebar.classList.add('open');
  overlay.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeSidebar() {
  sidebar.classList.remove('open');
  overlay.classList.remove('open');
  document.body.style.overflow = '';
}

menuToggle.addEventListener('click', () => {
  sidebar.classList.contains('open') ? closeSidebar() : openSidebar();
});
overlay.addEventListener('click', closeSidebar);

/* ================================================================
   íŒŒì¼ ì—…ë¡œë“œ
   ================================================================ */
const fileDrop = $('fileDrop');
const fileInput = $('fileInput');

fileDrop.addEventListener('click', () => fileInput.click());
fileDrop.addEventListener('dragover', e => { e.preventDefault(); fileDrop.classList.add('dragover'); });
fileDrop.addEventListener('dragleave', () => fileDrop.classList.remove('dragover'));
fileDrop.addEventListener('drop', e => {
  e.preventDefault();
  fileDrop.classList.remove('dragover');
  if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', e => {
  if (e.target.files.length) handleFiles(e.target.files);
});

function handleFiles(files) {
  // ê¸°ì¡´ ì°¨íŠ¸ ë©”ëª¨ë¦¬ ì •ë¦¬
  document.querySelectorAll('#dashboard .js-plotly-plot').forEach(p => {
    try { Plotly.purge(p); } catch(e) {}
  });
  // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
  $('dashboard').style.display = 'none';
  $('placeholder').style.display = '';
  const fileArr = Array.from(files);
  uploadedFiles = uploadedFiles.concat(fileArr);
  let tagsHtml = uploadedFiles.map(f => `<span class="file-tag">${f.name} (${(f.size/1024).toFixed(1)}KB)</span>`).join('');
  fileDrop.innerHTML = `<div style="color:var(--primary);font-weight:600;font-size:13px">${uploadedFiles.length}ê°œ íŒŒì¼ ì—…ë¡œë“œë¨</div><div class="file-list">${tagsHtml}</div>`;
  // ë§ˆì§€ë§‰ íŒŒì¼ì˜ workbook ì‚¬ìš© (ì‹œíŠ¸ ì„ íƒìš©)
  const lastFile = fileArr[fileArr.length - 1];
  const reader = new FileReader();
  reader.onload = e => {
    const data = new Uint8Array(e.target.result);
    workbook = XLSX.read(data, { type: 'array', cellDates: true });
    populateSheets();
  };
  reader.readAsArrayBuffer(lastFile);
}

function handleFile(file) { handleFiles([file]); }

function populateSheets() {
  const sel = $('sheetSelect');
  sel.innerHTML = '';
  workbook.SheetNames.forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    sel.appendChild(opt);
  });
  $('sheetArea').style.display = '';
  sel.addEventListener('change', loadSheet);
  loadSheet();
}

/* ================================================================
   ì‹œíŠ¸ ë¡œë”© + í—¤ë” ê°ì§€
   ================================================================ */
function loadSheet() {
  const name = $('sheetSelect').value;
  const ws = workbook.Sheets[name];
  const allRows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null, raw: false, dateNF: 'yyyy-mm-dd' });

  let bestRow = 0, bestCount = 0;
  for (let i = 0; i < Math.min(10, allRows.length); i++) {
    const row = allRows[i] || [];
    let strCount = 0;
    for (const v of row) {
      if (v != null && String(v).trim() !== '' && isNaN(Number(v))) strCount++;
    }
    if (strCount > bestCount) { bestCount = strCount; bestRow = i; }
  }

  const headerRow = allRows[bestRow] || [];
  columns = headerRow.map((v, i) => {
    const s = v != null ? String(v).trim() : '';
    return s || `Column_${i}`;
  });

  const validIdx = [];
  const validCols = [];
  columns.forEach((c, i) => {
    if (c && !c.match(/^Column_\d+$/) && c.trim()) {
      validIdx.push(i);
      validCols.push(c);
    }
  });

  rawData = [];
  for (let r = bestRow + 1; r < allRows.length; r++) {
    const row = allRows[r];
    if (!row) continue;
    const obj = {};
    let hasVal = false;
    validIdx.forEach((ci, j) => {
      obj[validCols[j]] = row[ci] != null ? row[ci] : null;
      if (row[ci] != null && String(row[ci]).trim() !== '') hasVal = true;
    });
    if (hasVal) rawData.push(obj);
  }
  columns = validCols;

  autoDetectMapping();
}

/* ================================================================
   ìë™ ì»¬ëŸ¼ ë§¤í•‘
   ================================================================ */
const KEYWORDS = {
  'ìƒì‚°ì¼ì': ['ìƒì‚°ì¼ì','ì¼ì','ë‚ ì§œ','date'],
  'í’ˆëª…':     ['í’ˆëª…','í’ˆëª©','ì œí’ˆëª…','item','product'],
  'ìƒì‚°ìˆ˜ëŸ‰': ['ìƒì‚°ìˆ˜ëŸ‰','ìƒì‚°ëŸ‰','ê³„íšìˆ˜ëŸ‰','production'],
  'ì–‘í’ˆìˆ˜ëŸ‰': ['ì–‘í’ˆìˆ˜ëŸ‰','ì–‘í’ˆ','good'],
  'ë¶ˆëŸ‰ìˆ˜ëŸ‰': ['ë¶ˆëŸ‰ìˆ˜ëŸ‰','ë¶ˆëŸ‰','defect','bad'],
};

function autoDetectMapping() {
  mapping = {};
  const used = new Set();

  for (const [std, kwds] of Object.entries(KEYWORDS)) {
    for (const col of columns) {
      if (used.has(col)) continue;
      const cl = col.toLowerCase();
      if (kwds.some(k => cl.includes(k))) {
        mapping[std] = col;
        used.add(col);
        break;
      }
    }
  }

  const badIdx = columns.indexOf(mapping['ë¶ˆëŸ‰ìˆ˜ëŸ‰']);
  const dCols = [];
  if (badIdx >= 0) {
    for (let i = badIdx + 1; i < columns.length; i++) {
      const col = columns[i];
      if (used.has(col)) continue;
      if (col.includes('ë¶ˆëŸ‰ë¥ ')) continue;
      const isNum = rawData.slice(0, 10).some(r => {
        const v = r[col];
        return v != null && !isNaN(Number(v));
      });
      if (isNum) dCols.push(col);
    }
  }
  mapping['ë¶ˆëŸ‰ìœ í˜•'] = dCols;

  renderMapping();
}

function renderMapping() {
  const status = $('mappingStatus');
  const fields = $('mappingFields');
  const stdKeys = ['ìƒì‚°ì¼ì','í’ˆëª…','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰'];
  const allFound = stdKeys.every(k => mapping[k]);

  if (allFound) {
    status.innerHTML = '<div class="info-box success">ìë™ ë§¤í•‘ ì™„ë£Œ!</div>';
  } else {
    status.innerHTML = '<div class="info-box warn">ì¼ë¶€ ì»¬ëŸ¼ì„ ìˆ˜ë™ ë§¤í•‘í•´ì£¼ì„¸ìš”.</div>';
  }

  let html = '';
  for (const std of stdKeys) {
    html += `<div style="margin-top:6px"><label>${std}</label><select id="map_${std}">`;
    html += `<option value="">(ì„ íƒ ì•ˆí•¨)</option>`;
    for (const col of columns) {
      const sel = mapping[std] === col ? ' selected' : '';
      html += `<option value="${col}"${sel}>${col}</option>`;
    }
    html += `</select></div>`;
  }
  // ë¶ˆëŸ‰ìœ í˜• ì²´í¬ë°•ìŠ¤ (ëª¨ë°”ì¼ ì¹œí™”)
  html += `<div style="margin-top:8px"><label>ë¶ˆëŸ‰ìœ í˜• ì»¬ëŸ¼</label>
    <div style="max-height:150px;overflow-y:auto;border:1px solid var(--border);border-radius:8px;padding:8px;">`;
  for (const col of columns) {
    if (stdKeys.some(k => mapping[k] === col)) continue;
    html += `<label style="display:flex;align-items:center;gap:6px;padding:4px 0;font-weight:400;cursor:pointer">
      <input type="checkbox" class="defect-chk" value="${col}" checked style="width:18px;height:18px"> ${col}
    </label>`;
  }
  html += `</div></div>`;

  fields.innerHTML = html;

  for (const std of stdKeys) {
    document.getElementById(`map_${std}`).addEventListener('change', e => {
      mapping[std] = e.target.value || undefined;
    });
  }

  $('mappingArea').style.display = '';
  $('analyzeArea').style.display = '';

  // ëª¨ë°”ì¼ì—ì„œ ë¶„ì„ì‹œì‘ í”Œë¡œíŒ… ë²„íŠ¼ í‘œì‹œ
  if (isMobile()) {
    $('mobileAnalyzeFab').classList.add('show');
  }
}

/* ================================================================
   ë°ì´í„° ì •ì œ
   ================================================================ */
function cleanData(data) {
  // ì²´í¬ë°•ìŠ¤ì—ì„œ ë¶ˆëŸ‰ìœ í˜• ì½ê¸°
  const checks = document.querySelectorAll('.defect-chk');
  defectCols = Array.from(checks).filter(c => c.checked).map(c => c.value);
  mapping['ë¶ˆëŸ‰ìœ í˜•'] = defectCols;

  const m = mapping;
  const result = [];

  for (const row of data) {
    const d = toDate(row[m['ìƒì‚°ì¼ì']]);
    if (isNaN(d.getTime())) continue;

    const prod = toNum(row[m['ìƒì‚°ìˆ˜ëŸ‰']]);
    if (prod <= 0) continue;

    const obj = {
      ìƒì‚°ì¼ì: d,
      í’ˆëª…: String(row[m['í’ˆëª…']] || '').trim(),
      ìƒì‚°ìˆ˜ëŸ‰: prod,
      ì–‘í’ˆìˆ˜ëŸ‰: toNum(row[m['ì–‘í’ˆìˆ˜ëŸ‰']]),
      ë¶ˆëŸ‰ìˆ˜ëŸ‰: toNum(row[m['ë¶ˆëŸ‰ìˆ˜ëŸ‰']]),
    };
    for (const dc of defectCols) {
      obj[dc] = toNum(row[dc]);
    }
    obj['ë¶ˆëŸ‰ë¥ '] = obj.ë¶ˆëŸ‰ìˆ˜ëŸ‰ / obj.ìƒì‚°ìˆ˜ëŸ‰;
    result.push(obj);
  }
  return result;
}

/* ================================================================
   ì§‘ê³„ í•¨ìˆ˜
   ================================================================ */
function calcKPI(data) {
  let prod=0, good=0, bad=0;
  const items = new Set(), dates = new Set();
  for (const r of data) {
    prod += r.ìƒì‚°ìˆ˜ëŸ‰; good += r.ì–‘í’ˆìˆ˜ëŸ‰; bad += r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    items.add(r.í’ˆëª…);
    dates.add(dateStr(r.ìƒì‚°ì¼ì));
  }
  return {
    ì´ìƒì‚°ìˆ˜ëŸ‰: prod, ì´ì–‘í’ˆìˆ˜ëŸ‰: good, ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰: bad,
    ë¶ˆëŸ‰ë¥ : prod ? (bad/prod*100) : 0,
    í’ˆëª©ìˆ˜: items.size, ìƒì‚°ì¼ìˆ˜: dates.size,
  };
}

function aggByDate(data) {
  const map = new Map();
  for (const r of data) {
    const key = dateStr(r.ìƒì‚°ì¼ì);
    if (!map.has(key)) {
      const o = { ìƒì‚°ì¼ì: key, ìƒì‚°ìˆ˜ëŸ‰:0, ì–‘í’ˆìˆ˜ëŸ‰:0, ë¶ˆëŸ‰ìˆ˜ëŸ‰:0 };
      for (const dc of defectCols) o[dc] = 0;
      map.set(key, o);
    }
    const o = map.get(key);
    o.ìƒì‚°ìˆ˜ëŸ‰ += r.ìƒì‚°ìˆ˜ëŸ‰; o.ì–‘í’ˆìˆ˜ëŸ‰ += r.ì–‘í’ˆìˆ˜ëŸ‰; o.ë¶ˆëŸ‰ìˆ˜ëŸ‰ += r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    for (const dc of defectCols) o[dc] += r[dc];
  }
  const arr = [...map.values()].sort((a,b) => a.ìƒì‚°ì¼ì.localeCompare(b.ìƒì‚°ì¼ì));
  arr.forEach(o => o.ë¶ˆëŸ‰ë¥  = o.ìƒì‚°ìˆ˜ëŸ‰ ? o.ë¶ˆëŸ‰ìˆ˜ëŸ‰/o.ìƒì‚°ìˆ˜ëŸ‰ : 0);
  return arr;
}

function aggByItem(data) {
  const map = new Map();
  for (const r of data) {
    if (!map.has(r.í’ˆëª…)) {
      const o = { í’ˆëª…: r.í’ˆëª…, ìƒì‚°ìˆ˜ëŸ‰:0, ì–‘í’ˆìˆ˜ëŸ‰:0, ë¶ˆëŸ‰ìˆ˜ëŸ‰:0 };
      for (const dc of defectCols) o[dc] = 0;
      map.set(r.í’ˆëª…, o);
    }
    const o = map.get(r.í’ˆëª…);
    o.ìƒì‚°ìˆ˜ëŸ‰ += r.ìƒì‚°ìˆ˜ëŸ‰; o.ì–‘í’ˆìˆ˜ëŸ‰ += r.ì–‘í’ˆìˆ˜ëŸ‰; o.ë¶ˆëŸ‰ìˆ˜ëŸ‰ += r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    for (const dc of defectCols) o[dc] += r[dc];
  }
  const arr = [...map.values()];
  arr.forEach(o => o.ë¶ˆëŸ‰ë¥  = o.ìƒì‚°ìˆ˜ëŸ‰ ? o.ë¶ˆëŸ‰ìˆ˜ëŸ‰/o.ìƒì‚°ìˆ˜ëŸ‰ : 0);
  arr.sort((a,b) => b.ë¶ˆëŸ‰ìˆ˜ëŸ‰ - a.ë¶ˆëŸ‰ìˆ˜ëŸ‰);
  return arr;
}

function aggDefectTotals(data) {
  const totals = defectCols.map(dc => {
    let sum = 0;
    for (const r of data) sum += r[dc];
    return { ë¶ˆëŸ‰ìœ í˜•: dc, ê±´ìˆ˜: sum };
  });
  totals.sort((a,b) => b.ê±´ìˆ˜ - a.ê±´ìˆ˜);
  return totals;
}

/* ================================================================
   ì°¨íŠ¸ ìƒì„± (ëª¨ë°”ì¼ ìµœì í™”)
   ================================================================ */
const PALETTE = ['#66c2a5','#fc8d62','#8da0cb','#e78ac3','#a6d854',
  '#ffd92f','#e5c494','#b3b3b3','#fb9a99','#cab2d6'];

function getPlotCfg() {
  const mb = isMobile();
  return {
    responsive: true,
    displayModeBar: true,
    displaylogo: false,
    scrollZoom: false,
    modeBarButtonsToRemove: mb
      ? ['select2d','lasso2d','autoScale2d','toggleSpikelines','hoverCompareCartesian','hoverClosestCartesian']
      : ['select2d','lasso2d'],
    modeBarButtonsToAdd: [],
  };
}

function chartHeight(desktop, mobile) {
  if (isMobile()) {
    // í™”ë©´ ë†’ì´ì˜ 45% ë˜ëŠ” ì§€ì •ê°’ ì¤‘ ì‘ì€ ê²ƒ
    return Math.min(mobile, Math.round(window.innerHeight * 0.45));
  }
  // PC: 1200px+ í™”ë©´ì—ì„œëŠ” ì•½ê°„ í‚¤ì›€
  return window.innerWidth >= 1200 ? Math.round(desktop * 1.1) : desktop;
}

function chartKPI(kpi, el) {
  el.innerHTML = '';
  const cards = [
    { label:'ì´ ìƒì‚°ìˆ˜ëŸ‰', value: fmt(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰), color:'var(--primary)' },
    { label:'ì´ ì–‘í’ˆìˆ˜ëŸ‰', value: fmt(kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰), color:'var(--success)' },
    { label:'ì´ ë¶ˆëŸ‰ìˆ˜ëŸ‰', value: fmt(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰), color:'var(--danger)' },
    { label:'ë¶ˆëŸ‰ë¥ ', value: pct(kpi.ë¶ˆëŸ‰ë¥ ), color:'var(--warning)' },
    { label:'í’ˆëª©ìˆ˜', value: kpi.í’ˆëª©ìˆ˜ + 'ê°œ', color:'var(--gray)' },
    { label:'ìƒì‚°ì¼ìˆ˜', value: kpi.ìƒì‚°ì¼ìˆ˜ + 'ì¼', color:'var(--gray)' },
  ];
  const grid = document.createElement('div');
  grid.className = 'kpi-grid';
  for (const c of cards) {
    grid.innerHTML += `<div class="kpi-card"><div class="value" style="color:${c.color}">${c.value}</div><div class="label">${c.label}</div></div>`;
  }
  el.appendChild(grid);
}

function chartDailyTrend(byDate, el) {
  const dates = byDate.map(r => dateKR(r.ìƒì‚°ì¼ì));
  const mb = isMobile();
  const trace1 = {
    x: dates, y: byDate.map(r => r.ìƒì‚°ìˆ˜ëŸ‰), type:'bar',
    name:'ìƒì‚°ìˆ˜ëŸ‰', marker:{color:'#2563EB', opacity:.75}, yaxis:'y'
  };
  const trace2 = {
    x: dates, y: byDate.map(r => r.ë¶ˆëŸ‰ë¥ *100), type:'scatter', mode:'lines+markers' + (mb ? '' : '+text'),
    name:'ë¶ˆëŸ‰ë¥ (%)', line:{color:'#DC2626', width:2.5}, marker:{size: mb ? 6 : 8},
    text: byDate.map(r => pct(r.ë¶ˆëŸ‰ë¥ *100)), textposition:'top center',
    textfont:{size: mb ? 8 : 10, color:'#DC2626'}, yaxis:'y2'
  };
  Plotly.newPlot(el, [trace1, trace2], {
    title: mb ? '' : 'ì¼ìë³„ ìƒì‚°ìˆ˜ëŸ‰ ë° ë¶ˆëŸ‰ë¥  ì¶”ì´',
    yaxis:{title: mb ? '' : 'ìƒì‚°ìˆ˜ëŸ‰'},
    yaxis2:{title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)', overlaying:'y', side:'right'},
    legend:{orientation:'h', y: mb ? 1.15 : 1.12, font:{size: mb ? 10 : 12}},
    height: chartHeight(420, 300),
    margin: mb ? {t:30,b:40,l:40,r:40} : {t:60,b:50,l:60,r:60}
  }, getPlotCfg());
}

function chartPareto(totals, el) {
  const filtered = totals.filter(t => t.ê±´ìˆ˜ > 0);
  if (!filtered.length) { el.innerHTML = '<p>ë¶ˆëŸ‰ ë°ì´í„° ì—†ìŒ</p>'; return; }
  const total = filtered.reduce((s,t) => s+t.ê±´ìˆ˜, 0);
  let cum = 0;
  const cumPct = filtered.map(t => { cum += t.ê±´ìˆ˜; return cum/total*100; });
  const mb = isMobile();

  const trace1 = {
    x: filtered.map(t=>t.ë¶ˆëŸ‰ìœ í˜•), y: filtered.map(t=>t.ê±´ìˆ˜), type:'bar',
    name:'ë¶ˆëŸ‰ ê±´ìˆ˜', marker:{color:'#2563EB', opacity:.85},
    text: filtered.map(t=>fmt(t.ê±´ìˆ˜)), textposition:'outside',
    textfont:{size: mb ? 9 : 12}
  };
  const trace2 = {
    x: filtered.map(t=>t.ë¶ˆëŸ‰ìœ í˜•), y: cumPct, type:'scatter', mode:'lines+markers' + (mb ? '' : '+text'),
    name:'ëˆ„ì  ë¹„ìœ¨', marker:{size: mb ? 5 : 7, symbol:'diamond'}, line:{color:'#DC2626', width:2.5},
    text: cumPct.map(v=>pct(v,1)), textposition:'top center',
    textfont:{size: mb ? 8 : 10, color:'#DC2626'}, yaxis:'y2'
  };
  Plotly.newPlot(el, [trace1, trace2], {
    title: mb ? '' : 'ë¶ˆëŸ‰ ìœ í˜•ë³„ íŒŒë ˆí†  ë¶„ì„',
    yaxis:{title: mb ? '' : 'ë¶ˆëŸ‰ ê±´ìˆ˜'},
    yaxis2:{title: mb ? '' : 'ëˆ„ì  ë¹„ìœ¨ (%)', overlaying:'y', side:'right', range:[0,110]},
    shapes:[{type:'line',yref:'y2',y0:80,y1:80,x0:0,x1:1,xref:'paper',line:{dash:'dash',color:'#F59E0B'}}],
    legend:{orientation:'h', y: mb ? 1.18 : 1.12, font:{size: mb ? 10 : 12}},
    height: chartHeight(420, 320),
    margin: mb ? {t:30,b:60,l:40,r:40} : {t:60,b:50,l:60,r:60}
  }, getPlotCfg());
}

function chartItemTop15(byItem, el) {
  const filtered = byItem.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ >= 50)
    .sort((a,b) => b.ë¶ˆëŸ‰ë¥  - a.ë¶ˆëŸ‰ë¥ ).slice(0,15).reverse();
  if (!filtered.length) { el.innerHTML = '<p>ë°ì´í„° ë¶€ì¡± (ìƒì‚° 50ê°œ ì´ìƒ í’ˆëª© ì—†ìŒ)</p>'; return; }
  const mb = isMobile();

  const labels = filtered.map(r => {
    const maxLen = mb ? 18 : 30;
    return r.í’ˆëª….length > maxLen ? r.í’ˆëª….slice(0, maxLen)+'...' : r.í’ˆëª…;
  });
  const rates = filtered.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  const maxRate = Math.max(...rates);

  // í…ìŠ¤íŠ¸ ìœ„ì¹˜: ë§‰ëŒ€ê°€ ì „ì²´ì˜ 60% ì´ìƒì´ë©´ ì•ˆìª½, ì•„ë‹ˆë©´ ë°”ê¹¥ìª½
  const textPositions = rates.map(v => v > maxRate * 0.5 ? 'inside' : 'outside');
  const textColors = rates.map(v => v > maxRate * 0.5 ? '#FFFFFF' : '#1F2937');
  const texts = filtered.map(r =>
    mb ? `${pct(r.ë¶ˆëŸ‰ë¥ *100,1)} (${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}/${fmt(r.ìƒì‚°ìˆ˜ëŸ‰)})`
       : `${pct(r.ë¶ˆëŸ‰ë¥ *100,1)}  |  ë¶ˆëŸ‰ ${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê°œ  /  ìƒì‚° ${fmt(r.ìƒì‚°ìˆ˜ëŸ‰)}ê°œ`
  );

  Plotly.newPlot(el, [{
    y: labels, x: rates, type:'bar', orientation:'h',
    marker:{color: rates.map(v => v >= 10 ? '#991B1B' : v >= 5 ? '#DC2626' : '#F87171'), opacity:.9},
    text: texts, textposition: textPositions,
    textfont:{size: mb ? 9 : 12, color: textColors, family:'Malgun Gothic, sans-serif'},
    insidetextanchor: 'end',
    hovertemplate: '<b>%{y}</b><br>ë¶ˆëŸ‰ë¥ : %{x:.1f}%<br>%{text}<extra></extra>'
  }], {
    title: mb ? '' : 'í’ˆëª©ë³„ ë¶ˆëŸ‰ë¥  TOP 15 (ìƒì‚° 50ê°œ ì´ìƒ)',
    xaxis:{title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)', range: [0, maxRate * 1.35]},
    yaxis:{tickfont:{size: mb ? 10 : 12}},
    height: Math.max(mb ? 380 : 450, filtered.length * (mb ? 30 : 38) + 80),
    margin: mb ? {l:150, r:30, t:20, b:30} : {l:260, r:30, t:50, b:40}
  }, getPlotCfg());
}

function chartHeatmap(byItem, el) {
  // byItem ê¸°ë°˜ (filtered ëŒ€ì‹ ) â€” localStorage ë³µì› ì‹œì—ë„ ë™ì‘
  if (!defectCols.length || !byItem.length) {
    el.innerHTML = '<p style="color:var(--text-light);padding:20px">ë¶ˆëŸ‰ìœ í˜• ì»¬ëŸ¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }

  const mb = isMobile();
  const topN = mb ? 10 : 20;
  const sorted = [...byItem].sort((a,b) => b.ë¶ˆëŸ‰ìˆ˜ëŸ‰ - a.ë¶ˆëŸ‰ìˆ˜ëŸ‰).slice(0, topN);

  // ê±´ìˆ˜ í–‰ë ¬: byItem ê° rowì— defectCol í•©ê³„ê°€ ì´ë¯¸ ë“¤ì–´ìˆìŒ
  const matrixCount = sorted.map(item => defectCols.map(dc => item[dc] || 0));

  // ë¶ˆëŸ‰ë¥  í–‰ë ¬ (í•´ë‹¹ í’ˆëª© ìƒì‚°ìˆ˜ëŸ‰ ëŒ€ë¹„ %)
  const matrixRate = sorted.map((item, idx) => {
    const prod = item.ìƒì‚°ìˆ˜ëŸ‰ || 1;
    return matrixCount[idx].map(v => +(v / prod * 100).toFixed(2));
  });

  // í‘œì‹œ í…ìŠ¤íŠ¸: ê±´ìˆ˜ + ë¹„ìœ¨
  const textMatrix = matrixCount.map((row, i) =>
    row.map((v, j) => v > 0 ? fmt(v) + '\n(' + pct(matrixRate[i][j], 1) + ')' : '-')
  );

  const maxLen = mb ? 15 : 25;
  const labels = sorted.map(r => r.í’ˆëª….length > maxLen ? r.í’ˆëª….slice(0, maxLen)+'...' : r.í’ˆëª…);

  // ë¶ˆëŸ‰ìœ í˜•ë³„ í•©ê³„ (xì¶•)
  const colTotals = defectCols.map((dc, j) => matrixCount.reduce((s, row) => s + row[j], 0));
  const xLabels = defectCols.map((dc, j) => dc + ' (' + fmt(colTotals[j]) + ')');

  // í’ˆëª©ë³„ í•©ê³„ (yì¶•)
  const rowTotals = matrixCount.map(row => row.reduce((s, v) => s + v, 0));
  const yLabels = labels.map((l, i) => l + ' [' + fmt(rowTotals[i]) + ']');

  // zmaxë¥¼ ìƒìœ„ 95%ileë¡œ ì„¤ì •í•˜ì—¬ ê·¹ë‹¨ê°’ì´ ìƒ‰ìƒì„ ì§€ë°°í•˜ì§€ ì•Šë„ë¡
  const allRates = matrixRate.flat().filter(v => v > 0).sort((a,b) => a - b);
  const zMax = allRates.length > 2 ? allRates[Math.floor(allRates.length * 0.95)] || 10 : 10;

  Plotly.newPlot(el, [{
    z: matrixRate, x: xLabels, y: yLabels, type: 'heatmap',
    colorscale: [
      [0, '#F0FDF4'], [0.15, '#BBF7D0'], [0.3, '#FEF9C3'],
      [0.5, '#FED7AA'], [0.7, '#FECACA'], [1, '#991B1B']
    ],
    text: textMatrix,
    texttemplate: '%{text}', textfont: {size: mb ? 8 : 11, color: '#1F2937'},
    hovertemplate: '<b>%{y}</b><br>ë¶ˆëŸ‰ìœ í˜•: %{x}<br>ë¶ˆëŸ‰ë¥ : %{z:.2f}%<extra></extra>',
    colorbar: {title: 'ë¶ˆëŸ‰ë¥ (%)', len: 0.8, ticksuffix: '%'},
    zmin: 0, zmax: zMax,
    xgap: 2, ygap: 2
  }], {
    title: mb ? '' : 'í’ˆëª© x ë¶ˆëŸ‰ìœ í˜• íˆíŠ¸ë§µ (ìƒ‰ìƒ: ë¶ˆëŸ‰ë¥  ê¸°ì¤€)',
    height: Math.max(mb ? 400 : 580, sorted.length * (mb ? 35 : 38) + 120),
    margin: mb ? {l: 160, r: 40, t: 20, b: 90} : {l: 270, r: 60, t: 50, b: 90},
    yaxis: {autorange: 'reversed', tickfont: {size: mb ? 10 : 12}},
    xaxis: {tickangle: mb ? -45 : -30, tickfont: {size: mb ? 9 : 11}, side: 'bottom'}
  }, getPlotCfg());
}

/* ================================================================
   ë²„ë¸”ì°¨íŠ¸ ë‚ ì§œë³„ ì• ë‹ˆë©”ì´ì…˜
   - ëˆ„ì  ë°©ì‹: ë‚ ì§œê°€ ì§„í–‰ë ìˆ˜ë¡ ë°ì´í„°ê°€ ìŒ“ì„
   - í’ˆëª©ë³„ë¡œ ìƒì‚°/ë¶ˆëŸ‰ì´ ëˆ„ì ë˜ë©° ë²„ë¸”ì´ ì„±ì¥
   ================================================================ */
function chartScatterAnimated(data, byDate, el) {
  if (!data || !data.length || !byDate || !byDate.length) {
    el.innerHTML = '<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>';
    return;
  }
  const mb = isMobile();

  // byDateì˜ ìƒì‚°ì¼ìëŠ” ì´ë¯¸ ISOë¬¸ìì—´ "2024-03-15"
  const dates = byDate.map(r => String(r.ìƒì‚°ì¼ì).slice(0,10));

  // data(filtered)ì˜ ìƒì‚°ì¼ìë¥¼ ISO ë¬¸ìì—´ë¡œ ë¯¸ë¦¬ ë³€í™˜í•˜ì—¬ ë§¤í•‘
  const dataWithStr = data.map(r => ({
    í’ˆëª…: r.í’ˆëª…,
    ìƒì‚°ìˆ˜ëŸ‰: toNum(r.ìƒì‚°ìˆ˜ëŸ‰),
    ë¶ˆëŸ‰ìˆ˜ëŸ‰: toNum(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰),
    dateKey: dateStr(r.ìƒì‚°ì¼ì)
  }));

  // ë‚ ì§œë³„ë¡œ ëˆ„ì  ë°ì´í„° ê³„ì‚°
  const frames = [];
  const cumMap = {};
  for (let di = 0; di < dates.length; di++) {
    const d = dates[di];
    const dayRows = dataWithStr.filter(r => r.dateKey === d);
    for (const r of dayRows) {
      if (!cumMap[r.í’ˆëª…]) cumMap[r.í’ˆëª…] = {í’ˆëª…: r.í’ˆëª…, ìƒì‚°ìˆ˜ëŸ‰: 0, ë¶ˆëŸ‰ìˆ˜ëŸ‰: 0};
      cumMap[r.í’ˆëª…].ìƒì‚°ìˆ˜ëŸ‰ += r.ìƒì‚°ìˆ˜ëŸ‰;
      cumMap[r.í’ˆëª…].ë¶ˆëŸ‰ìˆ˜ëŸ‰ += r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    }
    // í˜„ì¬ ìŠ¤ëƒ…ìƒ· ê¹Šì€ ë³µì‚¬
    const snapshot = Object.values(cumMap).map(v => ({
      í’ˆëª…: v.í’ˆëª…,
      ìƒì‚°ìˆ˜ëŸ‰: v.ìƒì‚°ìˆ˜ëŸ‰,
      ë¶ˆëŸ‰ìˆ˜ëŸ‰: v.ë¶ˆëŸ‰ìˆ˜ëŸ‰,
      ë¶ˆëŸ‰ë¥ : v.ìƒì‚°ìˆ˜ëŸ‰ > 0 ? v.ë¶ˆëŸ‰ìˆ˜ëŸ‰ / v.ìƒì‚°ìˆ˜ëŸ‰ : 0
    }));
    frames.push({date: d, items: snapshot});
  }

  // ë§ˆì§€ë§‰ í”„ë ˆì„ì—ì„œ ì „ì²´ ë²”ìœ„ ê²°ì •
  if (!frames.length) {
    el.innerHTML = '<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>';
    return;
  }
  const lastItems = frames[frames.length - 1].items;
  const validItems = lastItems.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ >= 10);
  if (!validItems.length) {
    el.innerHTML = '<p style="color:var(--text-light);padding:20px">ìœ íš¨ í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  const maxProd = Math.max(...validItems.map(r => r.ìƒì‚°ìˆ˜ëŸ‰));
  const maxRate = Math.max(...validItems.map(r => r.ë¶ˆëŸ‰ë¥  * 100), 10);
  const maxBad = Math.max(...validItems.map(r => r.ë¶ˆëŸ‰ìˆ˜ëŸ‰), 1);

  // UI
  el.innerHTML = `
    <div class="anim-controls" style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap">
      <div class="anim-row1" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button class="btn btn-sm btn-primary" id="animPlay" style="min-width:70px">â–¶ ì¬ìƒ</button>
        <button class="btn btn-sm" style="background:var(--gray);color:#fff;min-width:50px" id="animReset">ì²˜ìŒ</button>
        <span id="animDateLabel" style="font-weight:700;font-size:14px;min-width:100px;text-align:center">
          ${dateKRFull(dates[dates.length-1])}
        </span>
      </div>
      <div class="anim-row2" style="display:flex;align-items:center;gap:8px;flex:1;min-width:120px">
        <input type="range" id="animSlider" min="0" max="${frames.length-1}" value="${frames.length-1}"
          style="flex:1;height:36px">
        <label class="anim-speed" style="font-size:12px;display:flex;align-items:center;gap:4px;white-space:nowrap">
          <input type="range" id="animSpeed" min="100" max="1500" value="500" style="width:70px;height:30px">
          ì†ë„
        </label>
      </div>
    </div>
    <div id="animChart" style="width:100%"></div>`;

  const chartEl = document.getElementById('animChart');
  const slider = document.getElementById('animSlider');
  const lblDate = document.getElementById('animDateLabel');
  const btnPlay = document.getElementById('animPlay');
  const btnReset = document.getElementById('animReset');
  const sldSpeed = document.getElementById('animSpeed');
  let timer = null, isPlaying = false;

  function draw(idx) {
    if (idx < 0 || idx >= frames.length) return;
    const frame = frames[idx];
    const items = frame.items.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ >= 10);
    if (!items.length) return;

    const bubbleSizes = items.map(r => Math.max(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰ / maxBad * (mb ? 30 : 50), mb ? 5 : 7));
    const bubbleColors = items.map(r => {
      const rt = r.ë¶ˆëŸ‰ë¥  * 100;
      return rt >= 8 ? '#991B1B' : rt >= 5 ? '#DC2626' : rt >= 3 ? '#F59E0B' : '#2563EB';
    });
    const topN = [...items].sort((a,b) => b.ë¶ˆëŸ‰ìˆ˜ëŸ‰ - a.ë¶ˆëŸ‰ìˆ˜ëŸ‰).slice(0, 8).map(r => r.í’ˆëª…);

    const trace = {
      x: items.map(r => r.ìƒì‚°ìˆ˜ëŸ‰),
      y: items.map(r => r.ë¶ˆëŸ‰ë¥  * 100),
      mode: 'markers+text',
      type: 'scatter',
      marker: {size: bubbleSizes, color: bubbleColors, opacity: 0.85,
        line: {width: 1.5, color: 'rgba(255,255,255,0.8)'}},
      text: items.map(r => topN.includes(r.í’ˆëª…) ? r.í’ˆëª….slice(0, mb ? 8 : 15) : ''),
      textposition: 'top center',
      textfont: {size: mb ? 7 : 9, color: '#374151'},
      hovertext: items.map(r => r.í’ˆëª…),
      customdata: items.map(r => [r.ë¶ˆëŸ‰ìˆ˜ëŸ‰, r.ìƒì‚°ìˆ˜ëŸ‰]),
      hovertemplate: '<b>%{hovertext}</b><br>ëˆ„ì ìƒì‚°: %{customdata[1]:,}ê°œ<br>ëˆ„ì ë¶ˆëŸ‰: %{customdata[0]:,}ê°œ<br>ë¶ˆëŸ‰ë¥ : %{y:.2f}%<extra></extra>'
    };

    const dateText = dateKRFull(frame.date);
    const layout = {
      xaxis: {title: mb ? '' : 'ëˆ„ì  ìƒì‚°ìˆ˜ëŸ‰', range: [Math.log10(5), Math.log10(maxProd * 1.3)], type: 'log',
        gridcolor: '#E5E7EB', zeroline: false},
      yaxis: {title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)', range: [-0.5, Math.min(maxRate * 1.3, 100)],
        gridcolor: '#E5E7EB', zeroline: false},
      height: chartHeight(480, 360),
      margin: mb ? {t: 40, b: 40, l: 40, r: 20} : {t: 60, b: 50, l: 60, r: 40},
      annotations: [{
        x: 0.98, y: 0.98, xref: 'paper', yref: 'paper', showarrow: false,
        text: '<b>' + dateText + '</b>',
        font: {size: mb ? 16 : 24, color: '#2563EB'},
        xanchor: 'right', yanchor: 'top',
        bgcolor: 'rgba(255,255,255,0.85)', borderpad: 8,
        bordercolor: '#E5E7EB', borderwidth: 1
      }, {
        x: 0.02, y: 0.98, xref: 'paper', yref: 'paper', showarrow: false,
        text: 'í’ˆëª©ìˆ˜: ' + items.length + 'ê°œ',
        font: {size: mb ? 10 : 12, color: '#6B7280'},
        xanchor: 'left', yanchor: 'top'
      }]
    };

    Plotly.react(chartEl, [trace], layout, getPlotCfg());
  }

  // ì´ˆê¸° ë Œë”: ë¹ˆ ì°¨íŠ¸ ë¨¼ì € ìƒì„± í›„ ë§ˆì§€ë§‰ í”„ë ˆì„
  Plotly.newPlot(chartEl, [{x:[],y:[],type:'scatter',mode:'markers'}], {
    height: chartHeight(480, 360),
    xaxis: {type:'log', range:[Math.log10(5),Math.log10(maxProd*1.3)]},
    yaxis: {range:[-0.5,Math.min(maxRate*1.3,100)]},
    margin: mb?{t:40,b:40,l:40,r:20}:{t:60,b:50,l:60,r:40}
  }, getPlotCfg());
  draw(frames.length - 1);

  slider.addEventListener('input', function() {
    const idx = parseInt(this.value);
    lblDate.textContent = dateKRFull(dates[idx]);
    draw(idx);
  });

  btnPlay.addEventListener('click', function() {
    if (isPlaying) {
      clearInterval(timer); isPlaying = false;
      this.textContent = 'â–¶ ì¬ìƒ';
      return;
    }
    isPlaying = true;
    this.textContent = 'â¸ ì •ì§€';
    if (parseInt(slider.value) >= frames.length - 1) {
      slider.value = 0;
      draw(0);
    }

    timer = setInterval(function() {
      let idx = parseInt(slider.value) + 1;
      if (idx >= frames.length) {
        clearInterval(timer); isPlaying = false;
        btnPlay.textContent = 'â–¶ ì¬ìƒ';
        return;
      }
      slider.value = idx;
      lblDate.textContent = dateKRFull(dates[idx]);
      draw(idx);
    }, parseInt(sldSpeed.value));
  });

  btnReset.addEventListener('click', function() {
    if (isPlaying) { clearInterval(timer); isPlaying = false; btnPlay.textContent = 'â–¶ ì¬ìƒ'; }
    slider.value = 0;
    lblDate.textContent = dateKRFull(dates[0]);
    draw(0);
  });
}

function chartDailyStack(byDate, el) {
  const active = defectCols.filter(dc => byDate.some(r => r[dc] > 0));
  const dates = byDate.map(r => dateKR(r.ìƒì‚°ì¼ì));
  const mb = isMobile();
  const traces = active.map((dc, i) => ({
    x: dates, y: byDate.map(r => r[dc]), type:'bar', name: dc,
    marker:{color: PALETTE[i % PALETTE.length]}
  }));
  Plotly.newPlot(el, traces, {
    barmode:'stack',
    title: mb ? '' : 'ì¼ìë³„ ë¶ˆëŸ‰ìœ í˜• êµ¬ì„±',
    xaxis:{title: mb ? '' : 'ìƒì‚°ì¼ì'},
    yaxis:{title: mb ? '' : 'ë¶ˆëŸ‰ ê±´ìˆ˜'},
    legend:{orientation:'h', y: mb ? 1.2 : 1.12, font:{size: mb ? 9 : 12}},
    height: chartHeight(420, 300),
    margin: mb ? {t:30,b:40,l:35,r:10} : {t:60,b:50,l:60,r:40}
  }, getPlotCfg());
}

function chartScatter(byItem, el) {
  const df = byItem.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ >= 50);
  if (!df.length) { el.innerHTML = '<p>ë°ì´í„° ë¶€ì¡± (ìƒì‚° 50ê°œ ì´ìƒ í’ˆëª© ì—†ìŒ)</p>'; return; }
  const mb = isMobile();

  // ê¸°ì¤€ì„  ê³„ì‚°: ìƒì‚°ìˆ˜ëŸ‰ ì¤‘ì•™ê°’, ë¶ˆëŸ‰ë¥  ì¤‘ì•™ê°’
  const sortedProd = [...df].sort((a,b) => a.ìƒì‚°ìˆ˜ëŸ‰ - b.ìƒì‚°ìˆ˜ëŸ‰);
  const sortedRate = [...df].sort((a,b) => a.ë¶ˆëŸ‰ë¥  - b.ë¶ˆëŸ‰ë¥ );
  const medProd = sortedProd[Math.floor(sortedProd.length/2)].ìƒì‚°ìˆ˜ëŸ‰;
  const medRate = sortedRate[Math.floor(sortedRate.length/2)].ë¶ˆëŸ‰ë¥  * 100;

  // 4ì‚¬ë¶„ë©´ ìƒ‰ìƒ: ìš°ìƒ(ìœ„í—˜-ë¹¨ê°•), ì¢Œìƒ(ì£¼ì˜-ì£¼í™©), ìš°í•˜(ì–‘í˜¸-íŒŒë‘), ì¢Œí•˜(ê´€ì‹¬-íšŒìƒ‰)
  const quadColors = df.map(r => {
    const highProd = r.ìƒì‚°ìˆ˜ëŸ‰ >= medProd;
    const highRate = r.ë¶ˆëŸ‰ë¥  * 100 >= medRate;
    if (highProd && highRate) return '#DC2626';   // ìœ„í—˜: ëŒ€ëŸ‰ìƒì‚° + ë†’ì€ë¶ˆëŸ‰
    if (!highProd && highRate) return '#F59E0B';  // ì£¼ì˜: ì†ŒëŸ‰ì´ì§€ë§Œ ë†’ì€ë¶ˆëŸ‰
    if (highProd && !highRate) return '#2563EB';  // ì–‘í˜¸: ëŒ€ëŸ‰ìƒì‚° + ë‚®ì€ë¶ˆëŸ‰
    return '#94A3B8';                              // ê´€ì‹¬: ì†ŒëŸ‰ + ë‚®ì€ë¶ˆëŸ‰
  });

  // ë²„ë¸” í¬ê¸°: ë¶ˆëŸ‰ìˆ˜ëŸ‰ ë¹„ë¡€ (ìµœì†Œ~ìµœëŒ€ ì •ê·œí™”)
  const badArr = df.map(r => r.ë¶ˆëŸ‰ìˆ˜ëŸ‰);
  const maxBad = Math.max(...badArr, 1);
  const sizes = badArr.map(v => Math.max(v / maxBad * (mb ? 30 : 50), mb ? 6 : 8));

  // ë¼ë²¨: ìƒìœ„ ë¶ˆëŸ‰ìˆ˜ëŸ‰ TOP 10 + ë¶ˆëŸ‰ë¥  TOP 5 í‘œì‹œ
  const topBad = [...df].sort((a,b) => b.ë¶ˆëŸ‰ìˆ˜ëŸ‰ - a.ë¶ˆëŸ‰ìˆ˜ëŸ‰).slice(0, 10).map(r => r.í’ˆëª…);
  const topRate = [...df].sort((a,b) => b.ë¶ˆëŸ‰ë¥  - a.ë¶ˆëŸ‰ë¥ ).slice(0, 5).map(r => r.í’ˆëª…);
  const showLabel = new Set([...topBad, ...topRate]);

  Plotly.newPlot(el, [
    // 4ì‚¬ë¶„ë©´ ë°°ê²½ í‘œì‹œ
    { x: df.map(r=>r.ìƒì‚°ìˆ˜ëŸ‰), y: df.map(r=>r.ë¶ˆëŸ‰ë¥ *100), type:'scatter', mode: 'markers' + (mb ? '' : '+text'),
      marker: {size: sizes, color: quadColors, line: {width: 1.5, color: 'white'}, opacity: 0.85},
      text: df.map(r => showLabel.has(r.í’ˆëª…) ? r.í’ˆëª….slice(0, mb ? 8 : 18) : ''),
      textposition: 'top center', textfont: {size: mb ? 7 : 9, color: '#374151'},
      hovertemplate: '<b>%{hovertext}</b><br>ìƒì‚°: %{x:,}ê°œ<br>ë¶ˆëŸ‰: %{customdata[0]:,}ê°œ<br>ë¶ˆëŸ‰ë¥ : %{y:.2f}%<extra></extra>',
      hovertext: df.map(r => r.í’ˆëª…),
      customdata: df.map(r => [r.ë¶ˆëŸ‰ìˆ˜ëŸ‰]),
    }
  ], {
    title: mb ? '' : 'ìƒì‚°ìˆ˜ëŸ‰ vs ë¶ˆëŸ‰ë¥  (ë²„ë¸” í¬ê¸° = ë¶ˆëŸ‰ìˆ˜ëŸ‰)',
    xaxis: {title: mb ? '' : 'ìƒì‚°ìˆ˜ëŸ‰', type: 'log', gridcolor: '#E5E7EB'},
    yaxis: {title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)', gridcolor: '#E5E7EB'},
    height: chartHeight(520, 380),
    margin: mb ? {t: 20, b: 40, l: 40, r: 20} : {t: 50, b: 60, l: 60, r: 60},
    shapes: [
      // ìˆ˜í‰ ê¸°ì¤€ì„  (ë¶ˆëŸ‰ë¥  ì¤‘ì•™ê°’)
      {type: 'line', x0: 0, x1: 1, xref: 'paper', y0: medRate, y1: medRate,
        line: {color: '#9CA3AF', width: 1.5, dash: 'dot'}},
      // ìˆ˜ì§ ê¸°ì¤€ì„  (ìƒì‚°ìˆ˜ëŸ‰ ì¤‘ì•™ê°’)
      {type: 'line', y0: 0, y1: 1, yref: 'paper', x0: medProd, x1: medProd,
        line: {color: '#9CA3AF', width: 1.5, dash: 'dot'}},
    ],
    annotations: [
      // 4ì‚¬ë¶„ë©´ ë¼ë²¨
      {x: 1, y: 1, xref: 'paper', yref: 'paper', text: '<b>ìœ„í—˜</b><br>ëŒ€ëŸ‰+ê³ ë¶ˆëŸ‰', showarrow: false,
        font: {color: '#DC2626', size: mb ? 9 : 11}, xanchor: 'right', yanchor: 'top', bgcolor: 'rgba(254,226,226,0.7)', borderpad: 4},
      {x: 0, y: 1, xref: 'paper', yref: 'paper', text: '<b>ì£¼ì˜</b><br>ì†ŒëŸ‰+ê³ ë¶ˆëŸ‰', showarrow: false,
        font: {color: '#F59E0B', size: mb ? 9 : 11}, xanchor: 'left', yanchor: 'top', bgcolor: 'rgba(254,243,199,0.7)', borderpad: 4},
      {x: 1, y: 0, xref: 'paper', yref: 'paper', text: '<b>ì–‘í˜¸</b><br>ëŒ€ëŸ‰+ì €ë¶ˆëŸ‰', showarrow: false,
        font: {color: '#2563EB', size: mb ? 9 : 11}, xanchor: 'right', yanchor: 'bottom', bgcolor: 'rgba(219,234,254,0.7)', borderpad: 4},
      {x: 0, y: 0, xref: 'paper', yref: 'paper', text: '<b>ê´€ì‹¬</b><br>ì†ŒëŸ‰+ì €ë¶ˆëŸ‰', showarrow: false,
        font: {color: '#6B7280', size: mb ? 9 : 11}, xanchor: 'left', yanchor: 'bottom', bgcolor: 'rgba(243,244,246,0.7)', borderpad: 4},
      // ê¸°ì¤€ì„  ì„¤ëª…
      {x: 0.5, y: medRate, xref: 'paper', yref: 'y', text: 'ë¶ˆëŸ‰ë¥  ì¤‘ì•™ê°’ ' + pct(medRate,1), showarrow: false,
        font: {size: mb ? 8 : 10, color: '#6B7280'}, yshift: 12},
    ]
  }, getPlotCfg());
}

/* ================================================================
   í…Œì´ë¸” ìƒì„±
   ================================================================ */
function makeTable(headers, rows) {
  let html = '<div class="scroll-hint">&#8592; ì¢Œìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥ &#8594;</div>';
  html += '<div class="tbl-wrap"><table class="data-tbl"><thead><tr>';
  for (const h of headers) html += `<th>${h}</th>`;
  html += '</tr></thead><tbody>';
  for (const row of rows) {
    html += '<tr>';
    for (const h of headers) {
      let v = row[h];
      if (typeof v === 'number') v = h.includes('ë¥ ') ? pct(v*100) : fmt(v);
      html += `<td>${v ?? ''}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table></div>';
  return html;
}

/* ================================================================
   ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
   ================================================================ */
function exportExcel(kpi, byDate, byItem, totals) {
  const wb = XLSX.utils.book_new();

  const kpiData = [
    ['ì§€í‘œ','ê°’'],
    ['ì´ ìƒì‚°ìˆ˜ëŸ‰', kpi.ì´ìƒì‚°ìˆ˜ëŸ‰], ['ì´ ì–‘í’ˆìˆ˜ëŸ‰', kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰],
    ['ì´ ë¶ˆëŸ‰ìˆ˜ëŸ‰', kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰], ['ì „ì²´ ë¶ˆëŸ‰ë¥ (%)', kpi.ë¶ˆëŸ‰ë¥ .toFixed(2)],
    ['í’ˆëª©ìˆ˜', kpi.í’ˆëª©ìˆ˜], ['ìƒì‚°ì¼ìˆ˜', kpi.ìƒì‚°ì¼ìˆ˜],
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(kpiData), 'ìš”ì•½_KPI');

  const dateHeaders = ['ìƒì‚°ì¼ì','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰',...defectCols,'ë¶ˆëŸ‰ë¥ (%)'];
  const dateRows = [dateHeaders, ...byDate.map(r => [
    r.ìƒì‚°ì¼ì, r.ìƒì‚°ìˆ˜ëŸ‰, r.ì–‘í’ˆìˆ˜ëŸ‰, r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,
    ...defectCols.map(dc=>r[dc]), (r.ë¶ˆëŸ‰ë¥ *100).toFixed(2)
  ])];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(dateRows), 'ì¼ìë³„_ì§‘ê³„');

  const itemHeaders = ['í’ˆëª…','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰',...defectCols,'ë¶ˆëŸ‰ë¥ (%)'];
  const itemRows = [itemHeaders, ...byItem.map(r => [
    r.í’ˆëª…, r.ìƒì‚°ìˆ˜ëŸ‰, r.ì–‘í’ˆìˆ˜ëŸ‰, r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,
    ...defectCols.map(dc=>r[dc]), (r.ë¶ˆëŸ‰ë¥ *100).toFixed(2)
  ])];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(itemRows), 'í’ˆëª©ë³„_ì§‘ê³„');

  const totRows = [['ë¶ˆëŸ‰ìœ í˜•','ê±´ìˆ˜'], ...totals.map(t=>[t.ë¶ˆëŸ‰ìœ í˜•, t.ê±´ìˆ˜])];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(totRows), 'ë¶ˆëŸ‰ìœ í˜•ë³„_í•©ê³„');

  XLSX.writeFile(wb, 'ìƒì‚°í˜„í™©_ë¶„ì„_ë¦¬í¬íŠ¸.xlsx');
}

/* ================================================================
   íƒ­ ì „í™˜
   ================================================================ */
/* ================================================================
   íƒ­ ì „í™˜ ê³µí†µ í•¨ìˆ˜ (PC + ëª¨ë°”ì¼ í†µí•©)
   ================================================================ */
function switchTab(tabId) {
  // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™” (PC + ëª¨ë°”ì¼)
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-m-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  // í™œì„±í™”
  document.querySelectorAll(`[data-tab="${tabId}"]`).forEach(b => b.classList.add('active'));
  document.getElementById(tabId).classList.add('active');
  // ëª¨ë°”ì¼: ìƒë‹¨ìœ¼ë¡œ ìŠ¤í¬ë¡¤
  if (isMobile()) {
    window.scrollTo({top: 0, behavior: 'smooth'});
  }
  // Plotly ë¦¬ì‚¬ì´ì¦ˆ (ëª¨ë°”ì¼ì—ì„œ display:noneâ†’block ì „í™˜ í›„ ì¶©ë¶„í•œ ì‹œê°„ í™•ë³´)
  const resizePlots = () => {
    const tab = document.getElementById(tabId);
    if (tab) tab.querySelectorAll('.js-plotly-plot').forEach(p => {
      try { Plotly.Plots.resize(p); } catch(e) {}
    });
  };
  // ì¦‰ì‹œ í•œë²ˆ + ì§€ì—° í›„ í•œë²ˆ ë” (ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë Œë”ë§ ì§€ì—° ëŒ€ì‘)
  requestAnimationFrame(() => {
    resizePlots();
    setTimeout(resizePlots, 300);
  });
}

// PC íƒ­ë°” ì´ë²¤íŠ¸
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});
// ëª¨ë°”ì¼ íƒ­ ê·¸ë¦¬ë“œ ì´ë²¤íŠ¸
document.querySelectorAll('.tab-m-btn').forEach(btn => {
  btn.addEventListener('click', () => switchTab(btn.dataset.tab));
});

/* ë“œë¦´ë‹¤ìš´ ëª¨ë‹¬ ë‹«ê¸° */
$('drillModalClose').addEventListener('click', () => {
  $('drillModal').classList.remove('open');
  document.body.style.overflow = '';
});

/* ================================================================
   í’ˆëª© í•„í„° (ì²´í¬ë°•ìŠ¤ ê²€ìƒ‰ ë°©ì‹ - ëª¨ë°”ì¼ ì¹œí™”)
   ================================================================ */
function setupItemFilter(items) {
  selectedFilterItems.clear();
  const wrap = $('itemFilterWrap');
  let html = `<input type="text" id="itemSearch" placeholder="í’ˆëª© ê²€ìƒ‰..."
    style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px 8px 0 0;
    font-size:14px;min-height:44px;border-bottom:none;">
    <div class="item-filter-actions">
      <button type="button" onclick="document.querySelectorAll('.item-filter-chk').forEach(c=>{if(c.parentElement.style.display!=='none')c.checked=true})">ì „ì²´ ì„ íƒ</button>
      <button type="button" onclick="document.querySelectorAll('.item-filter-chk').forEach(c=>c.checked=false)">ì „ì²´ í•´ì œ</button>
    </div>
    <div id="itemCheckList" style="max-height:180px;overflow-y:auto;border:1px solid var(--border);
    border-radius:0 0 8px 8px;padding:6px 8px;-webkit-overflow-scrolling:touch;">`;

  for (const item of items) {
    const shortName = item.length > 35 ? item.slice(0,35)+'...' : item;
    html += `<label style="display:flex;align-items:center;gap:6px;padding:5px 0;font-weight:400;
      font-size:13px;cursor:pointer;border-bottom:1px solid #f3f4f6">
      <input type="checkbox" class="item-filter-chk" value="${item}"
        style="width:18px;height:18px;flex-shrink:0"> ${shortName}
    </label>`;
  }
  html += `</div>
    <div style="margin-top:4px;font-size:11px;color:var(--text-light)">
      ì„ íƒ ì•ˆí•˜ë©´ ì „ì²´ í’ˆëª© í‘œì‹œ
    </div>`;
  wrap.innerHTML = html;

  // ê²€ìƒ‰
  $('itemSearch').addEventListener('input', e => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.item-filter-chk').forEach(chk => {
      const match = chk.value.toLowerCase().includes(q);
      chk.parentElement.style.display = match ? '' : 'none';
    });
  });
}

/* ================================================================
   ë¶„ì„ ì‹œì‘
   ================================================================ */
$('btnAnalyze').addEventListener('click', runAnalysis);

function runAnalysis() {
  // ëª¨ë°”ì¼ ë¶„ì„ì‹œì‘ í”Œë¡œíŒ… ë²„íŠ¼ ìˆ¨ê¸°ê¸°
  $('mobileAnalyzeFab').classList.remove('show');

  // ìƒˆ íŒŒì¼ì´ ì—…ë¡œë“œëœ ê²½ìš°: ë§¤í•‘ â†’ cleanData
  if (rawData && rawData.length) {
    const stdKeys = ['ìƒì‚°ì¼ì','í’ˆëª…','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰'];
    for (const k of stdKeys) {
      const sel = document.getElementById(`map_${k}`);
      if (sel) mapping[k] = sel.value || undefined;
    }

    const missing = stdKeys.filter(k => !mapping[k]);
    if (missing.length) {
      showToast('í•„ìˆ˜ ì»¬ëŸ¼ì´ ë§¤í•‘ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤: ' + missing.join(', '), 'error', 5000);
      return;
    }

    if (uploadedFiles.length > 1) {
      let allRaw = [...rawData];
      rawData = allRaw;
    }

    cleanedData = cleanData(rawData);
  }

  // cleanedDataê°€ ì—†ìœ¼ë©´ (íŒŒì¼ë„ ì—†ê³  ì €ì¥ ë°ì´í„°ë„ ì—†ìŒ)
  if (!cleanedData || !cleanedData.length) {
    showToast('ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error', 5000);
    return;
  }

  // ë¡œë”© í‘œì‹œ í›„ ë¶„ì„ ì‹¤í–‰ (UI ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•´ ë¹„ë™ê¸°)
  showLoading('ë°ì´í„° ë¶„ì„ ì¤‘...');
  setTimeout(() => {
    try {
      setupFilters();
      applyFilterAndRender();
      showToast('ë¶„ì„ ì™„ë£Œ! ' + cleanedData.length + 'ê±´ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.', 'success');
    } catch(e) {
      showToast('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message, 'error');
    } finally {
      hideLoading();
    }
    if (isMobile()) closeSidebar();
  }, 50);
}

function setupFilters() {
  const dates = cleanedData.map(r => dateStr(r.ìƒì‚°ì¼ì)).sort();
  $('filterStart').value = dates[0];
  $('filterEnd').value = dates[dates.length-1];
  $('filterStart').min = dates[0];
  $('filterStart').max = dates[dates.length-1];
  $('filterEnd').min = dates[0];
  $('filterEnd').max = dates[dates.length-1];
  $('filterDateRange').textContent = `ë°ì´í„° ë²”ìœ„: ${dates[0]} ~ ${dates[dates.length-1]} (${dates.length}ì¼)`;

  const items = [...new Set(cleanedData.map(r => r.í’ˆëª…))].sort();
  setupItemFilter(items);

  $('filterArea').style.display = '';
}

// ë¶ˆëŸ‰ë¥  ì„ê³„ì¹˜: ìŠ¬ë¼ì´ë” â†” ì…ë ¥ í•„ë“œ ì–‘ë°©í–¥ ë™ê¸°í™”
$('filterThreshold').addEventListener('input', e => {
  $('thresholdInput').value = Number(e.target.value).toFixed(1);
});
$('thresholdInput').addEventListener('input', e => {
  let val = Number(e.target.value);
  if (val < 0) val = 0; if (val > 30) val = 30;
  $('filterThreshold').value = val;
});
// ëª©í‘œ ë¶ˆëŸ‰ë¥ : ìŠ¬ë¼ì´ë” â†” ì…ë ¥ í•„ë“œ ì–‘ë°©í–¥ ë™ê¸°í™”
$('targetDefectRate').value = targetDefectRate;
$('targetDefectInput').value = targetDefectRate.toFixed(1);
$('targetDefectRate').addEventListener('input', e => {
  const val = Number(e.target.value);
  $('targetDefectInput').value = val.toFixed(1);
  targetDefectRate = val;
  saveTargetDefectRate(val);
});
$('targetDefectInput').addEventListener('input', e => {
  let val = Number(e.target.value);
  if (val < 0.1) val = 0.1; if (val > 5) val = 5;
  $('targetDefectRate').value = val;
  targetDefectRate = val;
  saveTargetDefectRate(val);
});
$('btnApplyFilter').addEventListener('click', () => {
  applyFilterAndRender();
  if (isMobile()) closeSidebar();
});

function applyFilterAndRender() {
  const start = $('filterStart').value;
  const end = $('filterEnd').value;
  const threshold = Number($('filterThreshold').value);

  // ì²´í¬ë°•ìŠ¤ì—ì„œ ì„ íƒëœ í’ˆëª©
  const checkedItems = Array.from(document.querySelectorAll('.item-filter-chk:checked')).map(c => c.value);

  let filtered = cleanedData.filter(r => {
    const d = dateStr(r.ìƒì‚°ì¼ì);
    return d >= start && d <= end;
  });
  if (checkedItems.length) {
    filtered = filtered.filter(r => checkedItems.includes(r.í’ˆëª…));
  }

  if (!filtered.length) {
    showToast('í•„í„° ì¡°ê±´ì— ë§ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'warn', 4000);
    return;
  }

  const kpi = calcKPI(filtered);
  const byDate = aggByDate(filtered);
  const byItem = aggByItem(filtered);
  const totals = aggDefectTotals(filtered);
  const alerts = byItem.filter(r => r.ë¶ˆëŸ‰ë¥  > threshold/100)
    .sort((a,b) => b.ë¶ˆëŸ‰ë¥  - a.ë¶ˆëŸ‰ë¥ );

  renderDashboard(kpi, byDate, byItem, totals, alerts, threshold, filtered);

  // localStorageì— ë§ˆì§€ë§‰ ë¶„ì„ ê²°ê³¼ ì €ì¥ (filtered ì›ë³¸ í¬í•¨)
  try {
    const saveData = {
      timestamp: new Date().toISOString(),
      kpi, byDate, byItem, totals, alerts, threshold,
      filtered: filtered,
      defectColsSaved: defectCols,
      filterStart: start, filterEnd: end
    };
    localStorage.setItem('ndm_lastAnalysis', JSON.stringify(saveData));
  } catch(e) {
    // ìš©ëŸ‰ ì´ˆê³¼ ì‹œ filtered ì—†ì´ ì¬ì‹œë„
    try {
      const saveData = {
        timestamp: new Date().toISOString(),
        kpi, byDate, byItem, totals, alerts, threshold,
        defectColsSaved: defectCols,
        filterStart: start, filterEnd: end
      };
      localStorage.setItem('ndm_lastAnalysis', JSON.stringify(saveData));
    } catch(e2) { /* ê·¸ë˜ë„ ì‹¤íŒ¨í•˜ë©´ ë¬´ì‹œ */ }
  }
}

/* ================================================================
   Phase 1: ì´ë™í‰ê·  ê³„ì‚°
   ================================================================ */
function movingAvg(arr, key, window) {
  return arr.map((_, i) => {
    const start = Math.max(0, i - window + 1);
    const slice = arr.slice(start, i + 1);
    return slice.reduce((s, r) => s + r[key], 0) / slice.length;
  });
}

/* Phase 1: ì¶”ì„¸ ë¶„ì„ ì°¨íŠ¸ (ì´ë™í‰ê·  í¬í•¨) */
function chartTrendMA(byDate, el) {
  const dates = byDate.map(r => dateKR(r.ìƒì‚°ì¼ì));
  const rates = byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  const ma7 = movingAvg(byDate, 'ë¶ˆëŸ‰ë¥ ', 7).map(v => v * 100);
  const ma14 = movingAvg(byDate, 'ë¶ˆëŸ‰ë¥ ', 14).map(v => v * 100);
  const mb = isMobile();
  Plotly.newPlot(el, [
    { x: dates, y: rates, type:'scatter', mode:'markers', name:'ì¼ë³„ ë¶ˆëŸ‰ë¥ ', marker:{color:'#94A3B8',size:mb?4:6} },
    { x: dates, y: ma7, type:'scatter', mode:'lines', name:'7ì¼ ì´ë™í‰ê· ', line:{color:'#2563EB',width:2.5} },
    { x: dates, y: ma14, type:'scatter', mode:'lines', name:'14ì¼ ì´ë™í‰ê· ', line:{color:'#DC2626',width:2,dash:'dash'} }
  ], {
    yaxis:{title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)'}, legend:{orientation:'h',y:mb?1.18:1.12,font:{size:mb?10:12}},
    height: chartHeight(400,300), margin: mb?{t:30,b:40,l:40,r:20}:{t:30,b:50,l:60,r:40}
  }, getPlotCfg());
}

/* Phase 1: ì „ì£¼ ëŒ€ë¹„ ì¦ê° KPI */
function calcWeekChange(data) {
  if (!data || !data.length) return { ê¸ˆì£¼: 0, ì „ì£¼: 0, ë³€í™”: 0 };
  const today = data[data.length-1].ìƒì‚°ì¼ì;
  const todayMs = toDate(today).getTime();
  const week1 = data.filter(r => { const diff = (todayMs - toDate(r.ìƒì‚°ì¼ì).getTime())/86400000; return diff >= 0 && diff < 7; });
  const week2 = data.filter(r => { const diff = (todayMs - toDate(r.ìƒì‚°ì¼ì).getTime())/86400000; return diff >= 7 && diff < 14; });
  const r1 = week1.length ? week1.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0)/week1.reduce((s,r)=>s+r.ìƒì‚°ìˆ˜ëŸ‰,0)*100 : 0;
  const r2 = week2.length ? week2.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0)/week2.reduce((s,r)=>s+r.ìƒì‚°ìˆ˜ëŸ‰,0)*100 : 0;
  return { ê¸ˆì£¼: r1, ì „ì£¼: r2, ë³€í™”: r1 - r2 };
}

/* Phase 1: ì£¼ê°„/ì›”ê°„ ì§‘ê³„ */
function aggByWeek(data) {
  const map = new Map();
  for (const r of data) {
    const key = weekLabel(dateStr(r.ìƒì‚°ì¼ì));
    if (!map.has(key)) { const o={ìƒì‚°ì¼ì:key,ìƒì‚°ìˆ˜ëŸ‰:0,ì–‘í’ˆìˆ˜ëŸ‰:0,ë¶ˆëŸ‰ìˆ˜ëŸ‰:0}; for(const dc of defectCols) o[dc]=0; map.set(key,o); }
    const o=map.get(key); o.ìƒì‚°ìˆ˜ëŸ‰+=r.ìƒì‚°ìˆ˜ëŸ‰; o.ì–‘í’ˆìˆ˜ëŸ‰+=r.ì–‘í’ˆìˆ˜ëŸ‰; o.ë¶ˆëŸ‰ìˆ˜ëŸ‰+=r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    for(const dc of defectCols) o[dc]+=r[dc];
  }
  const arr=[...map.values()]; arr.forEach(o=>o.ë¶ˆëŸ‰ë¥ =o.ìƒì‚°ìˆ˜ëŸ‰?o.ë¶ˆëŸ‰ìˆ˜ëŸ‰/o.ìƒì‚°ìˆ˜ëŸ‰:0); return arr;
}

function aggByMonth(data) {
  const map = new Map();
  for (const r of data) {
    const key = dateStr(r.ìƒì‚°ì¼ì).slice(0,7);
    if (!map.has(key)) { const o={ìƒì‚°ì¼ì:key,ìƒì‚°ìˆ˜ëŸ‰:0,ì–‘í’ˆìˆ˜ëŸ‰:0,ë¶ˆëŸ‰ìˆ˜ëŸ‰:0}; for(const dc of defectCols) o[dc]=0; map.set(key,o); }
    const o=map.get(key); o.ìƒì‚°ìˆ˜ëŸ‰+=r.ìƒì‚°ìˆ˜ëŸ‰; o.ì–‘í’ˆìˆ˜ëŸ‰+=r.ì–‘í’ˆìˆ˜ëŸ‰; o.ë¶ˆëŸ‰ìˆ˜ëŸ‰+=r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    for(const dc of defectCols) o[dc]+=r[dc];
  }
  const arr=[...map.values()].sort((a,b)=>a.ìƒì‚°ì¼ì.localeCompare(b.ìƒì‚°ì¼ì));
  arr.forEach(o=>o.ë¶ˆëŸ‰ë¥ =o.ìƒì‚°ìˆ˜ëŸ‰?o.ë¶ˆëŸ‰ìˆ˜ëŸ‰/o.ìƒì‚°ìˆ˜ëŸ‰:0); return arr;
}

/* ================================================================
   Phase 1: p ê´€ë¦¬ë„ (P-Chart)
   - CL = pÌ„ = ì´ë¶ˆëŸ‰ìˆ˜ / ì´ê²€ì‚¬ìˆ˜
   - UCLáµ¢ = pÌ„ + 3âˆš(pÌ„(1-pÌ„)/náµ¢)  (ì„œë¸Œê·¸ë£¹ë³„ ê²€ì‚¬ìˆ˜ náµ¢ ë°˜ì˜)
   - LCLáµ¢ = max(0, pÌ„ - 3âˆš(pÌ„(1-pÌ„)/náµ¢))
   ================================================================ */
function chartSPC(byDate, el) {
  const n = byDate.length;
  if (n < 3) { el.innerHTML = '<p>ë°ì´í„°ê°€ 3ì¼ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤.</p>'; return; }

  // pÌ„ (ì „ì²´ í‰ê·  ë¶ˆëŸ‰ë¥ )
  const totalBad = byDate.reduce((s,r) => s + r.ë¶ˆëŸ‰ìˆ˜ëŸ‰, 0);
  const totalProd = byDate.reduce((s,r) => s + r.ìƒì‚°ìˆ˜ëŸ‰, 0);
  const pBar = totalProd ? totalBad / totalProd : 0;
  const pBarPct = pBar * 100;

  // ê° ì„œë¸Œê·¸ë£¹(ì¼ì)ë³„ UCL, LCL ê³„ì‚° (náµ¢ì— ë”°ë¼ ë³€ë™)
  const rates = byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  const uclArr = byDate.map(r => {
    const ni = r.ìƒì‚°ìˆ˜ëŸ‰;
    return ni > 0 ? (pBar + 3 * Math.sqrt(pBar * (1 - pBar) / ni)) * 100 : pBarPct;
  });
  const lclArr = byDate.map(r => {
    const ni = r.ìƒì‚°ìˆ˜ëŸ‰;
    return ni > 0 ? Math.max(0, (pBar - 3 * Math.sqrt(pBar * (1 - pBar) / ni)) * 100) : 0;
  });

  const dates = byDate.map(r => dateKR(r.ìƒì‚°ì¼ì));
  const mb = isMobile();

  // ì´ìƒì  ê°ì§€ (ê´€ë¦¬í•œê³„ ì´íƒˆ)
  const outIdx = rates.map((v,i) => (v > uclArr[i] || v < lclArr[i]) ? i : -1).filter(i => i >= 0);

  // ì—°ì† ê·œì¹™: 7ì—°ì† ìƒìŠ¹/í•˜ê°•, ì¤‘ì‹¬ì„  í•œìª½ ì—°ì† 8ì 
  const ruleBreaks = new Set();
  for (let i = 6; i < n; i++) {
    let up = true, dn = true;
    for (let j = i - 5; j <= i; j++) { if (rates[j] <= rates[j-1]) up = false; if (rates[j] >= rates[j-1]) dn = false; }
    if (up || dn) ruleBreaks.add(i);
  }
  for (let i = 7; i < n; i++) {
    const above = rates.slice(i-7, i+1).every(v => v > pBarPct);
    const below = rates.slice(i-7, i+1).every(v => v < pBarPct);
    if (above || below) for (let j = i-7; j <= i; j++) ruleBreaks.add(j);
  }

  const colors = rates.map((v,i) => outIdx.includes(i) ? '#DC2626' : ruleBreaks.has(i) ? '#F59E0B' : '#2563EB');

  Plotly.newPlot(el, [
    { x: dates, y: rates, type: 'scatter', mode: 'lines+markers', name: 'p (ë¶ˆëŸ‰ë¥ )',
      marker: {color: colors, size: mb ? 6 : 8, line: {width: 1, color: 'white'}}, line: {color: '#2563EB', width: 1.5} },
    { x: dates, y: uclArr, type: 'scatter', mode: 'lines', name: 'UCL',
      line: {color: '#DC2626', width: 2, dash: 'dash'}, hovertemplate: 'UCL: %{y:.2f}%<extra></extra>' },
    { x: dates, y: Array(n).fill(pBarPct), type: 'scatter', mode: 'lines', name: 'CL (pÌ„ = ' + pct(pBarPct) + ')',
      line: {color: '#16A34A', width: 2.5} },
    { x: dates, y: lclArr, type: 'scatter', mode: 'lines', name: 'LCL',
      line: {color: '#F59E0B', width: 2, dash: 'dash'}, hovertemplate: 'LCL: %{y:.2f}%<extra></extra>' },
    // UCL~LCL ì‚¬ì´ ì˜ì—­ ì‹œê°í™” (ê´€ë¦¬ ë²”ìœ„)
    { x: dates.concat([...dates].reverse()), y: uclArr.concat([...lclArr].reverse()), type: 'scatter',
      fill: 'toself', fillcolor: 'rgba(37,99,235,0.06)', line: {color: 'transparent'}, showlegend: false, hoverinfo: 'skip' }
  ], {
    title: mb ? '' : 'p ê´€ë¦¬ë„ (ë¶ˆëŸ‰ë¥ )',
    yaxis: {title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)'},
    legend: {orientation: 'h', y: mb ? 1.22 : 1.14, font: {size: mb ? 9 : 12}},
    height: chartHeight(450, 340),
    margin: mb ? {t: 30, b: 40, l: 40, r: 20} : {t: 60, b: 50, l: 60, r: 40},
    annotations: outIdx.slice(0, 8).map(i => ({
      x: dates[i], y: rates[i], text: dateKR(byDate[i].ìƒì‚°ì¼ì) + '<br>' + pct(rates[i]),
      showarrow: true, arrowhead: 2, ax: 0, ay: -35,
      font: {color: '#DC2626', size: mb ? 8 : 10}, bgcolor: 'rgba(254,226,226,0.85)', borderpad: 3
    }))
  }, getPlotCfg());

  // p ê´€ë¦¬ë„ í•˜ë‹¨ì— ì„œë¸Œê·¸ë£¹ í¬ê¸°(náµ¢) ì°¨íŠ¸ ì¶”ê°€
  const niEl = document.createElement('div');
  niEl.style.marginTop = '8px';
  if (!el.parentElement) return;
  el.parentElement.appendChild(niEl);
  Plotly.newPlot(niEl, [{
    x: dates, y: byDate.map(r => r.ìƒì‚°ìˆ˜ëŸ‰), type: 'bar', name: 'ì„œë¸Œê·¸ë£¹ í¬ê¸° (náµ¢)',
    marker: {color: '#94A3B8', opacity: 0.7},
    hovertemplate: '%{x}<br>ê²€ì‚¬ìˆ˜: %{y:,}<extra></extra>'
  }], {
    title: mb ? '' : 'ì„œë¸Œê·¸ë£¹ í¬ê¸° (ì¼ìë³„ ìƒì‚°ìˆ˜ëŸ‰)',
    yaxis: {title: mb ? '' : 'ê²€ì‚¬ìˆ˜ (náµ¢)'},
    height: chartHeight(200, 150),
    margin: mb ? {t: 20, b: 30, l: 40, r: 20} : {t: 40, b: 40, l: 60, r: 40}
  }, getPlotCfg());
}

/* ================================================================
   Phase 1: ìˆ˜ìœ¨ ë¶„ì„
   ================================================================ */
function chartYieldGauge(kpi, el) {
  const yieldRate = kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ ? (kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰/kpi.ì´ìƒì‚°ìˆ˜ëŸ‰*100) : 0;
  Plotly.newPlot(el, [{
    type:'indicator', mode:'gauge+number+delta',
    value: yieldRate, number:{suffix:'%',font:{size:42}},
    title:{text:'ì „ì²´ ìˆ˜ìœ¨',font:{size:16}},
    gauge:{
      axis:{range:[80,100],ticksuffix:'%'},
      bar:{color:'#2563EB'},
      steps:[{range:[80,90],color:'#FEE2E2'},{range:[90,95],color:'#FEF3C7'},{range:[95,100],color:'#D1FAE5'}],
      threshold:{line:{color:'#DC2626',width:3},thickness:.75,value:98}
    }
  }], {height:280,margin:{t:40,b:20,l:30,r:30}}, getPlotCfg());
}

function chartYieldByItem(byItem, el) {
  if (!byItem || !byItem.length) { el.innerHTML='<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const sorted = [...byItem].sort((a,b)=>(a.ì–‘í’ˆìˆ˜ëŸ‰/a.ìƒì‚°ìˆ˜ëŸ‰)-(b.ì–‘í’ˆìˆ˜ëŸ‰/b.ìƒì‚°ìˆ˜ëŸ‰)).slice(0,20);
  const mb=isMobile();
  const labels=sorted.map(r=>r.í’ˆëª….length>(mb?18:30)?r.í’ˆëª….slice(0,mb?18:30)+'...':r.í’ˆëª…);
  const yields=sorted.map(r=>r.ìƒì‚°ìˆ˜ëŸ‰?r.ì–‘í’ˆìˆ˜ëŸ‰/r.ìƒì‚°ìˆ˜ëŸ‰*100:0);
  const yieldMin = yields.length ? Math.min(...yields) : 0;
  const colors=yields.map(v=>v>=98?'#16A34A':v>=95?'#F59E0B':'#DC2626');
  Plotly.newPlot(el,[{
    y:labels,x:yields,type:'bar',orientation:'h',marker:{color:colors},
    text:yields.map(v=>pct(v,1)),textposition:'outside',textfont:{size:mb?9:11}
  }],{
    title:mb?'':'í’ˆëª©ë³„ ìˆ˜ìœ¨ í•˜ìœ„ 20',xaxis:{title:mb?'':'ìˆ˜ìœ¨ (%)',range:[Math.max(0,yieldMin-5),101]},
    shapes:[{type:'line',x0:98,x1:98,y0:0,y1:1,yref:'paper',line:{dash:'dash',color:'#DC2626',width:2}}],
    height:Math.max(mb?350:450,sorted.length*(mb?25:30)+80),
    margin:mb?{l:140,r:60,t:20,b:30}:{l:240,r:80,t:50,b:40}
  },getPlotCfg());
}

function chartYieldTrend(byDate, el) {
  if (!byDate || !byDate.length) { el.innerHTML='<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const dates=byDate.map(r=>dateKR(r.ìƒì‚°ì¼ì));
  const yields=byDate.map(r=>r.ìƒì‚°ìˆ˜ëŸ‰?r.ì–‘í’ˆìˆ˜ëŸ‰/r.ìƒì‚°ìˆ˜ëŸ‰*100:0);
  const yieldMin = yields.length ? Math.min(...yields) : 0;
  const mb=isMobile();
  Plotly.newPlot(el,[
    {x:dates,y:yields,type:'scatter',mode:'lines+markers',name:'ì¼ë³„ ìˆ˜ìœ¨',
      line:{color:'#16A34A',width:2},marker:{size:mb?4:6}},
    {x:[dates[0],dates[dates.length-1]],y:[98,98],type:'scatter',mode:'lines',name:'ëª©í‘œ 98%',
      line:{color:'#DC2626',width:2,dash:'dash'}}
  ],{
    title:mb?'':'ì¼ìë³„ ìˆ˜ìœ¨ ì¶”ì´',yaxis:{title:mb?'':'ìˆ˜ìœ¨ (%)',range:[Math.max(0,yieldMin-3),101]},
    legend:{orientation:'h',y:mb?1.15:1.12,font:{size:mb?10:12}},
    height:chartHeight(380,280),margin:mb?{t:30,b:40,l:40,r:20}:{t:60,b:50,l:60,r:40}
  },getPlotCfg());
}

/* ================================================================
   Phase 1-B: ì¶”ê°€ ì°¨íŠ¸ í•¨ìˆ˜ (ìš”ì¼ë³„ íŒ¨í„´ / ìˆ˜ìœ¨ ëª©í‘œ / ìˆ˜ìœ¨ ë¶„í¬)
   ================================================================ */
function chartWeekdayPattern(byDate, el) {
  if (!byDate || !byDate.length) { el.innerHTML='<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const dayData = {}; // {0:[],1:[],...6:[]}
  byDate.forEach(r => {
    const d = new Date(r.ìƒì‚°ì¼ì).getDay();
    if (!dayData[d]) dayData[d] = [];
    dayData[d].push(r.ë¶ˆëŸ‰ë¥  * 100);
  });
  const labels = [], avgs = [], counts = [], colors = [];
  for (let i = 1; i <= 5; i++) { // ì›”~ê¸ˆ
    labels.push(dayNames[i] + 'ìš”ì¼');
    const arr = dayData[i] || [];
    const avg = arr.length ? arr.reduce((s,v) => s+v, 0) / arr.length : 0;
    avgs.push(+avg.toFixed(2));
    counts.push(arr.length);
  }
  // í† /ì¼ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì¶”ê°€
  [6, 0].forEach(i => {
    if (dayData[i] && dayData[i].length) {
      labels.push(dayNames[i] + 'ìš”ì¼');
      const arr = dayData[i];
      avgs.push(+(arr.reduce((s,v) => s+v, 0) / arr.length).toFixed(2));
      counts.push(arr.length);
    }
  });
  const maxAvg = Math.max(...avgs);
  avgs.forEach(v => colors.push(v >= maxAvg * 0.9 ? '#DC2626' : v >= maxAvg * 0.7 ? '#F59E0B' : '#16A34A'));
  const mb = isMobile();
  Plotly.newPlot(el, [{
    x: labels, y: avgs, type: 'bar',
    marker: { color: colors, opacity: 0.85 },
    text: avgs.map((v, i) => `${pct(v,2)} (${counts[i]}ì¼)`),
    textposition: 'outside', textfont: { size: mb ? 10 : 12 },
    hovertemplate: '<b>%{x}</b><br>í‰ê·  ë¶ˆëŸ‰ë¥ : %{y:.2f}%<br>ë°ì´í„° ìˆ˜: %{text}<extra></extra>'
  }], {
    yaxis: { title: mb ? '' : 'í‰ê·  ë¶ˆëŸ‰ë¥  (%)', rangemode: 'tozero' },
    height: chartHeight(350, 260),
    margin: mb ? { t: 20, b: 40, l: 40, r: 20 } : { t: 30, b: 50, l: 60, r: 40 },
    annotations: [{
      text: 'ğŸ”´ ê°€ì¥ ë†’ì€ ìš”ì¼ì— ì£¼ëª©í•˜ì„¸ìš”',
      xref: 'paper', yref: 'paper', x: 1, y: 1.05,
      showarrow: false, font: { size: 11, color: '#6B7280' }
    }]
  }, getPlotCfg());
}

function chartWeekdayScatter(byDate, el) {
  if (!byDate || !byDate.length) { el.innerHTML='<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const prods = byDate.map(r => r.ìƒì‚°ìˆ˜ëŸ‰);
  const rates = byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  const texts = byDate.map(r => dateKR(r.ìƒì‚°ì¼ì));
  const mb = isMobile();
  // ìƒê´€ê³„ìˆ˜ ê³„ì‚°
  const n = prods.length;
  const avgP = prods.reduce((s,v) => s+v, 0) / n;
  const avgR = rates.reduce((s,v) => s+v, 0) / n;
  let num = 0, denP = 0, denR = 0;
  for (let i = 0; i < n; i++) {
    num += (prods[i] - avgP) * (rates[i] - avgR);
    denP += (prods[i] - avgP) ** 2;
    denR += (rates[i] - avgR) ** 2;
  }
  const corr = (denP && denR) ? (num / Math.sqrt(denP * denR)) : 0;
  const corrText = corr > 0.5 ? 'ê°•í•œ ì–‘ì˜ ìƒê´€ (ê³¼ë¶€í•˜ ê°€ëŠ¥ì„±)' : corr > 0.2 ? 'ì•½í•œ ì–‘ì˜ ìƒê´€' : corr < -0.2 ? 'ìŒì˜ ìƒê´€' : 'ìƒê´€ ì—†ìŒ';

  Plotly.newPlot(el, [{
    x: prods, y: rates, type: 'scatter', mode: 'markers',
    marker: { size: mb ? 6 : 9, color: rates, colorscale: 'RdYlGn', reversescale: true, showscale: !mb,
      colorbar: { title: 'ë¶ˆëŸ‰ë¥ %', thickness: 12 } },
    text: texts, hovertemplate: '<b>%{text}</b><br>ìƒì‚°: %{x:,}ê°œ<br>ë¶ˆëŸ‰ë¥ : %{y:.2f}%<extra></extra>'
  }], {
    xaxis: { title: mb ? '' : 'ì¼ë³„ ìƒì‚°ìˆ˜ëŸ‰' },
    yaxis: { title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)' },
    height: chartHeight(350, 260),
    margin: mb ? { t: 30, b: 40, l: 40, r: 20 } : { t: 40, b: 50, l: 60, r: 60 },
    annotations: [{
      text: `ìƒê´€ê³„ìˆ˜: ${corr.toFixed(3)} â†’ ${corrText}`,
      xref: 'paper', yref: 'paper', x: 0.5, y: 1.08,
      showarrow: false, font: { size: mb ? 10 : 12, color: Math.abs(corr) > 0.3 ? '#DC2626' : '#6B7280' }
    }]
  }, getPlotCfg());
}

function renderYieldTarget(byItem, kpi, el) {
  if (!byItem || !byItem.length) return;
  const target = 98;
  const passItems = byItem.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ && (r.ì–‘í’ˆìˆ˜ëŸ‰ / r.ìƒì‚°ìˆ˜ëŸ‰ * 100) >= target);
  const failItems = byItem.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ && (r.ì–‘í’ˆìˆ˜ëŸ‰ / r.ìƒì‚°ìˆ˜ëŸ‰ * 100) < target);
  const totalItems = byItem.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ > 0);
  const achieveRate = totalItems.length ? (passItems.length / totalItems.length * 100).toFixed(1) : 0;
  el.innerHTML = `<div class="yield-target-summary">
    <div class="yield-target-card pass">
      <div class="ytc-label">ëª©í‘œ ë‹¬ì„± í’ˆëª©</div>
      <div class="ytc-value">${passItems.length}ê°œ</div>
      <div class="ytc-sub">ìˆ˜ìœ¨ ${target}% ì´ìƒ</div>
    </div>
    <div class="yield-target-card fail">
      <div class="ytc-label">ëª©í‘œ ë¯¸ë‹¬ í’ˆëª©</div>
      <div class="ytc-value">${failItems.length}ê°œ</div>
      <div class="ytc-sub">ìˆ˜ìœ¨ ${target}% ë¯¸ë§Œ</div>
    </div>
    <div class="yield-target-card total">
      <div class="ytc-label">ëª©í‘œ ë‹¬ì„±ë¥ </div>
      <div class="ytc-value">${achieveRate}%</div>
      <div class="ytc-sub">ì „ì²´ ${totalItems.length}ê°œ í’ˆëª© ì¤‘</div>
    </div>
  </div>`;
}

function chartYieldDistribution(byItem, el) {
  if (!byItem || !byItem.length) { el.innerHTML='<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const yields = byItem.filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ > 0).map(r => r.ì–‘í’ˆìˆ˜ëŸ‰ / r.ìƒì‚°ìˆ˜ëŸ‰ * 100);
  const bins = [
    { label: '90% ë¯¸ë§Œ', min: 0, max: 90, color: '#DC2626', count: 0 },
    { label: '90~95%', min: 90, max: 95, color: '#F59E0B', count: 0 },
    { label: '95~98%', min: 95, max: 98, color: '#3B82F6', count: 0 },
    { label: '98~100%', min: 98, max: 100.01, color: '#16A34A', count: 0 }
  ];
  yields.forEach(v => {
    for (const b of bins) { if (v >= b.min && v < b.max) { b.count++; break; } }
  });
  const mb = isMobile();
  Plotly.newPlot(el, [{
    x: bins.map(b => b.label),
    y: bins.map(b => b.count),
    type: 'bar',
    marker: { color: bins.map(b => b.color), opacity: 0.85 },
    text: bins.map(b => `${b.count}ê°œ (${(b.count / yields.length * 100).toFixed(1)}%)`),
    textposition: 'outside',
    textfont: { size: mb ? 10 : 12 },
    hovertemplate: '<b>%{x}</b><br>í’ˆëª© ìˆ˜: %{y}ê°œ<br>%{text}<extra></extra>'
  }], {
    yaxis: { title: mb ? '' : 'í’ˆëª© ìˆ˜', dtick: Math.max(1, Math.ceil(Math.max(...bins.map(b => b.count)) / 5)) },
    height: chartHeight(350, 260),
    margin: mb ? { t: 20, b: 50, l: 35, r: 20 } : { t: 30, b: 50, l: 60, r: 40 }
  }, getPlotCfg());
}

function getItemTrendBadge(itemName, filtered) {
  if (!filtered || !filtered.length) return { cls: 'stable', text: 'â”€ ë°ì´í„° ë¶€ì¡±' };
  const rows = filtered.filter(r => r.í’ˆëª… === itemName).sort((a,b) => new Date(a.ìƒì‚°ì¼ì) - new Date(b.ìƒì‚°ì¼ì));
  if (rows.length < 4) return { cls: 'stable', text: 'â”€ ë°ì´í„° ë¶€ì¡±' };
  const mid = Math.floor(rows.length / 2);
  const firstHalf = rows.slice(0, mid);
  const secondHalf = rows.slice(mid);
  const avgFirst = firstHalf.reduce((s,r) => s + (r.ë¶ˆëŸ‰ìˆ˜ëŸ‰ / r.ìƒì‚°ìˆ˜ëŸ‰), 0) / firstHalf.length * 100;
  const avgSecond = secondHalf.reduce((s,r) => s + (r.ë¶ˆëŸ‰ìˆ˜ëŸ‰ / r.ìƒì‚°ìˆ˜ëŸ‰), 0) / secondHalf.length * 100;
  const diff = avgSecond - avgFirst;
  if (diff > 0.5) return { cls: 'up', text: `â–² ì•…í™” +${diff.toFixed(1)}%p` };
  if (diff < -0.5) return { cls: 'down', text: `â–¼ ê°œì„  ${diff.toFixed(1)}%p` };
  return { cls: 'stable', text: 'â”€ ì•ˆì •' };
}

/* ================================================================
   Phase 2: ê¸°ê°„ ë¹„êµ
   ================================================================ */
function renderPeriodComparison(data, el) {
  if (!data || !data.length) {
    el.innerHTML = '<div class="chart-box"><h3>ê¸°ê°„ ë¹„êµ ë¶„ì„</h3><p style="color:var(--text-light);padding:20px">ì›ë³¸ ë°ì´í„°ê°€ í•„ìš”í•©ë‹ˆë‹¤. ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ê°„ ë¹„êµê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p></div>';
    return;
  }
  const dates=data.map(r=>dateStr(r.ìƒì‚°ì¼ì)).sort();
  const minD=dates[0], maxD=dates[dates.length-1];
  const mid=dates[Math.floor(dates.length/2)];
  el.innerHTML=`
    <div class="chart-box"><h3>ê¸°ê°„ ë¹„êµ ë¶„ì„</h3>
    <div class="cmp-periods" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px;">
      <div style="flex:1;min-width:200px">
        <label style="font-size:13px;font-weight:600">ê¸°ê°„ A (ì´ì „)</label>
        <input type="date" id="cmpA1" value="${minD}" min="${minD}" max="${maxD}" style="width:48%;display:inline-block">
        <input type="date" id="cmpA2" value="${mid}" min="${minD}" max="${maxD}" style="width:48%;display:inline-block">
      </div>
      <div style="flex:1;min-width:200px">
        <label style="font-size:13px;font-weight:600">ê¸°ê°„ B (ì´í›„)</label>
        <input type="date" id="cmpB1" value="${mid}" min="${minD}" max="${maxD}" style="width:48%;display:inline-block">
        <input type="date" id="cmpB2" value="${maxD}" min="${minD}" max="${maxD}" style="width:48%;display:inline-block">
      </div>
      <button class="btn btn-primary btn-sm" id="btnCompare">ë¹„êµ ì‹¤í–‰</button>
    </div>
    <div id="cmpResult"></div></div>`;
  $('btnCompare').addEventListener('click',()=>runComparison(data));
}

function runComparison(data) {
  const a1=$('cmpA1').value,a2=$('cmpA2').value,b1=$('cmpB1').value,b2=$('cmpB2').value;
  const grpA=data.filter(r=>{const d=dateStr(r.ìƒì‚°ì¼ì);return d>=a1&&d<=a2;});
  const grpB=data.filter(r=>{const d=dateStr(r.ìƒì‚°ì¼ì);return d>=b1&&d<=b2;});
  if(!grpA.length||!grpB.length){$('cmpResult').innerHTML='<div class="info-box warn">ë‘ ê¸°ê°„ ëª¨ë‘ ë°ì´í„°ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</div>';return;}
  const kA=calcKPI(grpA),kB=calcKPI(grpB);
  const items=[
    {label:'ìƒì‚°ìˆ˜ëŸ‰',a:kA.ì´ìƒì‚°ìˆ˜ëŸ‰,b:kB.ì´ìƒì‚°ìˆ˜ëŸ‰,fmt:fmt},
    {label:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',a:kA.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰,b:kB.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰,fmt:fmt},
    {label:'ë¶ˆëŸ‰ë¥ (%)',a:kA.ë¶ˆëŸ‰ë¥ ,b:kB.ë¶ˆëŸ‰ë¥ ,fmt:v=>pct(v)},
  ];
  let html='<div class="kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px">';
  for(const it of items){
    const diff=it.b-it.a;
    const arrow=it.label.includes('ë¶ˆëŸ‰')?(diff>0?'â–² ì•…í™”':'â–¼ ê°œì„ '):(diff>0?'â–² ì¦ê°€':'â–¼ ê°ì†Œ');
    const color=it.label.includes('ë¶ˆëŸ‰')?(diff>0?'var(--danger)':'var(--success)'):(diff>0?'var(--success)':'var(--warning)');
    html+=`<div class="kpi-card"><div class="label">${it.label}</div>
      <div style="font-size:13px;color:var(--text-light)">A: ${it.fmt(it.a)}</div>
      <div style="font-size:13px;color:var(--text-light)">B: ${it.fmt(it.b)}</div>
      <div class="value" style="font-size:16px;color:${color}">${arrow} ${it.label.includes('ë¥ ')?pct(Math.abs(diff)):fmt(Math.abs(diff))}</div></div>`;
  }
  html+='</div>';

  // í’ˆëª©ë³„ ë³€í™”
  const itemA=aggByItem(grpA),itemB=aggByItem(grpB);
  const itemMap=new Map();
  itemA.forEach(r=>itemMap.set(r.í’ˆëª…,{a:r.ë¶ˆëŸ‰ë¥ *100,b:0,aProd:r.ìƒì‚°ìˆ˜ëŸ‰,bProd:0,aDef:r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,bDef:0}));
  itemB.forEach(r=>{
    if(itemMap.has(r.í’ˆëª…)){const m=itemMap.get(r.í’ˆëª…);m.b=r.ë¶ˆëŸ‰ë¥ *100;m.bProd=r.ìƒì‚°ìˆ˜ëŸ‰;m.bDef=r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;}
    else itemMap.set(r.í’ˆëª…,{a:0,b:r.ë¶ˆëŸ‰ë¥ *100,aProd:0,bProd:r.ìƒì‚°ìˆ˜ëŸ‰,aDef:0,bDef:r.ë¶ˆëŸ‰ìˆ˜ëŸ‰});
  });
  const changes=[...itemMap.entries()].map(([k,v])=>({í’ˆëª…:k,...v,ë³€í™”:v.b-v.a})).sort((a,b)=>a.ë³€í™”-b.ë³€í™”);
  const top5=changes.slice(0,5),worst5=changes.slice(-5).reverse();

  // â”€â”€ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ë¶„ì„ â”€â”€
  const diffRate = kB.ë¶ˆëŸ‰ë¥  - kA.ë¶ˆëŸ‰ë¥ ;
  const diffProd = kB.ì´ìƒì‚°ìˆ˜ëŸ‰ - kA.ì´ìƒì‚°ìˆ˜ëŸ‰;
  const diffDef = kB.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰ - kA.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰;
  const yieldA = kA.ì´ìƒì‚°ìˆ˜ëŸ‰ ? (kA.ì´ì–‘í’ˆìˆ˜ëŸ‰ / kA.ì´ìƒì‚°ìˆ˜ëŸ‰ * 100) : 0;
  const yieldB = kB.ì´ìƒì‚°ìˆ˜ëŸ‰ ? (kB.ì´ì–‘í’ˆìˆ˜ëŸ‰ / kB.ì´ìƒì‚°ìˆ˜ëŸ‰ * 100) : 0;
  const diffYield = yieldB - yieldA;
  const improvedItems = changes.filter(r => r.ë³€í™” < -0.1).length;
  const worsenedItems = changes.filter(r => r.ë³€í™” > 0.1).length;
  const stableItems = changes.length - improvedItems - worsenedItems;
  const newInB = changes.filter(r => r.a === 0 && r.b > 0);
  const removedInB = changes.filter(r => r.a > 0 && r.b === 0);

  // ë¶ˆëŸ‰ìœ í˜•ë³„ ë¹„êµ
  let defectTypeInsight = '';
  if (defectCols.length) {
    const dtA = {}, dtB = {};
    defectCols.forEach(dc => { dtA[dc] = grpA.reduce((s,r) => s + (r[dc]||0), 0); dtB[dc] = grpB.reduce((s,r) => s + (r[dc]||0), 0); });
    const dtChanges = defectCols.map(dc => ({ type: dc, a: dtA[dc], b: dtB[dc], diff: dtB[dc] - dtA[dc] })).sort((a,b) => b.diff - a.diff);
    const worstDT = dtChanges.filter(d => d.diff > 0);
    const bestDT = dtChanges.filter(d => d.diff < 0);
    if (worstDT.length) defectTypeInsight += `<span style="color:var(--danger)">ì¦ê°€ ë¶ˆëŸ‰ìœ í˜•:</span> ${worstDT.slice(0,3).map(d => `${d.type}(+${fmt(d.diff)}ê±´)`).join(', ')}`;
    if (bestDT.length) defectTypeInsight += `${worstDT.length ? ' | ' : ''}<span style="color:var(--success)">ê°ì†Œ ë¶ˆëŸ‰ìœ í˜•:</span> ${bestDT.slice(0,3).map(d => `${d.type}(${fmt(d.diff)}ê±´)`).join(', ')}`;
  }

  // ì¢…í•© íŒì •
  let verdict, verdictColor, verdictIcon;
  if (diffRate < -0.5) { verdict = 'í’ˆì§ˆ ëŒ€í­ ê°œì„ '; verdictColor = '#16A34A'; verdictIcon = 'ğŸŸ¢'; }
  else if (diffRate < -0.1) { verdict = 'í’ˆì§ˆ ì†Œí­ ê°œì„ '; verdictColor = '#16A34A'; verdictIcon = 'ğŸŸ¢'; }
  else if (diffRate <= 0.1) { verdict = 'í’ˆì§ˆ ìœ ì§€ (ì•ˆì •)'; verdictColor = '#F59E0B'; verdictIcon = 'ğŸŸ¡'; }
  else if (diffRate <= 0.5) { verdict = 'í’ˆì§ˆ ì†Œí­ ì•…í™”'; verdictColor = '#DC2626'; verdictIcon = 'ğŸ”´'; }
  else { verdict = 'í’ˆì§ˆ ëŒ€í­ ì•…í™”'; verdictColor = '#DC2626'; verdictIcon = 'ğŸ”´'; }

  html += `<div style="background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px 20px;margin-bottom:16px">`;
  html += `<h4 style="margin:0 0 12px 0;font-size:15px">ğŸ“Š í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h4>`;

  // ì¢…í•© íŒì • ë°°ë„ˆ
  html += `<div style="background:${verdictColor}15;border-left:4px solid ${verdictColor};padding:10px 14px;border-radius:0 8px 8px 0;margin-bottom:12px;font-weight:700;font-size:15px;color:${verdictColor}">`;
  html += `${verdictIcon} ì¢…í•© íŒì •: ${verdict} (ë¶ˆëŸ‰ë¥  ${diffRate > 0 ? '+' : ''}${pct(diffRate)}%p)`;
  html += `</div>`;

  // í•µì‹¬ ì§€í‘œ ìš”ì•½
  html += `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px;margin-bottom:12px">`;
  html += `<div style="padding:8px 12px;background:var(--bg);border-radius:8px;font-size:13px">`;
  html += `<span style="color:var(--text-light)">ìˆ˜ìœ¨ ë³€í™”</span><br><strong style="color:${diffYield>=0?'var(--success)':'var(--danger)'}">${yieldA.toFixed(2)}% â†’ ${yieldB.toFixed(2)}% (${diffYield>0?'+':''}${diffYield.toFixed(2)}%p)</strong></div>`;
  html += `<div style="padding:8px 12px;background:var(--bg);border-radius:8px;font-size:13px">`;
  html += `<span style="color:var(--text-light)">ì¼í‰ê·  ìƒì‚°</span><br><strong>A: ${fmt(Math.round(kA.ì´ìƒì‚°ìˆ˜ëŸ‰/kA.ìƒì‚°ì¼ìˆ˜))}ê°œ â†’ B: ${fmt(Math.round(kB.ì´ìƒì‚°ìˆ˜ëŸ‰/kB.ìƒì‚°ì¼ìˆ˜))}ê°œ</strong></div>`;
  html += `<div style="padding:8px 12px;background:var(--bg);border-radius:8px;font-size:13px">`;
  html += `<span style="color:var(--text-light)">ì¼í‰ê·  ë¶ˆëŸ‰</span><br><strong style="color:${kB.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰/kB.ìƒì‚°ì¼ìˆ˜ <= kA.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰/kA.ìƒì‚°ì¼ìˆ˜ ? 'var(--success)':'var(--danger)'}">A: ${fmt(Math.round(kA.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰/kA.ìƒì‚°ì¼ìˆ˜))}ê°œ â†’ B: ${fmt(Math.round(kB.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰/kB.ìƒì‚°ì¼ìˆ˜))}ê°œ</strong></div>`;
  html += `<div style="padding:8px 12px;background:var(--bg);border-radius:8px;font-size:13px">`;
  html += `<span style="color:var(--text-light)">ëª©í‘œ(${targetDefectRate}%) ëŒ€ë¹„</span><br><strong style="color:${kB.ë¶ˆëŸ‰ë¥  <= targetDefectRate ? 'var(--success)':'var(--danger)'}">A: ${kA.ë¶ˆëŸ‰ë¥  <= targetDefectRate ? 'ë‹¬ì„±':'ì´ˆê³¼'} â†’ B: ${kB.ë¶ˆëŸ‰ë¥  <= targetDefectRate ? 'ë‹¬ì„±':'ì´ˆê³¼'}</strong></div>`;
  html += `</div>`;

  // í’ˆëª© ë³€í™” ìš”ì•½
  html += `<div style="font-size:13px;line-height:1.8;color:var(--text)">`;
  html += `<div>ğŸ“¦ <strong>í’ˆëª© ë³€í™”:</strong> ê°œì„  <span style="color:var(--success);font-weight:700">${improvedItems}ê°œ</span> | ì•…í™” <span style="color:var(--danger);font-weight:700">${worsenedItems}ê°œ</span> | ì•ˆì • <span style="color:var(--text-light);font-weight:700">${stableItems}ê°œ</span></div>`;
  if (newInB.length) html += `<div>ğŸ†• <strong>Bê¸°ê°„ ì‹ ê·œ ë¶ˆëŸ‰ í’ˆëª©:</strong> ${newInB.slice(0,5).map(r => `${r.í’ˆëª…}(${pct(r.b)})`).join(', ')}${newInB.length > 5 ? ` ì™¸ ${newInB.length-5}ê°œ` : ''}</div>`;
  if (removedInB.length) html += `<div>âœ… <strong>Bê¸°ê°„ ë¶ˆëŸ‰ í•´ì†Œ í’ˆëª©:</strong> ${removedInB.slice(0,5).map(r => r.í’ˆëª…).join(', ')}${removedInB.length > 5 ? ` ì™¸ ${removedInB.length-5}ê°œ` : ''}</div>`;
  if (worst5.length && worst5[0].ë³€í™” > 0) html += `<div>âš ï¸ <strong>ê°€ì¥ ì•…í™”ëœ í’ˆëª©:</strong> ${worst5[0].í’ˆëª…} (${pct(worst5[0].a)}% â†’ ${pct(worst5[0].b)}%, <span style="color:var(--danger)">+${pct(worst5[0].ë³€í™”)}%p</span>)</div>`;
  if (top5.length && top5[0].ë³€í™” < 0) html += `<div>ğŸ† <strong>ê°€ì¥ ê°œì„ ëœ í’ˆëª©:</strong> ${top5[0].í’ˆëª…} (${pct(top5[0].a)}% â†’ ${pct(top5[0].b)}%, <span style="color:var(--success)">${pct(top5[0].ë³€í™”)}%p</span>)</div>`;
  if (defectTypeInsight) html += `<div>ğŸ”§ <strong>ë¶ˆëŸ‰ìœ í˜• ë³€í™”:</strong> ${defectTypeInsight}</div>`;
  html += `</div></div>`;

  html+='<div style="display:flex;gap:12px;flex-wrap:wrap">';
  html+='<div style="flex:1;min-width:250px"><h4 style="color:var(--success);margin-bottom:8px">ê°œì„  TOP 5</h4>';
  html+='<div class="tbl-wrap"><table class="data-tbl"><thead><tr><th>í’ˆëª…</th><th>A ë¶ˆëŸ‰ë¥ </th><th>B ë¶ˆëŸ‰ë¥ </th><th>ë³€í™”</th></tr></thead><tbody>';
  top5.forEach(r=>html+=`<tr><td>${r.í’ˆëª…}</td><td>${pct(r.a)}</td><td>${pct(r.b)}</td><td style="color:var(--success)">${pct(r.ë³€í™”,2)}</td></tr>`);
  html+='</tbody></table></div></div>';
  html+='<div style="flex:1;min-width:250px"><h4 style="color:var(--danger);margin-bottom:8px">ì•…í™” TOP 5</h4>';
  html+='<div class="tbl-wrap"><table class="data-tbl"><thead><tr><th>í’ˆëª…</th><th>A ë¶ˆëŸ‰ë¥ </th><th>B ë¶ˆëŸ‰ë¥ </th><th>ë³€í™”</th></tr></thead><tbody>';
  worst5.forEach(r=>html+=`<tr><td>${r.í’ˆëª…}</td><td>${pct(r.a)}</td><td>${pct(r.b)}</td><td style="color:var(--danger)">+${pct(r.ë³€í™”,2)}</td></tr>`);
  html+='</tbody></table></div></div></div>';

  $('cmpResult').innerHTML=html;
}

/* ================================================================
   Phase 2: í’ˆëª© ì‹¬ì¸µë¶„ì„ (ë“œë¦´ë‹¤ìš´)
   ================================================================ */
function renderDrilldown(data, byItem, el) {
  const hasRawData = data && data.length > 0;
  let html='<div class="chart-box"><h3>í’ˆëª© ì‹¬ì¸µ ë¶„ì„</h3>';
  if (!hasRawData) {
    html += '<div class="info-box warn" style="margin-bottom:12px">ì €ì¥ëœ ë°ì´í„°ì—ì„œ ë³µì› ì¤‘ì…ë‹ˆë‹¤. ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë” ìƒì„¸í•œ ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>';
  }
  html+='<div style="margin-bottom:12px"><label style="font-size:13px;font-weight:600">í’ˆëª© ì„ íƒ</label>';
  html+='<select id="drillItem" style="width:100%"><option value="">-- ì„ íƒí•˜ì„¸ìš” --</option>';
  [...byItem].sort((a,b)=>b.ë¶ˆëŸ‰ë¥ -a.ë¶ˆëŸ‰ë¥ ).forEach(r=>html+=`<option value="${r.í’ˆëª…}">${r.í’ˆëª…} (ë¶ˆëŸ‰ë¥  ${pct(r.ë¶ˆëŸ‰ë¥ *100)})</option>`);
  html+='</select></div><div id="drillResult"></div></div>';
  el.innerHTML=html;
  $('drillItem').addEventListener('change',()=>{
    const item=$('drillItem').value;
    if(!item){$('drillResult').innerHTML='';if(isMobile())$('drillModal').classList.remove('open');return;}

    // ì›ë³¸ í–‰ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í•„í„°ë§, ì—†ìœ¼ë©´ byItem ì§‘ê³„ë¡œ ëŒ€ì²´
    let rows, byD;
    if (hasRawData) {
      rows = data.filter(r=>r.í’ˆëª…===item);
      byD = aggByDate(rows);
    } else {
      // byItemì—ì„œ í•´ë‹¹ í’ˆëª©ì˜ ì§‘ê³„ ë°ì´í„°ë¡œ ëŒ€ì²´
      const itemSummary = byItem.find(r => r.í’ˆëª… === item);
      rows = itemSummary ? [itemSummary] : [];
      byD = itemSummary ? [{
        ìƒì‚°ì¼ì: itemSummary.ìƒì‚°ì¼ì || 'ì§‘ê³„',
        ìƒì‚°ìˆ˜ëŸ‰: itemSummary.ìƒì‚°ìˆ˜ëŸ‰,
        ì–‘í’ˆìˆ˜ëŸ‰: itemSummary.ì–‘í’ˆìˆ˜ëŸ‰,
        ë¶ˆëŸ‰ìˆ˜ëŸ‰: itemSummary.ë¶ˆëŸ‰ìˆ˜ëŸ‰,
        ë¶ˆëŸ‰ë¥ : itemSummary.ë¶ˆëŸ‰ë¥ ,
        ...defectCols.reduce((o, dc) => { o[dc] = itemSummary[dc] || 0; return o; }, {})
      }] : [];
    }
    const mb=isMobile();

    // ëª¨ë°”ì¼: ëª¨ë‹¬ì— í‘œì‹œ / PC: drillResultì— í‘œì‹œ
    const targetEl = mb ? $('drillModalContent') : null;

    let rHtml=`<h3 style="margin-bottom:12px;font-size:16px">${item}</h3>`;
    rHtml+='<div class="kpi-grid" style="grid-template-columns:repeat('+( mb?'2':'4')+',1fr);margin:12px 0">';
    const totP=rows.reduce((s,r)=>s+r.ìƒì‚°ìˆ˜ëŸ‰,0), totB=rows.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0);
    rHtml+=`<div class="kpi-card"><div class="value" style="color:var(--primary)">${fmt(totP)}</div><div class="label">ì´ ìƒì‚°</div></div>`;
    rHtml+=`<div class="kpi-card"><div class="value" style="color:var(--success)">${fmt(totP-totB)}</div><div class="label">ì–‘í’ˆ</div></div>`;
    rHtml+=`<div class="kpi-card"><div class="value" style="color:var(--danger)">${fmt(totB)}</div><div class="label">ë¶ˆëŸ‰</div></div>`;
    rHtml+=`<div class="kpi-card"><div class="value" style="color:var(--warning)">${pct(totP?totB/totP*100:0)}</div><div class="label">ë¶ˆëŸ‰ë¥ </div></div>`;
    rHtml+='</div>';
    const trendId = mb ? 'drillTrendM' : 'drillTrend';
    const pieId = mb ? 'drillPieM' : 'drillDefectPie';
    rHtml+=`<div id="${trendId}"></div>`;
    if(defectCols.length) rHtml+=`<div id="${pieId}" style="margin-top:16px"></div>`;

    if (mb) {
      targetEl.innerHTML = rHtml;
      $('drillModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    } else {
      $('drillResult').innerHTML = rHtml;
    }

    // ì¼ìë³„ ì¶”ì´
    const dates=byD.map(r=>dateKR(r.ìƒì‚°ì¼ì));
    setTimeout(()=>{
      const tEl = document.getElementById(trendId);
      if(!tEl) return;
      Plotly.newPlot(tEl,[
        {x:dates,y:byD.map(r=>r.ìƒì‚°ìˆ˜ëŸ‰),type:'bar',name:'ìƒì‚°ìˆ˜ëŸ‰',marker:{color:'#2563EB',opacity:.7}},
        {x:dates,y:byD.map(r=>r.ë¶ˆëŸ‰ë¥ *100),type:'scatter',mode:'lines+markers',name:'ë¶ˆëŸ‰ë¥ (%)',
          line:{color:'#DC2626',width:2},marker:{size:mb?5:7},yaxis:'y2'}
      ],{
        yaxis:{title:mb?'':'ìƒì‚°ìˆ˜ëŸ‰'},yaxis2:{title:mb?'':'ë¶ˆëŸ‰ë¥ (%)',overlaying:'y',side:'right'},
        legend:{orientation:'h',y:mb?1.15:1.12},height:chartHeight(350,260),
        margin:mb?{t:20,b:40,l:40,r:40}:{t:40,b:50,l:60,r:60}
      },getPlotCfg());

      // ë¶ˆëŸ‰ìœ í˜• íŒŒì´
      if(defectCols.length){
        const totals=defectCols.map(dc=>({type:dc,val:rows.reduce((s,r)=>s+r[dc],0)})).filter(t=>t.val>0);
        const pEl = document.getElementById(pieId);
        if(totals.length && pEl){
          Plotly.newPlot(pEl,[{
            labels:totals.map(t=>t.type),values:totals.map(t=>t.val),type:'pie',hole:.4,
            textinfo:'label+percent',textfont:{size:mb?10:12}
          }],{title:mb?'':'ë¶ˆëŸ‰ìœ í˜• ë¶„í¬',height:chartHeight(350,280),
            margin:mb?{t:30,b:20,l:20,r:20}:{t:50,b:30,l:40,r:40}},getPlotCfg());
        }
      }
    }, mb ? 300 : 50);
  });
}

/* ================================================================
   Phase 2: í…Œì´ë¸” ê°•í™” (ì •ë ¬ + ê²€ìƒ‰ + ì¡°ê±´ë¶€ì„œì‹)
   ================================================================ */
function makeTableEnhanced(headers, rows, id) {
  let html='<div class="scroll-hint">&#8592; ì¢Œìš° ìŠ¤í¬ë¡¤ ê°€ëŠ¥ &#8594;</div>';
  html+=`<input type="text" placeholder="ê²€ìƒ‰..." style="width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;font-size:13px;min-height:40px" onInput="filterTable('${id}',this.value)">`;
  html+=`<div class="tbl-wrap"><table class="data-tbl" id="${id}"><thead><tr>`;
  headers.forEach((h,i)=>html+=`<th style="cursor:pointer" onclick="sortTable('${id}',${i})">${h} â†•</th>`);
  html+='</tr></thead><tbody>';

  // ìˆ«ì ì»¬ëŸ¼ íŒë³„ (ì²« ë²ˆì§¸ ì»¬ëŸ¼ = ë‚ ì§œ/í’ˆëª…ì´ë¯€ë¡œ ì œì™¸)
  const numHeaders = new Set(headers.filter((h,i) => i > 0 && rows.length > 0 && typeof rows[0][h] === 'number'));

  for(let ri=0; ri<rows.length; ri++){
    const row = rows[ri];
    const prev = ri > 0 ? rows[ri-1] : null;
    // ë¶ˆëŸ‰ë¥  ê¸°ì¤€ í–‰ ë°°ê²½ìƒ‰ (ì „ì¼ ëŒ€ë¹„)
    let rowStyle='';
    const rateH = headers.find(h=>h.includes('ë¥ '));
    if(prev && rateH && typeof row[rateH]==='number' && typeof prev[rateH]==='number'){
      const rd=row[rateH]-prev[rateH];
      if(rd>0.0001) rowStyle='background:rgba(220,38,38,0.04)';
      else if(rd<-0.0001) rowStyle='background:rgba(37,99,235,0.04)';
    }
    html+=`<tr style="${rowStyle}">`;
    for(const h of headers){
      let v=row[h];
      let style='';
      let trend='';

      if(h.includes('ë¥ ')&&typeof v==='number'){
        const rate=v*100;
        // ì „ì¼ ëŒ€ë¹„ ì¦ê° (ì†Œìˆ˜ì  3ìë¦¬ + ìƒëŒ€ë³€ë™ë¥ )
        if(prev && typeof prev[h]==='number'){
          const prevRate=prev[h]*100;
          const diff=rate-prevRate;
          const absDiff=Math.abs(diff);
          // ìƒëŒ€ ë³€ë™ë¥ : ì „ì¼ ëŒ€ë¹„ ëª‡ % ë³€í–ˆëŠ”ì§€
          const relChg = prevRate > 0 ? (diff / prevRate * 100) : 0;
          const absRel = Math.abs(relChg);
          if(diff>0.001){
            const intensity = absRel >= 30 ? 'font-weight:700;font-size:11px' : absRel >= 10 ? 'font-weight:600' : '';
            trend=`<span style="color:#DC2626;font-size:10px;margin-left:3px;${intensity}">â–²${absDiff.toFixed(3)}%</span>`;
          } else if(diff<-0.001){
            const intensity = absRel >= 30 ? 'font-weight:700;font-size:11px' : absRel >= 10 ? 'font-weight:600' : '';
            trend=`<span style="color:#2563EB;font-size:10px;margin-left:3px;${intensity}">â–¼${absDiff.toFixed(3)}%</span>`;
          }
        }
        v=pct(rate);
        if(rate>5)style='background:#FEE2E2;color:#991B1B;font-weight:600';
        else if(rate>3)style='background:#FEF3C7;color:#92400E';
      }else if(numHeaders.has(h)&&typeof v==='number'){
        // ìˆ«ì ì»¬ëŸ¼ ì „ì¼ ëŒ€ë¹„ ì¦ê°
        if(prev && typeof prev[h]==='number'){
          const diff=v-prev[h];
          if(diff>0) trend=`<span style="color:#DC2626;font-size:10px;margin-left:3px">â–²${fmt(Math.abs(diff))}</span>`;
          else if(diff<0) trend=`<span style="color:#2563EB;font-size:10px;margin-left:3px">â–¼${fmt(Math.abs(diff))}</span>`;
        }
        v=fmt(v);
      }
      html+=`<td style="${style}">${(v??'')}${trend}</td>`;
    }
    html+='</tr>';
  }
  html+='</tbody></table></div>';
  return html;
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ (Tab9) â€” í—¬í¼ í•¨ìˆ˜
   ================================================================ */

/* ì¢…í•© í’ˆì§ˆ ì ìˆ˜ (0~100, ê°ì  ë°©ì‹) */
function calcQualityScore(kpi, trends, anomalies, riskScores, st) {
  let score = 100;
  // 1) ë¶ˆëŸ‰ë¥  ê°ì  (max -40, ìë™ì°¨ë¶€í’ˆ ê¸°ì¤€: 1.5%ê°€ í•œê³„ì„ )
  score -= Math.min(40, kpi.ë¶ˆëŸ‰ë¥  / 1.5 * 40);
  // 2) ìœ„í—˜ í’ˆëª© ê°ì  (max -20)
  score -= Math.min(20, riskScores.filter(r => r.grade === 'ìœ„í—˜').length * 7);
  // 3) ì´ìƒ ì§•í›„ ê°ì  (max -15)
  score -= Math.min(15, anomalies.filter(a => a.severity === 'danger').length * 5);
  // 4) ì¶”ì„¸ ê°ì  (max -15)
  if (trends.direction === 'ê¸‰ë“±') score -= 15;
  else if (trends.direction === 'ìƒìŠ¹') score -= 8;
  else if (trends.direction === 'ê°œì„ ') score += 3;
  else if (trends.direction === 'ê¸‰ê°') score += 5;
  // 5) ê³µì • ë¶ˆì•ˆì • ê°ì  (max -15)
  score -= Math.min(15, anomalies.filter(a => a.type === 'ucl').length * 5);

  score = Math.max(0, Math.min(100, Math.round(score)));
  let letterGrade = score >= 90 ? 'A' : score >= 75 ? 'B' : score >= 60 ? 'C' : score >= 45 ? 'D' : 'F';

  // ë¶ˆëŸ‰ë¥  ê¸°ë°˜ ë“±ê¸‰ ìƒí•œ ì ìš© (ìë™ì°¨ ë¶€í’ˆ ê¸°ì¤€)
  // 0.0~0.3%: A, 0.3~0.7%: B, 0.7~1.5%: C, 1.5~3.0%: D, 3.0%+: F
  const dr = kpi.ë¶ˆëŸ‰ë¥ ;
  if      (dr >= 3.0)                                letterGrade = 'F';
  else if (dr >= 1.5 && 'ABC'.includes(letterGrade)) letterGrade = 'D';
  else if (dr >= 0.7 && 'AB'.includes(letterGrade))  letterGrade = 'C';
  else if (dr >= 0.3 && letterGrade === 'A')         letterGrade = 'B';

  const verdicts = {
    A: 'í’ˆì§ˆì´ ë§¤ìš° ìš°ìˆ˜í•©ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ì„¸ìš”.',
    B: 'í’ˆì§ˆì´ ì–‘í˜¸í•©ë‹ˆë‹¤. ì¼ë¶€ í•­ëª©ì„ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”.',
    C: 'í’ˆì§ˆì— ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤. ê°œì„  í™œë™ì„ ì‹œì‘í•˜ì„¸ìš”.',
    D: 'í’ˆì§ˆ ë¬¸ì œê°€ ì‹¬ê°í•©ë‹ˆë‹¤. ì¦‰ê°ì ì¸ ì ê²€ì´ í•„ìš”í•©ë‹ˆë‹¤.',
    F: 'ê¸´ê¸‰ ìƒí™©ì…ë‹ˆë‹¤. ìƒì‚° ë¼ì¸ì„ ì ê²€í•˜ê³  ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”.'
  };
  const colors = { A:'#16A34A', B:'#22C55E', C:'#F59E0B', D:'#EF4444', F:'#991B1B' };
  return { score, letterGrade, verdict: verdicts[letterGrade], color: colors[letterGrade] };
}

/* SVG ë°˜ì› ê²Œì´ì§€ HTML */
function drawQualityGaugeHTML(score, letterGrade, color) {
  // 0=left(180Â°), 100=right(0Â°). Arc: M25,100 A75,75 â†’ semicircle top
  const clampScore = Math.max(0, Math.min(100, score));
  const angle = clampScore / 100 * 180;
  const rad = (180 - angle) * Math.PI / 180;
  const endX = 100 + 75 * Math.cos(rad);
  const endY = 100 - 75 * Math.sin(rad);
  const largeArc = angle > 90 ? 1 : 0;
  // score=0 â†’ no colored arc
  const colorArc = clampScore <= 0 ? ''
    : clampScore >= 100
      ? `<path d="M 25,100 A 75,75 0 1,1 175,100" fill="none" stroke="${color}" stroke-width="16" stroke-linecap="round"/>`
      : `<path d="M 25,100 A 75,75 0 ${largeArc},1 ${endX.toFixed(1)},${endY.toFixed(1)}" fill="none" stroke="${color}" stroke-width="16" stroke-linecap="round"/>`;
  return `<svg viewBox="0 0 200 115" style="width:100%;max-width:240px">
    <path d="M 25,100 A 75,75 0 0,1 175,100" fill="none" stroke="#E5E7EB" stroke-width="16" stroke-linecap="round"/>
    ${colorArc}
    <text x="100" y="60" text-anchor="middle" font-size="14" font-weight="700" fill="${color}">${letterGrade}ë“±ê¸‰</text>
    <text x="100" y="90" text-anchor="middle" font-size="34" font-weight="900" fill="${color}">${score}</text>
    <text x="100" y="106" text-anchor="middle" font-size="11" fill="#9CA3AF">/ 100ì </text>
  </svg>`;
}

/* ìƒì„¸ ë¶„ì„ í† ê¸€ */
function toggleAIDetail() {
  const el = document.getElementById('aiDetailSection');
  const lbl = document.getElementById('aiDetailToggleText');
  if (!el) return;
  if (el.style.display === 'none') {
    el.style.display = 'block';
    lbl.textContent = 'ìƒì„¸ ë¶„ì„ ì ‘ê¸° â–²';
    if (!el.dataset.chartsRendered) {
      el.dataset.chartsRendered = '1';
      const ctx = aiRenderContext;
      if (ctx.byItem) chartRiskMatrix(calcItemRiskScores(ctx.byItem, ctx.filtered, aiRiskSettings).filter(r => r.ìƒì‚°ìˆ˜ëŸ‰ >= 10), $('chartRiskMatrix'));
      if (defectCols.length && ctx.byDate) chartDefectTrends(ctx.byDate, analyzeDefectTypes(ctx.byDate), $('chartDefectTrends'));
    }
  } else {
    el.style.display = 'none';
    lbl.textContent = 'ìƒì„¸ ë¶„ì„ ë³´ê¸° â–¼';
  }
}

function linearSlope(arr) {
  const n = arr.length;
  if (n < 2) return 0;
  let sx=0, sy=0, sxx=0, sxy=0;
  for (let i=0; i<n; i++) { sx+=i; sy+=arr[i]; sxx+=i*i; sxy+=i*arr[i]; }
  const denom = n*sxx - sx*sx;
  return denom === 0 ? 0 : (n*sxy - sx*sy) / denom;
}

function aggByItemDate(data) {
  const map = new Map();
  for (const r of data) {
    const d = dateStr(r.ìƒì‚°ì¼ì);
    const key = r.í’ˆëª… + '|' + d;
    if (!map.has(key)) {
      const o = { í’ˆëª…: r.í’ˆëª…, ìƒì‚°ì¼ì: d, ìƒì‚°ìˆ˜ëŸ‰:0, ì–‘í’ˆìˆ˜ëŸ‰:0, ë¶ˆëŸ‰ìˆ˜ëŸ‰:0 };
      for (const dc of defectCols) o[dc] = 0;
      map.set(key, o);
    }
    const o = map.get(key);
    o.ìƒì‚°ìˆ˜ëŸ‰ += r.ìƒì‚°ìˆ˜ëŸ‰; o.ì–‘í’ˆìˆ˜ëŸ‰ += r.ì–‘í’ˆìˆ˜ëŸ‰; o.ë¶ˆëŸ‰ìˆ˜ëŸ‰ += r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
    for (const dc of defectCols) o[dc] += r[dc];
  }
  const arr = [...map.values()];
  arr.forEach(o => o.ë¶ˆëŸ‰ë¥  = o.ìƒì‚°ìˆ˜ëŸ‰ ? o.ë¶ˆëŸ‰ìˆ˜ëŸ‰/o.ìƒì‚°ìˆ˜ëŸ‰ : 0);
  return arr;
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” 1. ì¶”ì„¸ ë¶„ì„ (analyzeTrends)
   ================================================================ */
function analyzeTrends(byDate, filtered) {
  const result = { direction: 'ì•ˆì •', ma7: [], ma14: [], crossType: null,
    consecutiveWorsen: 0, consecutiveImprove: 0, weekChange: 0, monthChange: 0 };
  if (!byDate || byDate.length < 3) return result;

  const rates = byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  result.ma7 = movingAvg(byDate, 'ë¶ˆëŸ‰ë¥ ', 7).map(v => v*100);
  result.ma14 = movingAvg(byDate, 'ë¶ˆëŸ‰ë¥ ', 14).map(v => v*100);

  // ê³¨ë“ /ë°ë“œ í¬ë¡œìŠ¤ ê°ì§€ (ë§ˆì§€ë§‰ 3ì¼ ë‚´)
  const len = result.ma7.length;
  for (let i = Math.max(1, len-3); i < len; i++) {
    const prev7 = result.ma7[i-1], cur7 = result.ma7[i];
    const prev14 = result.ma14[i-1], cur14 = result.ma14[i];
    if (prev7 <= prev14 && cur7 > cur14) result.crossType = 'dead';
    if (prev7 >= prev14 && cur7 < cur14) result.crossType = 'golden';
  }

  // ì—°ì† ì•…í™”/ê°œì„ 
  let worsen = 0, improve = 0;
  for (let i = rates.length-1; i > 0; i--) {
    if (rates[i] > rates[i-1] + 0.001) { worsen++; if (improve > 0) break; }
    else if (rates[i] < rates[i-1] - 0.001) { improve++; if (worsen > 0) break; }
    else break;
  }
  result.consecutiveWorsen = worsen;
  result.consecutiveImprove = improve;

  // ì „ì£¼/ì „ì›” ëŒ€ë¹„
  const wc = calcWeekChange(filtered || byDate);
  result.weekChange = wc.ë³€í™”;

  const monthly = aggByMonth(filtered || byDate);
  if (monthly.length >= 2) {
    const cur = monthly[monthly.length-1].ë¶ˆëŸ‰ë¥  * 100;
    const prev = monthly[monthly.length-2].ë¶ˆëŸ‰ë¥  * 100;
    result.monthChange = cur - prev;
  }

  // ë°©í–¥ ë¶„ë¥˜
  const slope = linearSlope(rates);
  const lastRate = rates[rates.length-1];
  const avgRate = rates.reduce((a,b)=>a+b,0) / rates.length;
  if (slope > 0.15 && lastRate > avgRate * 1.3) result.direction = 'ê¸‰ë“±';
  else if (slope > 0.05) result.direction = 'ìƒìŠ¹';
  else if (slope < -0.15 && lastRate < avgRate * 0.7) result.direction = 'ê¸‰ê°';
  else if (slope < -0.05) result.direction = 'ê°œì„ ';
  else result.direction = 'ì•ˆì •';

  return result;
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” 2. ì´ìƒ ê°ì§€ (detectAnomalies)
   ================================================================ */
function detectAnomalies(byDate) {
  const anomalies = [];
  if (!byDate || byDate.length < 5) return anomalies;

  const rates = byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  const mean = rates.reduce((a,b)=>a+b,0) / rates.length;
  const std = Math.sqrt(rates.reduce((s,v)=>s+(v-mean)*(v-mean),0) / rates.length) || 0.001;

  // Z-score ì´ìƒì¹˜
  rates.forEach((v,i) => {
    const z = (v - mean) / std;
    if (Math.abs(z) > 2.5) {
      anomalies.push({ date: byDate[i].ìƒì‚°ì¼ì, type: 'zscore', severity: 'danger',
        desc: `Z-score ${z.toFixed(1)} (ë¶ˆëŸ‰ë¥  ${pct(v)})` });
    }
  });

  // ì¼ê°„ ê¸‰ë“± (ë³€ë™ > 2Ïƒ)
  for (let i = 1; i < rates.length; i++) {
    const diff = rates[i] - rates[i-1];
    if (diff > 2 * std) {
      anomalies.push({ date: byDate[i].ìƒì‚°ì¼ì, type: 'spike', severity: 'danger',
        desc: `ì¼ê°„ ê¸‰ë“± +${pct(diff)} (${pct(rates[i-1])} â†’ ${pct(rates[i])})` });
    }
  }

  // SPC ê·œì¹™ ìœ„ë°˜ ì¬í™œìš©
  const n = byDate.length;
  const totalBad = byDate.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0);
  const totalProd = byDate.reduce((s,r)=>s+r.ìƒì‚°ìˆ˜ëŸ‰,0);
  const pBar = totalProd ? totalBad/totalProd : 0;
  const pBarPct = pBar * 100;

  // UCL/LCL ì´íƒˆ
  byDate.forEach((r, i) => {
    const ni = Math.max(r.ìƒì‚°ìˆ˜ëŸ‰, 1);
    const ucl = (pBar + 3*Math.sqrt(pBar*(1-pBar)/ni))*100;
    const lcl = Math.max(0, (pBar - 3*Math.sqrt(pBar*(1-pBar)/ni))*100);
    const pi = r.ë¶ˆëŸ‰ë¥  * 100;
    if (pi > ucl) {
      anomalies.push({ date: r.ìƒì‚°ì¼ì, type: 'ucl', severity: 'danger',
        desc: `UCL ì´íƒˆ (${pct(pi)} > ${pct(ucl)})` });
    }
  });

  // 7ì—°ì† ì¶”ì„¸
  for (let i = 6; i < n; i++) {
    let up = true, dn = true;
    for (let j = i-5; j <= i; j++) { if (rates[j] <= rates[j-1]) up=false; if (rates[j] >= rates[j-1]) dn=false; }
    if (up) anomalies.push({ date: byDate[i].ìƒì‚°ì¼ì, type: 'trend7', severity: 'warn',
      desc: '7ì—°ì† ìƒìŠ¹ ì¶”ì„¸ ê°ì§€' });
  }

  // 8ì—°ì† í¸ì¸¡
  for (let i = 7; i < n; i++) {
    const above = rates.slice(i-7,i+1).every(v => v > pBarPct);
    if (above) anomalies.push({ date: byDate[i].ìƒì‚°ì¼ì, type: 'bias8', severity: 'warn',
      desc: '8ì—°ì† ì¤‘ì‹¬ì„  ìƒë°© í¸ì¸¡' });
  }

  // ì¤‘ë³µ ì œê±° (ê°™ì€ ë‚ ì§œ+íƒ€ì…)
  const seen = new Set();
  return anomalies.filter(a => {
    const key = a.date + a.type;
    if (seen.has(key)) return false;
    seen.add(key); return true;
  }).sort((a,b) => String(a.date).localeCompare(String(b.date)));
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” 3. ë¶ˆëŸ‰ìœ í˜• ë¶„ì„ (analyzeDefectTypes)
   ================================================================ */
function analyzeDefectTypes(byDate) {
  const result = { trends: [], hhi: 0, dominant: null, newTypes: [], disappearedTypes: [] };
  if (!defectCols.length || !byDate || byDate.length < 3) return result;

  // ìœ í˜•ë³„ ì¶”ì„¸ ê¸°ìš¸ê¸°
  result.trends = defectCols.map(dc => {
    const vals = byDate.map(r => r[dc] || 0);
    const total = vals.reduce((a,b)=>a+b,0);
    const slope = linearSlope(vals);
    return { type: dc, slope, total, direction: slope > 0.5 ? 'ì¦ê°€' : slope < -0.5 ? 'ê°ì†Œ' : 'ì•ˆì •' };
  }).sort((a,b) => b.slope - a.slope);

  // HHI ì§‘ì¤‘ë„
  const totalAll = result.trends.reduce((s,t)=>s+t.total,0) || 1;
  const shares = result.trends.map(t => t.total / totalAll);
  result.hhi = shares.reduce((s,sh)=>s+sh*sh,0);
  if (result.hhi > 0.5) {
    const top = result.trends.reduce((a,b)=>a.total>b.total?a:b);
    result.dominant = top.type;
  }

  // ì‹ ê·œ/ì†Œë©¸ ë¶ˆëŸ‰ìœ í˜• (ì „ë°˜ë¶€ vs í›„ë°˜ë¶€)
  const half = Math.floor(byDate.length / 2);
  const first = byDate.slice(0, half);
  const second = byDate.slice(half);
  defectCols.forEach(dc => {
    const sumFirst = first.reduce((s,r)=>s+(r[dc]||0),0);
    const sumSecond = second.reduce((s,r)=>s+(r[dc]||0),0);
    if (sumFirst === 0 && sumSecond > 0) result.newTypes.push(dc);
    if (sumFirst > 0 && sumSecond === 0) result.disappearedTypes.push(dc);
  });

  return result;
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” 4. í’ˆëª© ìœ„í—˜ë„ (calcItemRiskScores)
   ================================================================ */
function calcItemRiskScores(byItem, filtered, settings = aiRiskSettings) {
  if (!byItem || !byItem.length) return [];

  // ì „ì²´ ê¸°ì¤€ê°’ ê³„ì‚°
  const cfg = sanitizeAiRiskSettings(settings);
  const allRates = byItem.map(r => r.ë¶ˆëŸ‰ë¥  * 100);
  const maxRate = Math.max(...allRates, 0.01);
  const maxProd = Math.max(...byItem.map(r => r.ìƒì‚°ìˆ˜ëŸ‰), 1);

  // í’ˆëª©ë³„ ì¼ë³„ ë°ì´í„° (ë³€ë™ì„± ê³„ì‚°ìš©)
  const itemDaily = new Map();
  if (filtered && filtered.length) {
    for (const r of filtered) {
      if (!itemDaily.has(r.í’ˆëª…)) itemDaily.set(r.í’ˆëª…, []);
      itemDaily.get(r.í’ˆëª…).push(r.ë¶ˆëŸ‰ë¥  * 100);
    }
  }

  return byItem.map(r => {
    const rate = r.ë¶ˆëŸ‰ë¥  * 100;

    // 1. ë¶ˆëŸ‰ë¥  ìˆ˜ì¤€ (25ì ) - ë¹„ì„ í˜•: 5% ì´ìƒì´ë©´ ê±°ì˜ ë§Œì 
    const relativeRateScore = Math.min(25, rate / maxRate * 25 * 1.5);
    const absoluteRateFloor = rate >= cfg.dangerRatePct ? 25
      : rate >= cfg.warnRatePct ? 18
      : rate >= cfg.watchRatePct ? 12 : 0;
    const rateScore = Math.max(relativeRateScore, absoluteRateFloor);

    // 2. ì¶”ì„¸ ê¸°ìš¸ê¸° (25ì )
    const daily = itemDaily.get(r.í’ˆëª…) || [];
    const slope = daily.length >= 3 ? linearSlope(daily) : 0;
    const slopeScore = Math.min(25, Math.max(0, slope * 50 + 12.5));

    // 3. ìƒì‚°ëŸ‰ ê·œëª¨ (25ì ) - ëŒ€ëŸ‰ìƒì‚°ì¼ìˆ˜ë¡ ì˜í–¥ í¼
    const prodScore = Math.min(25, r.ìƒì‚°ìˆ˜ëŸ‰ / maxProd * 25);

    // 4. ë³€ë™ì„± (25ì )
    let rawVolScore = 0;
    let volScore = 0;
    const sampleConfidence = daily.length >= cfg.volMinSamples ? 1 : (daily.length >= 3 ? daily.length / cfg.volMinSamples : 0);
    if (daily.length >= 3) {
      const mean = daily.reduce((a,b)=>a+b,0) / daily.length;
      const std = Math.sqrt(daily.reduce((s,v)=>s+(v-mean)*(v-mean),0) / daily.length);
      rawVolScore = Math.min(25, std / (mean || 1) * 50);
      volScore = rawVolScore * sampleConfidence;
    }

    let total = Math.round(rateScore + slopeScore + prodScore + volScore);
    let forcedRule = 'none';
    if (rate >= cfg.dangerRatePct) {
      total = Math.max(total, cfg.dangerScoreFloor);
      forcedRule = 'danger_rate_gate';
    } else if (rate >= cfg.warnRatePct) {
      total = Math.max(total, cfg.warnScoreFloor);
      forcedRule = 'warn_rate_gate';
    }

    const grade = rate >= cfg.dangerRatePct
      ? 'ìœ„í—˜'
      : (total >= cfg.gradeDangerCut ? 'ìœ„í—˜' : total >= cfg.gradeWarnCut ? 'ì£¼ì˜' : 'ì•ˆì „');
    const color = grade === 'ìœ„í—˜' ? '#DC2626' : grade === 'ì£¼ì˜' ? '#F59E0B' : '#16A34A';

    const reasonBits = [];
    if (forcedRule === 'danger_rate_gate') reasonBits.push(`ë¶ˆëŸ‰ë¥  ${pct(rate)} â‰¥ ìœ„í—˜ ì„ê³„ì¹˜ ${pct(cfg.dangerRatePct)}`);
    else if (forcedRule === 'warn_rate_gate') reasonBits.push(`ë¶ˆëŸ‰ë¥  ${pct(rate)} â‰¥ ì£¼ì˜ ì„ê³„ì¹˜ ${pct(cfg.warnRatePct)}`);
    if (sampleConfidence < 1) reasonBits.push(`ì¼ë³„í‘œë³¸ ${daily.length}ê°œë¡œ ë³€ë™ì„± ì‹ ë¢°ë„ ${(sampleConfidence*100).toFixed(0)}% ë°˜ì˜`);
    if (reasonBits.length === 0) reasonBits.push(`ì´ì  ${total}ì (ì£¼ì˜ ${cfg.gradeWarnCut}+ / ìœ„í—˜ ${cfg.gradeDangerCut}+)`);

    return { í’ˆëª…: r.í’ˆëª…, score: total, grade, color, ë¶ˆëŸ‰ë¥ : rate,
      ìƒì‚°ìˆ˜ëŸ‰: r.ìƒì‚°ìˆ˜ëŸ‰, ë¶ˆëŸ‰ìˆ˜ëŸ‰: r.ë¶ˆëŸ‰ìˆ˜ëŸ‰, slope,
      rateScore: Math.round(rateScore),
      slopeScore: Math.round(slopeScore),
      prodScore: Math.round(prodScore),
      volScore: Math.round(volScore),
      rawVolScore: Math.round(rawVolScore),
      sampleCount: daily.length,
      sampleConfidence: Math.round(sampleConfidence * 100),
      forcedRule,
      ruleLabel: getRiskRuleLabel(forcedRule),
      reason: reasonBits.join(' / ') };
  }).sort((a,b) => b.score - a.score);
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” 5. ìë™ ì§„ë‹¨ í…ìŠ¤íŠ¸ (generateDiagnosisText)
   ================================================================ */
function generateDiagnosisText(kpi, trends, anomalies, defectTypes, riskScores, byDate, targetRate) {
  if (targetRate === undefined) targetRate = targetDefectRate;
  const sections = [];
  const dangerItems = riskScores.filter(r => r.grade === 'ìœ„í—˜');
  const warnItems = riskScores.filter(r => r.grade === 'ì£¼ì˜');
  const safeItems = riskScores.filter(r => r.grade === 'ì•ˆì „');

  // ì „ì²´ ìœ„í—˜ë“±ê¸‰
  let overallGrade = 'ì•ˆì „';
  if (dangerItems.length >= 3 || trends.direction === 'ê¸‰ë“±' ||
      anomalies.filter(a => a.type === 'ucl').length >= 3) {
    overallGrade = 'ìœ„í—˜';
  } else if (warnItems.length > 0 || trends.consecutiveWorsen >= 3 || trends.crossType === 'dead') {
    overallGrade = 'ì£¼ì˜';
  }

  // DPMO, Sigma Level ê³„ì‚°
  const dpmo = kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ > 0 ? Math.round(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰ / kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ * 1000000) : 0;
  const yieldRate = kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ > 0 ? kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰ / kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ * 100 : 100;
  // ê·¼ì‚¬ ì‹œê·¸ë§ˆ ìˆ˜ì¤€ (Yield ê¸°ë°˜)
  const sigmaTable = [[99.99966,6],[99.9977,5.5],[99.977,5],[99.87,4.5],[99.38,4],[97.73,3.5],[95.45,3],[93.32,2.5],[84.13,2],[69.15,1.5],[50,1]];
  let sigmaLevel = 1;
  for (const [y, s] of sigmaTable) { if (yieldRate >= y) { sigmaLevel = s; break; } }

  // ê³µì •ëŠ¥ë ¥ ê´€ë ¨
  const rates = byDate ? byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100) : [];
  const rateMean = rates.length ? rates.reduce((a,b)=>a+b,0)/rates.length : 0;
  const rateStd = rates.length > 1 ? Math.sqrt(rates.reduce((s,v)=>s+(v-rateMean)*(v-rateMean),0)/(rates.length-1)) : 0;
  const rateMin = rates.length ? Math.min(...rates) : 0;
  const rateMax = rates.length ? Math.max(...rates) : 0;

  // ìµœê·¼ 7ì¼ vs ì´ì „ 7ì¼ ë¹„êµ
  const last7 = rates.slice(-7);
  const prev7 = rates.slice(-14, -7);
  const last7Avg = last7.length ? last7.reduce((a,b)=>a+b,0)/last7.length : 0;
  const prev7Avg = prev7.length ? prev7.reduce((a,b)=>a+b,0)/prev7.length : 0;

  // â”€â”€ ì„¹ì…˜ 1: ì¢…í•© í˜„í™© â”€â”€
  const gradeStyle = overallGrade === 'ìœ„í—˜' ? 'ai-ds-danger' : overallGrade === 'ì£¼ì˜' ? 'ai-ds-warn' : 'ai-ds-safe';
  let s1 = `<div class="ai-ds-body">`;
  s1 += `ì „ì²´ ë¶ˆëŸ‰ë¥  <b>${pct(kpi.ë¶ˆëŸ‰ë¥ )}</b> (ëª©í‘œ: ${targetRate.toFixed(1)}%)`;
  if (kpi.ë¶ˆëŸ‰ë¥  > targetRate * 3) s1 += 'ë¡œ <span style="color:#DC2626;font-weight:700">ëª©í‘œë¥¼ í¬ê²Œ ì´ˆê³¼</span>í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰ê°ì ì¸ ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.';
  else if (kpi.ë¶ˆëŸ‰ë¥  > targetRate) s1 += `ë¡œ <span style="color:#F59E0B;font-weight:700">ëª©í‘œ(${targetRate.toFixed(1)}%) ì´ˆê³¼</span> ìƒíƒœì…ë‹ˆë‹¤. ê°œì„ ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
  else s1 += `ë¡œ <span style="color:#16A34A;font-weight:700">ëª©í‘œ ë‹¬ì„±</span> ìƒíƒœë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.`;
  s1 += `</div>`;
  s1 += `<div class="ai-ds-detail">`;
  s1 += `ë¶„ì„ ëŒ€ìƒ: ${fmt(kpi.í’ˆëª©ìˆ˜)}ê°œ í’ˆëª© / ${fmt(kpi.ìƒì‚°ì¼ìˆ˜)}ì¼ê°„ / ì´ ìƒì‚° ${fmt(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰)}ê°œ<br>`;
  s1 += `ì–‘í’ˆ ${fmt(kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰)}ê°œ (ìˆ˜ìœ¨ ${pct(yieldRate)}) / ë¶ˆëŸ‰ ${fmt(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê°œ<br>`;
  s1 += `ë°±ë§Œê°œë‹¹ ë¶ˆëŸ‰: ${fmt(dpmo)}ê°œ / í’ˆì§ˆ ìˆ˜ì¤€: ${sigmaLevel.toFixed(1)}Ïƒ<br>`;
  s1 += `ì¼ë³„ ë¶ˆëŸ‰ë¥  ë²”ìœ„: ${pct(rateMin)} ~ ${pct(rateMax)} (í‘œì¤€í¸ì°¨ ${pct(rateStd)})`;
  s1 += `</div>`;
  sections.push({ title: 'ğŸ“Š ì¢…í•© í˜„í™©', body: s1, style: gradeStyle });

  // â”€â”€ ì„¹ì…˜ 1-B: ëª©í‘œ ë¶ˆëŸ‰ë¥  ì´ˆê³¼ ì›ì¸ ë¶„ì„ â”€â”€
  const isOverTarget = kpi.ë¶ˆëŸ‰ë¥  > targetRate;
  let sTarget = '';
  if (isOverTarget) {
    const overAmount = kpi.ë¶ˆëŸ‰ë¥  - targetRate;
    const overDays = byDate ? byDate.filter(r => r.ë¶ˆëŸ‰ë¥  * 100 > targetRate).length : 0;
    const totalDays = byDate ? byDate.length : 0;
    const last7Over = byDate ? byDate.slice(-7).filter(r => r.ë¶ˆëŸ‰ë¥  * 100 > targetRate).length : 0;

    sTarget += `<div class="ai-ds-body"><span style="color:#DC2626;font-weight:700">ëª©í‘œ ë¶ˆëŸ‰ë¥  ${targetRate.toFixed(1)}% ëŒ€ë¹„ í˜„ì¬ ${pct(kpi.ë¶ˆëŸ‰ë¥ )}ë¡œ ${overAmount.toFixed(2)}%p ì´ˆê³¼</span>í•˜ê³  ìˆìŠµë‹ˆë‹¤.</div>`;
    sTarget += `<div class="ai-ds-detail">`;

    // ì¼ë³„ ì´ˆê³¼ í˜„í™©
    sTarget += `<b>ğŸ“… ì¼ë³„ ì´ˆê³¼ í˜„í™©:</b> ì „ì²´ ${totalDays}ì¼ ì¤‘ <b style="color:#DC2626">${overDays}ì¼</b> ì´ˆê³¼ (ì´ˆê³¼ìœ¨ ${(overDays/Math.max(totalDays,1)*100).toFixed(0)}%)`;
    sTarget += ` / ìµœê·¼ 7ì¼ ì¤‘ <b>${last7Over}ì¼</b> ì´ˆê³¼<br>`;

    // í’ˆëª©ë³„ ê¸°ì—¬ë„ ë¶„ì„
    if (riskScores.length > 0) {
      const totalDefects = kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰ || 1;
      const totalProd = kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ || 1;
      const targetDefects = totalProd * targetRate / 100;
      const excessDefects = totalDefects - targetDefects;

      // ë¶ˆëŸ‰ ê¸°ì—¬ë„ê°€ ë†’ì€ í’ˆëª© TOP5
      const topContrib = [...riskScores].sort((a,b) => b.ë¶ˆëŸ‰ìˆ˜ëŸ‰ - a.ë¶ˆëŸ‰ìˆ˜ëŸ‰).slice(0, 5);
      sTarget += `<br><b>ğŸ­ ëª©í‘œ ì´ˆê³¼ ì£¼ìš” ì›ì¸ í’ˆëª© (TOP 5):</b><br>`;
      topContrib.forEach((r, i) => {
        const contrib = (r.ë¶ˆëŸ‰ìˆ˜ëŸ‰ / totalDefects * 100).toFixed(1);
        const itemRate = r.ë¶ˆëŸ‰ë¥ ;
        const potential = r.ìƒì‚°ìˆ˜ëŸ‰ > 0 ? ((r.ë¶ˆëŸ‰ìˆ˜ëŸ‰ - r.ìƒì‚°ìˆ˜ëŸ‰ * targetRate / 100) / totalProd * 100) : 0;
        const potentialText = potential > 0 ? `ì´ í’ˆëª©ì„ ëª©í‘œ ìˆ˜ì¤€ìœ¼ë¡œ ê°œì„ í•˜ë©´ ì „ì²´ ë¶ˆëŸ‰ë¥  ì•½ ${potential.toFixed(2)}%p ê°ì†Œ` : '';
        sTarget += `&nbsp;&nbsp;${i+1}. <b>${r.í’ˆëª…}</b> â€” ë¶ˆëŸ‰ë¥  ${pct(itemRate)}, ë¶ˆëŸ‰ ${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê°œ (ì „ì²´ ë¶ˆëŸ‰ì˜ <b>${contrib}%</b>)`;
        if (potentialText) sTarget += `<br>&nbsp;&nbsp;&nbsp;&nbsp;â†³ <span style="color:#2563EB">${potentialText}</span>`;
        sTarget += `<br>`;
      });

      // ê°œì„  ì‹œë®¬ë ˆì´ì…˜
      const top3 = topContrib.slice(0, 3);
      let simDefects = totalDefects;
      top3.forEach(r => {
        if (r.ìƒì‚°ìˆ˜ëŸ‰ > 0) {
          const currentDef = r.ë¶ˆëŸ‰ìˆ˜ëŸ‰;
          const targetDef = r.ìƒì‚°ìˆ˜ëŸ‰ * targetRate / 100;
          if (currentDef > targetDef) simDefects -= (currentDef - targetDef);
        }
      });
      const simRate = simDefects / totalProd * 100;
      sTarget += `<br><b>ğŸ“Š ê°œì„  ì‹œë®¬ë ˆì´ì…˜:</b> TOP 3 í’ˆëª©(${top3.map(r=>r.í’ˆëª…).join(', ')})ì„ ëª©í‘œ ìˆ˜ì¤€ìœ¼ë¡œ ê°œì„ í•˜ë©´<br>`;
      sTarget += `&nbsp;&nbsp;â†’ ì „ì²´ ë¶ˆëŸ‰ë¥ ì´ <b style="color:${simRate <= targetRate ? '#16A34A' : '#F59E0B'}">${pct(simRate)}</b>ë¡œ ${simRate <= targetRate ? 'ëª©í‘œ ë‹¬ì„± ê°€ëŠ¥' : 'ê°œì„ ë˜ë‚˜ ì¶”ê°€ ì¡°ì¹˜ í•„ìš”'}<br>`;
    }

    // ë¶ˆëŸ‰ìœ í˜•ë³„ ê¸°ì—¬ë„
    if (defectTypes.trends && defectTypes.trends.length > 0) {
      const sortedTypes = [...defectTypes.trends].sort((a,b) => b.total - a.total);
      const totalTypeBad = sortedTypes.reduce((s,t) => s + t.total, 0) || 1;
      sTarget += `<br><b>ğŸ” ë¶ˆëŸ‰ìœ í˜•ë³„ ê¸°ì—¬ë„:</b><br>`;
      sortedTypes.slice(0, 5).forEach(t => {
        const typeContrib = (t.total / totalTypeBad * 100).toFixed(1);
        const trendIcon = t.direction === 'ì¦ê°€' ? 'ğŸ”º' : t.direction === 'ê°ì†Œ' ? 'ğŸ”½' : 'â¡ï¸';
        sTarget += `&nbsp;&nbsp;${trendIcon} ${t.type}: ${fmt(t.total)}ê±´ (${typeContrib}%) â€” ${t.direction} ì¶”ì„¸<br>`;
      });
    }

    sTarget += `</div>`;
    sections.push({ title: 'ğŸ¯ ëª©í‘œ ë¶ˆëŸ‰ë¥  ì´ˆê³¼ ì›ì¸ ë¶„ì„', body: sTarget, style: 'ai-ds-danger' });
  } else {
    sTarget += `<div class="ai-ds-body"><span style="color:#16A34A;font-weight:700">í˜„ì¬ ë¶ˆëŸ‰ë¥  ${pct(kpi.ë¶ˆëŸ‰ë¥ )}ë¡œ ëª©í‘œ(${targetRate.toFixed(1)}%)ë¥¼ ë‹¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.</span></div>`;
    sTarget += `<div class="ai-ds-detail">ëª©í‘œ ëŒ€ë¹„ ì—¬ìœ : ${(targetRate - kpi.ë¶ˆëŸ‰ë¥ ).toFixed(2)}%p<br>`;
    const nearItems = riskScores.filter(r => r.ë¶ˆëŸ‰ë¥  > targetRate);
    if (nearItems.length > 0) {
      sTarget += `ë‹¨, ê°œë³„ í’ˆëª© ì¤‘ ëª©í‘œ ì´ˆê³¼ í’ˆëª©ì´ <b>${nearItems.length}ê°œ</b> ìˆìŠµë‹ˆë‹¤: ${nearItems.slice(0,3).map(r => r.í’ˆëª… + '(' + pct(r.ë¶ˆëŸ‰ë¥ ) + ')').join(', ')}${nearItems.length>3?' ì™¸ '+(nearItems.length-3)+'ê±´':''}`;
    }
    sTarget += `</div>`;
    sections.push({ title: 'ğŸ¯ ëª©í‘œ ë¶ˆëŸ‰ë¥  ë‹¬ì„± í˜„í™©', body: sTarget, style: 'ai-ds-safe' });
  }

  // â”€â”€ ì„¹ì…˜ 2: í’ˆëª© ìœ„í—˜ë„ ë¶„ì„ â”€â”€
  let s2 = `<div class="ai-ds-body">`;
  s2 += `ì „ì²´ ${riskScores.length}ê°œ í’ˆëª© ì¤‘ `;
  s2 += `<span style="color:#DC2626;font-weight:700">ìœ„í—˜ ${dangerItems.length}ê±´</span>, `;
  s2 += `<span style="color:#F59E0B;font-weight:700">ì£¼ì˜ ${warnItems.length}ê±´</span>, `;
  s2 += `<span style="color:#16A34A;font-weight:700">ì•ˆì „ ${safeItems.length}ê±´</span>ì…ë‹ˆë‹¤.`;
  s2 += `</div>`;
  s2 += `<div class="ai-ds-detail">`;
  if (dangerItems.length > 0) {
    s2 += `<b style="color:#DC2626">â–¶ ìœ„í—˜ í’ˆëª©:</b><br>`;
    dangerItems.slice(0, 5).forEach((r, i) => {
      s2 += `&nbsp;&nbsp;${i+1}. <b>${r.í’ˆëª…}</b> â€” ë¶ˆëŸ‰ë¥  ${pct(r.ë¶ˆëŸ‰ë¥ )}, ë¶ˆëŸ‰ ${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê°œ/ìƒì‚° ${fmt(r.ìƒì‚°ìˆ˜ëŸ‰)}ê°œ, ìœ„í—˜ì ìˆ˜ ${r.score}ì `;
      s2 += ` (ë¶ˆëŸ‰ë¥ ${r.rateScore}+ì¶”ì„¸${r.slopeScore}+ê·œëª¨${r.prodScore}+ë³€ë™${r.volScore})`;
      s2 += ` [ê·œì¹™:${r.ruleLabel}, ì‹ ë¢°ë„:${r.sampleConfidence}%]<br>`;
      s2 += `&nbsp;&nbsp;&nbsp;&nbsp;â†³ ${r.reason}<br>`;
    });
  }
  if (warnItems.length > 0) {
    s2 += `<b style="color:#F59E0B">â–¶ ì£¼ì˜ í’ˆëª©:</b> `;
    s2 += warnItems.slice(0,5).map(r => `${r.í’ˆëª…}(${pct(r.ë¶ˆëŸ‰ë¥ )}, ${r.score}ì )`).join(', ');
    if (warnItems.length > 5) s2 += ` ì™¸ ${warnItems.length-5}ê±´`;
    s2 += `<br>`;
  }
  if (dangerItems.length === 0 && warnItems.length === 0) {
    s2 += 'ëª¨ë“  í’ˆëª©ì´ ì•ˆì „ ë“±ê¸‰ì…ë‹ˆë‹¤. í˜„ì¬ ìƒíƒœë¥¼ ìœ ì§€í•˜ì„¸ìš”.<br>';
  }
  s2 += `</div>`;
  const s2style = dangerItems.length >= 3 ? 'ai-ds-danger' : dangerItems.length > 0 ? 'ai-ds-warn' : warnItems.length > 0 ? 'ai-ds-warn' : 'ai-ds-safe';
  sections.push({ title: 'ğŸ¯ í’ˆëª© ìœ„í—˜ë„ ë¶„ì„', body: s2, style: s2style });

  // â”€â”€ ì„¹ì…˜ 3: ì¶”ì„¸ ë° ë³€ë™ ë¶„ì„ â”€â”€
  const directionMap = { 'ê¸‰ë“±':'ğŸ”º ê¸‰ë“± ì¶”ì„¸ â€” ê¸´ê¸‰ ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤', 'ìƒìŠ¹':'ğŸ”¼ ìƒìŠ¹ ì¶”ì„¸ â€” ì£¼ì˜ê°€ í•„ìš”í•©ë‹ˆë‹¤',
    'ì•ˆì •':'â¡ï¸ ì•ˆì • ì¶”ì„¸ â€” í˜„ì¬ ìˆ˜ì¤€ì„ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤', 'ê°œì„ ':'ğŸ”½ ê°œì„  ì¶”ì„¸ â€” ë¶ˆëŸ‰ë¥ ì´ ê°ì†Œí•˜ê³  ìˆìŠµë‹ˆë‹¤', 'ê¸‰ê°':'â¬ ê¸‰ê° ì¶”ì„¸ â€” ë¹ ë¥´ê²Œ ê°œì„ ë˜ê³  ìˆìŠµë‹ˆë‹¤' };
  let s3 = `<div class="ai-ds-body">${directionMap[trends.direction]}</div>`;
  s3 += `<div class="ai-ds-detail">`;
  if (trends.weekChange !== 0) {
    s3 += `ì „ì£¼ ëŒ€ë¹„: ${trends.weekChange > 0 ? '<span style="color:#DC2626">â–² '+pct(Math.abs(trends.weekChange))+' ì•…í™”</span>' : '<span style="color:#16A34A">â–¼ '+pct(Math.abs(trends.weekChange))+' ê°œì„ </span>'}<br>`;
  }
  if (trends.monthChange !== 0) {
    s3 += `ì „ì›” ëŒ€ë¹„: ${trends.monthChange > 0 ? '<span style="color:#DC2626">â–² '+pct(Math.abs(trends.monthChange))+' ì•…í™”</span>' : '<span style="color:#16A34A">â–¼ '+pct(Math.abs(trends.monthChange))+' ê°œì„ </span>'}<br>`;
  }
  if (last7.length && prev7.length) {
    s3 += `ìµœê·¼ 7ì¼ í‰ê· : ${pct(last7Avg)} (ì´ì „ 7ì¼: ${pct(prev7Avg)})<br>`;
  }
  if (trends.crossType === 'dead') s3 += '<span style="color:#DC2626;font-weight:700">âš  ë¶ˆëŸ‰ë¥  ì•…í™” ì‹ í˜¸ ê°ì§€</span> â€” ë‹¨ê¸° í‰ê· ì´ ì¥ê¸° í‰ê· ì„ ë„˜ì–´ì„¬, ì•…í™” ê°€ì† ê°€ëŠ¥<br>';
  if (trends.crossType === 'golden') s3 += '<span style="color:#16A34A;font-weight:700">âœ“ ë¶ˆëŸ‰ë¥  ê°œì„  ì‹ í˜¸ ê°ì§€</span> â€” ë‹¨ê¸° í‰ê· ì´ ì¥ê¸° í‰ê·  ì•„ë˜ë¡œ ë‚´ë ¤ê°, ê°œì„  ì§„í–‰ ì¤‘<br>';
  if (trends.consecutiveWorsen >= 3) s3 += `<span style="color:#DC2626">âš  ${trends.consecutiveWorsen}ì¼ ì—°ì† ì•…í™” ì¤‘</span><br>`;
  if (trends.consecutiveImprove >= 3) s3 += `<span style="color:#16A34A">âœ“ ${trends.consecutiveImprove}ì¼ ì—°ì† ê°œì„  ì¤‘</span><br>`;
  s3 += `</div>`;
  const s3style = trends.direction === 'ê¸‰ë“±' || trends.direction === 'ìƒìŠ¹' ? 'ai-ds-warn' : trends.direction === 'ì•ˆì •' ? 'ai-ds-info' : 'ai-ds-safe';
  sections.push({ title: 'ğŸ“ˆ ì¶”ì„¸ ë° ë³€ë™ ë¶„ì„', body: s3, style: s3style });

  // â”€â”€ ì„¹ì…˜ 4: ì´ìƒ ì§•í›„ ë¶„ì„ â”€â”€
  const uclCount = anomalies.filter(a => a.type === 'ucl').length;
  const zCount = anomalies.filter(a => a.type === 'zscore').length;
  const spikeCount = anomalies.filter(a => a.type === 'spike').length;
  const ruleCount = anomalies.filter(a => a.type === 'trend7' || a.type === 'bias8').length;
  let s4 = `<div class="ai-ds-body">ì´ <b>${anomalies.length}ê±´</b>ì˜ ì´ìƒ ì§•í›„ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.</div>`;
  s4 += `<div class="ai-ds-detail">`;
  if (uclCount > 0) s4 += `ê´€ë¦¬ í—ˆìš©ë²”ìœ„ ì´ˆê³¼: <b style="color:#DC2626">${uclCount}ê±´</b> â€” ê³µì •ì´ ì •ìƒ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¨<br>`;
  if (zCount > 0) s4 += `ê·¹ë‹¨ê°’ ë°œìƒ: <b style="color:#DC2626">${zCount}ê±´</b> â€” í‰ê· ê³¼ í¬ê²Œ ë‹¤ë¥¸ ì´ìƒ ê°’ ê°ì§€<br>`;
  if (spikeCount > 0) s4 += `ì¼ê°„ ê¸‰ë“± (2Ïƒ ì´ˆê³¼ ë³€ë™): <b style="color:#F59E0B">${spikeCount}ê±´</b> â€” ì „ì¼ ëŒ€ë¹„ ê¸‰ê²©í•œ ìƒìŠ¹<br>`;
  if (ruleCount > 0) s4 += `SPC ê·œì¹™ ìœ„ë°˜: <b style="color:#F59E0B">${ruleCount}ê±´</b> â€” ì—°ì† ì¶”ì„¸/í¸ì¸¡ íŒ¨í„´ ê°ì§€<br>`;
  if (anomalies.length === 0) s4 += 'í˜„ì¬ ì´ìƒ ì§•í›„ê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê³µì •ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.<br>';
  s4 += `</div>`;
  const s4style = uclCount >= 3 || zCount >= 3 ? 'ai-ds-danger' : anomalies.length > 0 ? 'ai-ds-warn' : 'ai-ds-safe';
  sections.push({ title: 'âš ï¸ ì´ìƒ ì§•í›„ ë¶„ì„', body: s4, style: s4style });

  // â”€â”€ ì„¹ì…˜ 5: ë¶ˆëŸ‰ìœ í˜• ìƒì„¸ ë¶„ì„ â”€â”€
  if (defectCols.length > 0) {
    let s5 = `<div class="ai-ds-body">`;
    if (defectTypes.dominant) {
      s5 += `ë¶ˆëŸ‰ì´ <b>${defectTypes.dominant}</b>ì— ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ì§‘ì¤‘ë„ ${(defectTypes.hhi*100).toFixed(0)}%).`;
    } else {
      s5 += `ë¶ˆëŸ‰ì´ ì—¬ëŸ¬ ìœ í˜•ì— ë¶„ì‚°ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ì§‘ì¤‘ë„ ${(defectTypes.hhi*100).toFixed(0)}%).`;
    }
    s5 += `</div><div class="ai-ds-detail">`;
    if (defectTypes.trends.length > 0) {
      const increasing = defectTypes.trends.filter(t => t.direction === 'ì¦ê°€' && t.total > 0);
      const decreasing = defectTypes.trends.filter(t => t.direction === 'ê°ì†Œ' && t.total > 0);
      if (increasing.length > 0) {
        s5 += `<span style="color:#DC2626">â–² ì¦ê°€ ì¶”ì„¸:</span> ${increasing.map(t => `${t.type}(ê¸°ìš¸ê¸° ${t.slope.toFixed(2)}, ì´ ${fmt(t.total)}ê±´)`).join(', ')}<br>`;
      }
      if (decreasing.length > 0) {
        s5 += `<span style="color:#16A34A">â–¼ ê°ì†Œ ì¶”ì„¸:</span> ${decreasing.map(t => `${t.type}(ê¸°ìš¸ê¸° ${t.slope.toFixed(2)}, ì´ ${fmt(t.total)}ê±´)`).join(', ')}<br>`;
      }
      const stable = defectTypes.trends.filter(t => t.direction === 'ì•ˆì •' && t.total > 0);
      if (stable.length > 0) {
        s5 += `â¡ï¸ ì•ˆì •: ${stable.map(t => `${t.type}(${fmt(t.total)}ê±´)`).join(', ')}<br>`;
      }
    }
    if (defectTypes.newTypes.length > 0) {
      s5 += `<span style="color:#DC2626;font-weight:700">âš  ì‹ ê·œ ë¶ˆëŸ‰ìœ í˜• ë°œìƒ:</span> ${defectTypes.newTypes.join(', ')} â€” í›„ë°˜ê¸°ì— ìƒˆë¡œ ë‚˜íƒ€ë‚¨<br>`;
    }
    if (defectTypes.disappearedTypes.length > 0) {
      s5 += `<span style="color:#16A34A">âœ“ ì†Œë©¸ ë¶ˆëŸ‰ìœ í˜•:</span> ${defectTypes.disappearedTypes.join(', ')} â€” í›„ë°˜ê¸°ì— ì‚¬ë¼ì§<br>`;
    }
    s5 += `</div>`;
    sections.push({ title: 'ğŸ”¬ ë¶ˆëŸ‰ìœ í˜• ìƒì„¸ ë¶„ì„', body: s5, style: defectTypes.dominant ? 'ai-ds-warn' : 'ai-ds-info' });
  }

  // â”€â”€ ì„¹ì…˜ 6: ê³µì • ì•ˆì •ì„± â”€â”€
  const totalBad = byDate ? byDate.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0) : 0;
  const totalProd = byDate ? byDate.reduce((s,r)=>s+r.ìƒì‚°ìˆ˜ëŸ‰,0) : 1;
  const pBar = totalProd ? totalBad/totalProd : 0;
  let s6 = `<div class="ai-ds-body">`;
  if (uclCount === 0 && ruleCount === 0) s6 += `ê³µì •ì´ <b style="color:#16A34A">í†µê³„ì ìœ¼ë¡œ ì•ˆì •</b> ìƒíƒœì…ë‹ˆë‹¤.`;
  else s6 += `ê³µì •ì´ <b style="color:#DC2626">ë¶ˆì•ˆì •</b> ìƒíƒœì…ë‹ˆë‹¤. íŠ¹ë³„ ì›ì¸ ì¡°ì‚¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.`;
  s6 += `</div><div class="ai-ds-detail">`;
  s6 += `ì „ì²´ í‰ê·  ë¶ˆëŸ‰ë¥ : ${pct(pBar*100)}<br>`;
  s6 += `ê´€ë¦¬í•œê³„ ì´íƒˆ: ${uclCount}ê±´ / SPC ê·œì¹™ ìœ„ë°˜: ${ruleCount}ê±´<br>`;
  s6 += `ê³µì • ë³€ë™: ${rateMean > 0 && rateStd/rateMean < 0.3 ? 'ì•ˆì •ì  (ì¼ë³„ í¸ì°¨ê°€ ì‘ìŒ)' : 'ë³€ë™ì´ í¼ (ì¼ë³„ í¸ì°¨ ì£¼ì˜)'}<br>`;
  s6 += `</div>`;
  sections.push({ title: 'ğŸ­ ê³µì • ì•ˆì •ì„±', body: s6, style: uclCount === 0 && ruleCount === 0 ? 'ai-ds-safe' : 'ai-ds-danger' });

  // â”€â”€ ì„¹ì…˜ 7: ê¶Œì¥ ì¡°ì¹˜ â”€â”€
  const actions = [];
  if (dangerItems.length > 0) actions.push({ priority: 'ê¸´ê¸‰', text: `ìœ„í—˜ í’ˆëª©(${dangerItems.slice(0,3).map(r=>r.í’ˆëª…).join(', ')}) ê³µì • ê¸´ê¸‰ ì ê²€ ë° ì›ì¸ ë¶„ì„`, detail: 'ë¶ˆëŸ‰ë¥ ê³¼ ìœ„í—˜ì ìˆ˜ê°€ ë†’ì€ í’ˆëª©ì˜ ìƒì‚° ë¼ì¸ì„ ì¦‰ì‹œ ì ê²€í•˜ì„¸ìš”.' });
  if (trends.direction === 'ê¸‰ë“±') actions.push({ priority: 'ê¸´ê¸‰', text: 'ë¶ˆëŸ‰ë¥  ê¸‰ë“± ì›ì¸ ê¸´ê¸‰ íŒŒì•…', detail: 'ì„¤ë¹„ ì´ìƒ, ì›ìì¬ ë³€ê²½, ì‘ì—… ì¡°ê±´ ë³€í™” ë“±ì„ ì¦‰ì‹œ í™•ì¸í•˜ì„¸ìš”.' });
  if (trends.direction === 'ìƒìŠ¹') actions.push({ priority: 'ë†’ìŒ', text: 'ë¶ˆëŸ‰ë¥  ìƒìŠ¹ ì›ì¸ ë¶„ì„ ë° ëŒ€ì±… ìˆ˜ë¦½', detail: 'ì¶”ì„¸ê°€ ê³„ì†ë˜ê¸° ì „ì— ì¡°ê¸° ëŒ€ì‘ì´ í•„ìš”í•©ë‹ˆë‹¤.' });
  if (uclCount > 0) actions.push({ priority: 'ë†’ìŒ', text: `ê´€ë¦¬ë²”ìœ„ ì´ˆê³¼(${uclCount}ê±´) ì›ì¸ ì¡°ì‚¬`, detail: 'ì´íƒˆ ë°œìƒì¼ì˜ ì‘ì—… ì¼ì§€, ì„¤ë¹„ ìƒíƒœ, ì›ìì¬ ë¡œíŠ¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.' });
  if (anomalies.filter(a=>a.type==='spike').length > 0) actions.push({ priority: 'ë†’ìŒ', text: 'ì¼ê°„ ê¸‰ë“± ë°œìƒì¼ ì›ì¸ ì¡°ì‚¬', detail: 'ê¸‰ë“± ë‹¹ì¼ì˜ íŠ¹ì´ì‚¬í•­(ì„¤ë¹„ êµì²´, ì‘ì—…ì ë³€ê²½ ë“±)ì„ í™•ì¸í•˜ì„¸ìš”.' });
  if (defectTypes.dominant) actions.push({ priority: 'ì¤‘ê°„', text: `ì§‘ì¤‘ ë¶ˆëŸ‰ìœ í˜•(${defectTypes.dominant}) ê°œì„  í™œë™ ì¶”ì§„`, detail: 'íŒŒë ˆí†  ì›ì¹™ì— ë”°ë¼ ì£¼ìš” ë¶ˆëŸ‰ìœ í˜• ê°œì„ ì´ ê°€ì¥ íš¨ê³¼ì ì…ë‹ˆë‹¤.' });
  if (defectTypes.newTypes.length > 0) actions.push({ priority: 'ì¤‘ê°„', text: `ì‹ ê·œ ë¶ˆëŸ‰ìœ í˜•(${defectTypes.newTypes.join(', ')}) ì›ì¸ íŒŒì•…`, detail: 'ìµœê·¼ ìƒˆë¡œ ë°œìƒí•œ ë¶ˆëŸ‰ìœ í˜•ì˜ ë°œìƒ ì›ì¸ê³¼ íŒ¨í„´ì„ ë¶„ì„í•˜ì„¸ìš”.' });
  if (trends.consecutiveWorsen >= 3) actions.push({ priority: 'ì¤‘ê°„', text: `${trends.consecutiveWorsen}ì¼ ì—°ì† ì•…í™” ì¶”ì„¸ ëŒ€ì‘`, detail: 'ì²´ê³„ì ì¸ ì›ì¸ ë¶„ì„(4M ë¶„ì„ ë“±)ì„ í†µí•´ ê·¼ë³¸ ì›ì¸ì„ íŒŒì•…í•˜ì„¸ìš”.' });
  if (warnItems.length > 3) actions.push({ priority: 'ë³´í†µ', text: `ì£¼ì˜ í’ˆëª© ${warnItems.length}ê±´ ëª¨ë‹ˆí„°ë§ ê°•í™”`, detail: 'ìœ„í—˜ ë“±ê¸‰ìœ¼ë¡œ ìƒìŠ¹í•˜ì§€ ì•Šë„ë¡ ì¼ë³„ ëª¨ë‹ˆí„°ë§ì„ ì‹¤ì‹œí•˜ì„¸ìš”.' });
  if (actions.length === 0) actions.push({ priority: 'ë³´í†µ', text: 'í˜„ì¬ ìƒíƒœ ìœ ì§€ ë° ì§€ì†ì  ëª¨ë‹ˆí„°ë§', detail: 'ì•ˆì •ì ì¸ ìƒíƒœì´ë‚˜ ì •ê¸°ì  í™•ì¸ì„ ê³„ì†í•˜ì„¸ìš”.' });

  let s7 = `<div class="ai-ds-detail">`;
  actions.forEach((a, i) => {
    const pColor = a.priority === 'ê¸´ê¸‰' ? '#DC2626' : a.priority === 'ë†’ìŒ' ? '#F59E0B' : a.priority === 'ì¤‘ê°„' ? '#2563EB' : '#6B7280';
    s7 += `<div style="margin-bottom:8px"><span style="display:inline-block;padding:1px 8px;border-radius:4px;font-size:11px;font-weight:700;background:${pColor}20;color:${pColor}">${a.priority}</span> `;
    s7 += `<b>${i+1}. ${a.text}</b><br>`;
    s7 += `<span style="margin-left:16px;color:var(--text-light)">${a.detail}</span></div>`;
  });
  s7 += `</div>`;
  sections.push({ title: 'âœ… ê¶Œì¥ ì¡°ì¹˜', body: s7, style: 'ai-ds-info' });

  return { overallGrade, sections, stats: { dpmo, sigmaLevel, yieldRate, rateStd, rateMean, rateMin, rateMax, last7Avg, prev7Avg } };
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” ì‹œê°í™”: ìŠ¤íŒŒí¬ë¼ì¸
   ================================================================ */
function renderSparkline(container, values, color) {
  if (!container || !values || values.length < 2) return;
  const w = container.clientWidth || 100, h = container.clientHeight || 32;
  const canvas = document.createElement('canvas');
  canvas.width = w; canvas.height = h;
  container.appendChild(canvas);
  const ctx = canvas.getContext('2d');
  const min = Math.min(...values), max = Math.max(...values);
  const range = max - min || 1;
  const step = w / (values.length - 1);
  ctx.strokeStyle = color || '#2563EB';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  values.forEach((v, i) => {
    const x = i * step;
    const y = h - 3 - (v - min) / range * (h - 6);
    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
  });
  ctx.stroke();
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” ì‹œê°í™”: ìœ„í—˜ë„ ë§¤íŠ¸ë¦­ìŠ¤ ì‚°ì ë„
   ================================================================ */
function chartRiskMatrix(riskScores, el) {
  if (!riskScores.length) { el.innerHTML='<p style="color:var(--text-light);padding:20px">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
  const mb = isMobile();
  const maxLen = mb ? 10 : 20;
  Plotly.newPlot(el, [{
    x: riskScores.map(r => r.ìƒì‚°ìˆ˜ëŸ‰),
    y: riskScores.map(r => r.ë¶ˆëŸ‰ë¥ ),
    mode: 'markers+text',
    type: 'scatter',
    marker: {
      size: riskScores.map(r => Math.max(r.score / 100 * (mb ? 30 : 50), mb ? 6 : 8)),
      color: riskScores.map(r => r.color),
      opacity: 0.85,
      line: { width: 1.5, color: 'rgba(255,255,255,0.8)' }
    },
    text: riskScores.map(r => r.score >= 40 ? r.í’ˆëª….slice(0, maxLen) : ''),
    textposition: 'top center',
    textfont: { size: mb ? 7 : 9, color: '#374151' },
    hovertemplate: '<b>%{customdata[0]}</b><br>ìƒì‚°: %{x:,}ê°œ<br>ë¶ˆëŸ‰ë¥ : %{y:.2f}%<br>ìœ„í—˜ì ìˆ˜: %{customdata[1]}ì <br>ë“±ê¸‰: %{customdata[2]}<br>ì ìˆ˜ë¶„í•´: ë¶ˆëŸ‰ë¥ %{customdata[3]} + ì¶”ì„¸%{customdata[4]} + ê·œëª¨%{customdata[5]} + ë³€ë™%{customdata[6]}<br>ê·œì¹™: %{customdata[7]} / ì‹ ë¢°ë„: %{customdata[8]}%<br>%{customdata[9]}<extra></extra>',
    customdata: riskScores.map(r => [r.í’ˆëª…, r.score, r.grade, r.rateScore, r.slopeScore, r.prodScore, r.volScore, r.ruleLabel, r.sampleConfidence, r.reason])
  }], {
    xaxis: { title: mb ? '' : 'ìƒì‚°ìˆ˜ëŸ‰', type: 'log', gridcolor: '#E5E7EB' },
    yaxis: { title: mb ? '' : 'ë¶ˆëŸ‰ë¥  (%)', gridcolor: '#E5E7EB' },
    height: chartHeight(450, 340),
    margin: mb ? {t:20,b:40,l:40,r:20} : {t:40,b:50,l:60,r:40},
    shapes: [
      { type:'line', x0:0, x1:1, xref:'paper', y0:3, y1:3,
        line:{color:'#F59E0B',width:1.5,dash:'dot'} },
      { type:'line', x0:0, x1:1, xref:'paper', y0:5, y1:5,
        line:{color:'#DC2626',width:1.5,dash:'dot'} }
    ],
    annotations: [
      { x:0.98, y:1, xref:'paper', yref:'paper', text:'í¬ê¸° = ìœ„í—˜ì ìˆ˜', showarrow:false,
        font:{size:mb?9:11,color:'var(--text-light)'}, xanchor:'right', yanchor:'top' }
    ]
  }, getPlotCfg());
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” ì‹œê°í™”: ë¶ˆëŸ‰ìœ í˜•ë³„ ì¶”ì„¸ ì°¨íŠ¸
   ================================================================ */
function chartDefectTrends(byDate, defectTypeAnalysis, el) {
  if (!defectCols.length || !byDate || byDate.length < 2) {
    el.innerHTML='<p style="color:var(--text-light);padding:20px">ë¶ˆëŸ‰ìœ í˜• ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>'; return;
  }
  const mb = isMobile();
  const dates = byDate.map(r => dateKR(r.ìƒì‚°ì¼ì));
  const active = defectCols.filter(dc => byDate.some(r => (r[dc]||0) > 0));
  const traces = active.map((dc, i) => ({
    x: dates, y: byDate.map(r => r[dc] || 0), type:'scatter', mode:'lines+markers',
    name: dc, line: { color: PALETTE[i % PALETTE.length], width: 2 },
    marker: { size: mb ? 3 : 5 }
  }));

  // ê¸°ìš¸ê¸° ë°©í–¥ ì£¼ì„
  const annotations = [];
  if (defectTypeAnalysis && defectTypeAnalysis.trends) {
    defectTypeAnalysis.trends.filter(t => t.total > 0).slice(0, 5).forEach((t, i) => {
      const arrow = t.direction === 'ì¦ê°€' ? 'â†‘' : t.direction === 'ê°ì†Œ' ? 'â†“' : 'â†’';
      const color = t.direction === 'ì¦ê°€' ? '#DC2626' : t.direction === 'ê°ì†Œ' ? '#16A34A' : '#6B7280';
      annotations.push({
        x: 1.02, y: 1 - i * 0.12, xref:'paper', yref:'paper', showarrow: false,
        text: `${arrow} ${t.type}`, font: { size: mb ? 9 : 11, color },
        xanchor: 'left', yanchor: 'top'
      });
    });
  }

  Plotly.newPlot(el, traces, {
    title: mb ? '' : 'ë¶ˆëŸ‰ìœ í˜•ë³„ ì¶”ì„¸',
    yaxis: { title: mb ? '' : 'ë¶ˆëŸ‰ ê±´ìˆ˜' },
    legend: { orientation:'h', y: mb ? 1.2 : 1.14, font: {size: mb ? 9 : 11} },
    height: chartHeight(420, 300),
    margin: mb ? {t:30,b:40,l:35,r:60} : {t:50,b:50,l:60,r:120},
    annotations
  }, getPlotCfg());
}

/* ================================================================
   AI í’ˆì§ˆì§„ë‹¨ â€” ë©”ì¸ ë Œë”ë§ í•¨ìˆ˜
   ================================================================ */
function renderAIDiagnosis(kpi, byDate, byItem, filtered) {
  const el = $('tab9');
  if (!el) return;

  if (!byDate || !byDate.length || !byItem || !byItem.length) {
    el.innerHTML = '<div class="ai-diagnosis-box"><h3>AI í’ˆì§ˆì§„ë‹¨</h3><p style="color:var(--text-light)">ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ ì‹œì‘í•˜ì„¸ìš”.</p></div>';
    return;
  }
  aiRenderContext = { kpi, byDate, byItem, filtered };

  // 5ê°œ ë¶„ì„ ì—”ì§„ ì‹¤í–‰
  const trends = analyzeTrends(byDate, filtered);
  const anomalies = detectAnomalies(byDate);
  const defectTypes = analyzeDefectTypes(byDate);
  const riskScores = calcItemRiskScores(byItem, filtered, aiRiskSettings);
  const diagnosis = generateDiagnosisText(kpi, trends, anomalies, defectTypes, riskScores, byDate, targetDefectRate);

  const dangerItems = riskScores.filter(r => r.grade === 'ìœ„í—˜');
  const warnItems = riskScores.filter(r => r.grade === 'ì£¼ì˜');
  const safeItems = riskScores.filter(r => r.grade === 'ì•ˆì „');
  const dangerAnomalies = anomalies.filter(a => a.severity === 'danger');
  const st = diagnosis.stats;
  const mb = isMobile();

  // ì¢…í•© í’ˆì§ˆ ì ìˆ˜
  const qs = calcQualityScore(kpi, trends, anomalies, riskScores, st);

  let html = '';

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ZONE 1: ì´ˆë³´ì ì˜ì—­ (í•­ìƒ í‘œì‹œ)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  // [1] ì¢…í•© í’ˆì§ˆ ì ìˆ˜ ê²Œì´ì§€
  const heroEmoji = qs.score >= 75 ? 'ğŸ‰' : qs.score >= 60 ? 'ğŸ‘€' : qs.score >= 45 ? 'âš ï¸' : 'ğŸš¨';
  html += `<div class="ai-gauge-section">
    <div class="ai-gauge-wrap">${drawQualityGaugeHTML(qs.score, qs.letterGrade, qs.color)}</div>
    <div class="ai-gauge-verdict">
      <div class="ai-gauge-grade" style="color:${qs.color}">${heroEmoji} í’ˆì§ˆ ë“±ê¸‰ ${qs.letterGrade}</div>
      <div class="ai-gauge-text">${qs.verdict}</div>
      <div class="ai-gauge-sub">ë¶„ì„ ê¸°ê°„: ${fmt(kpi.ìƒì‚°ì¼ìˆ˜)}ì¼ / ${fmt(kpi.í’ˆëª©ìˆ˜)}ê°œ í’ˆëª© / ì´ ìƒì‚° ${fmt(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰)}ê°œ</div>
    </div>
  </div>`;

  // [2] í•œëˆˆì— ë³´ëŠ” ìš”ì•½
  const per100 = kpi.ë¶ˆëŸ‰ë¥ .toFixed(1);
  const rateColor = kpi.ë¶ˆëŸ‰ë¥  >= 5 ? '#DC2626' : kpi.ë¶ˆëŸ‰ë¥  >= 3 ? '#F59E0B' : kpi.ë¶ˆëŸ‰ë¥  >= 1 ? '#2563EB' : '#16A34A';
  const weekArrow = trends.weekChange > 0 ? 'â–²' : trends.weekChange < 0 ? 'â–¼' : 'â”€';
  const weekColor = trends.weekChange > 0 ? '#DC2626' : trends.weekChange < 0 ? '#16A34A' : '#6B7280';
  const weekLabel = trends.weekChange > 0 ? 'ì•…í™”' : trends.weekChange < 0 ? 'ê°œì„ ' : 'ë³€ë™ì—†ìŒ';
  const trendArrow = { 'ê¸‰ë“±':'â–²â–²', 'ìƒìŠ¹':'â–²', 'ì•ˆì •':'â”€', 'ê°œì„ ':'â–¼', 'ê¸‰ê°':'â–¼â–¼' };
  const trendColor = (trends.direction==='ê¸‰ë“±'||trends.direction==='ìƒìŠ¹') ? '#DC2626' : (trends.direction==='ê°œì„ '||trends.direction==='ê¸‰ê°') ? '#16A34A' : '#6B7280';
  const trendDesc = trends.consecutiveWorsen >= 3 ? `${trends.consecutiveWorsen}ì¼ ì—°ì† ì•…í™” ì¤‘`
    : trends.consecutiveImprove >= 3 ? `${trends.consecutiveImprove}ì¼ ì—°ì† ê°œì„  ì¤‘` : 'ì•ˆì •ì  íë¦„';

  html += `<div class="ai-summary-box">
    <div class="ai-summary-hero">
      <span class="ai-summary-icon">ğŸ“¦</span>
      <div class="ai-summary-main">ì œí’ˆ <b>100ê°œ</b>ë¥¼ ë§Œë“¤ë©´ <b style="color:${rateColor};font-size:24px">${per100}ê°œ</b>ê°€ ë¶ˆëŸ‰ì…ë‹ˆë‹¤</div>
    </div>
    <div class="ai-summary-stats">
      <div class="ai-ss-item">
        <span class="ai-ss-label">ì „ì£¼ ëŒ€ë¹„</span>
        <span class="ai-ss-val" style="color:${weekColor}">${weekArrow} ${pct(Math.abs(trends.weekChange))}</span>
        <span class="ai-ss-sub">${weekLabel}</span>
      </div>
      <div class="ai-ss-item">
        <span class="ai-ss-label">ìµœê·¼ ì¶”ì´</span>
        <span class="ai-ss-val" style="color:${trendColor}">${trendArrow[trends.direction]||'â”€'} ${trends.direction}</span>
        <span class="ai-ss-sub">${trendDesc}</span>
      </div>
      <div class="ai-ss-item">
        <span class="ai-ss-label">ì–‘í’ˆë¥ </span>
        <span class="ai-ss-val" style="color:var(--success)">${pct(st.yieldRate)}</span>
        <span class="ai-ss-sub">ì–‘í’ˆ ${fmt(kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰)}ê°œ</span>
      </div>
      <div class="ai-ss-item">
        <span class="ai-ss-label">ì‹œê·¸ë§ˆ ìˆ˜ì¤€</span>
        <span class="ai-ss-val" style="color:var(--primary)">${st.sigmaLevel.toFixed(1)}Ïƒ</span>
        <span class="ai-ss-sub">${st.sigmaLevel >= 4 ? 'ìš°ìˆ˜' : st.sigmaLevel >= 3 ? 'ì–‘í˜¸' : st.sigmaLevel >= 2 ? 'ë³´í†µ' : 'ê°œì„ í•„ìš”'}</span>
      </div>
    </div>
  </div>`;

  // [3] í’ˆì§ˆ ê±´ê°• ì²´í¬ë¦¬ìŠ¤íŠ¸
  const uclCount = anomalies.filter(a => a.type === 'ucl').length;
  const checks = [
    { label: `ë¶ˆëŸ‰ë¥ ì´ ëª©í‘œ(${targetDefectRate.toFixed(1)}%) ì´ë‚´ì¸ê°€?`,
      pass: kpi.ë¶ˆëŸ‰ë¥  < targetDefectRate,
      detail: kpi.ë¶ˆëŸ‰ë¥  < targetDefectRate * 0.5 ? 'ë§¤ìš° ì–‘í˜¸í•©ë‹ˆë‹¤' : kpi.ë¶ˆëŸ‰ë¥  < targetDefectRate ? 'ëª©í‘œ ë²”ìœ„ ë‚´ì´ë‚˜ ê°œì„  ì—¬ì§€ ìˆìŒ' : `í˜„ì¬ ${pct(kpi.ë¶ˆëŸ‰ë¥ )}ë¡œ ëª©í‘œ(${targetDefectRate.toFixed(1)}%)ë¥¼ ${(kpi.ë¶ˆëŸ‰ë¥  - targetDefectRate).toFixed(2)}%p ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤`,
      badge: `í˜„ì¬ ${pct(kpi.ë¶ˆëŸ‰ë¥ )}` },
    { label: 'ë¶ˆëŸ‰ë¥ ì´ ê°œì„ ë˜ê³  ìˆëŠ”ê°€?',
      pass: trends.direction === 'ê°œì„ ' || trends.direction === 'ê¸‰ê°' || trends.direction === 'ì•ˆì •',
      detail: trends.consecutiveWorsen >= 3 ? `${trends.consecutiveWorsen}ì¼ ì—°ì†ìœ¼ë¡œ ì•…í™”ë˜ê³  ìˆìŠµë‹ˆë‹¤`
        : trends.consecutiveImprove >= 3 ? `${trends.consecutiveImprove}ì¼ ì—°ì†ìœ¼ë¡œ ê°œì„ ë˜ê³  ìˆìŠµë‹ˆë‹¤` : `ì¶”ì„¸: ${trends.direction}`,
      badge: `${trends.direction}` },
    { label: 'ì‹¬ê°í•œ ì´ìƒ ì§•í›„ê°€ ì—†ëŠ”ê°€?',
      pass: dangerAnomalies.length === 0,
      detail: dangerAnomalies.length === 0 ? 'ê³µì •ì´ ì •ìƒ ë²”ìœ„ ë‚´ì—ì„œ ìš´ì˜ ì¤‘ì…ë‹ˆë‹¤' : `ìœ„í—˜ ìˆ˜ì¤€ ì´ìƒ ì§•í›„ ${dangerAnomalies.length}ê±´ ê°ì§€`,
      badge: `ì´ìƒ ${anomalies.length}ê±´` },
    { label: 'ìœ„í—˜ í’ˆëª©ì´ ì—†ëŠ”ê°€?',
      pass: dangerItems.length === 0,
      detail: dangerItems.length > 0 ? `ìœ„í—˜: ${dangerItems.slice(0,2).map(r=>r.í’ˆëª…).join(', ')}${dangerItems.length>2?' ì™¸ '+(dangerItems.length-2)+'ê±´':''}`
        : warnItems.length > 0 ? `ì£¼ì˜ í’ˆëª© ${warnItems.length}ê±´ ëª¨ë‹ˆí„°ë§ í•„ìš”` : 'ëª¨ë“  í’ˆëª©ì´ ì•ˆì „í•©ë‹ˆë‹¤',
      badge: `ìœ„í—˜ ${dangerItems.length} / ì£¼ì˜ ${warnItems.length}` },
    { label: 'ê³µì •ì´ ì•ˆì •ì ì¸ê°€?',
      pass: uclCount === 0 && anomalies.filter(a=>a.type==='trend7'||a.type==='bias8').length === 0,
      detail: uclCount > 0 ? `ê´€ë¦¬ í—ˆìš©ë²”ìœ„ë¥¼ ë²—ì–´ë‚œ ë‚ ì´ ${uclCount}ì¼ ìˆìŠµë‹ˆë‹¤` : 'ê³µì • ë³€ë™ì´ í—ˆìš© ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤',
      badge: `ì´íƒˆ ${uclCount}ê±´` }
  ];
  const passCount = checks.filter(c => c.pass).length;
  html += `<div class="ai-checklist-box"><h3>ğŸ©º í’ˆì§ˆ ê±´ê°• ì²´í¬ (${passCount}/${checks.length} í†µê³¼)</h3>`;
  html += '<div class="ai-checklist">';
  checks.forEach(c => {
    html += `<div class="ai-check-item ${c.pass?'pass':'fail'}">
      <span class="ai-check-icon">${c.pass?'âœ…':'âŒ'}</span>
      <div class="ai-check-content">
        <div class="ai-check-label">${c.label}</div>
        <div class="ai-check-detail">${c.detail}</div>
      </div>
      <div class="ai-check-badge">${c.badge}</div>
    </div>`;
  });
  html += '</div></div>';

  // [4] ëª©í‘œ ë¶ˆëŸ‰ë¥  ì´ˆê³¼ ì›ì¸ ë¶„ì„ (Zone 1ì— ìš”ì•½ í‘œì‹œ)
  const targetSection = diagnosis.sections.find(s => s.title.includes('ëª©í‘œ ë¶ˆëŸ‰ë¥ '));
  if (targetSection) {
    html += `<div class="ai-diagnosis-box"><h3>${targetSection.title}</h3>
      <div class="ai-diagnosis-section ${targetSection.style}">${targetSection.body}</div>
    </div>`;
  }

  // [5] ê¶Œì¥ ì¡°ì¹˜ (ê¸°ì¡´ ì§„ë‹¨ì—ì„œ ì¶”ì¶œ)
  const actionsSection = diagnosis.sections.find(s => s.title.includes('ê¶Œì¥ ì¡°ì¹˜'));
  if (actionsSection) {
    html += `<div class="ai-diagnosis-box"><h3>ğŸ’¡ ì§€ê¸ˆ ë¬´ì—‡ì„ í•´ì•¼ í• ê¹Œìš”?</h3>
      <div class="ai-diagnosis-section ${actionsSection.style}">${actionsSection.body}</div>
    </div>`;
  }

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ZONE 2: ì „ë¬¸ê°€ ì˜ì—­ (ì ‘íŒ ìƒíƒœ)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  html += `<div class="ai-expand-toggle" onclick="toggleAIDetail()">
    <span id="aiDetailToggleText">ğŸ“Š ìƒì„¸ ë¶„ì„ ë³´ê¸° â–¼</span>
    <span class="ai-expand-hint">ì „ë¬¸ê°€ìš© ìƒì„¸ ë°ì´í„°</span>
  </div>`;
  html += '<div class="ai-detail-section" id="aiDetailSection" style="display:none">';

  // ê°„ì†Œí™”ëœ 3ê°œ í†µê³„ ì¹´ë“œ
  // ìë™ì°¨ ë¶€í’ˆ ê¸°ì¤€ ì‹œê·¸ë§ˆ ë“±ê¸‰ (ì—„ê²© ì ìš©)
  // S: â‰¥5Ïƒ, A: â‰¥4.5Ïƒ(â‰¤0.13%), B: â‰¥4Ïƒ(â‰¤0.62%), C: â‰¥3.5Ïƒ(â‰¤2.27%), D: â‰¥3Ïƒ, F: <3Ïƒ
  const sigmaGrade = st.sigmaLevel >= 5 ? 'S' : st.sigmaLevel >= 4.5 ? 'A' : st.sigmaLevel >= 4 ? 'B' : st.sigmaLevel >= 3.5 ? 'C' : st.sigmaLevel >= 3 ? 'D' : 'F';
  const sigmaDesc = { S:'ì„¸ê³„ ìµœê³  ìˆ˜ì¤€', A:'ìš°ìˆ˜í•œ í’ˆì§ˆ', B:'ì–‘í˜¸í•œ í’ˆì§ˆ', C:'ê°œì„  í•„ìš”', D:'ì§‘ì¤‘ ê´€ë¦¬ í•„ìš”', F:'ê¸´ê¸‰ ê°œì„  í•„ìš”' };
  const sigmaColor = { S:'#16A34A', A:'#22C55E', B:'#2563EB', C:'#F59E0B', D:'#DC2626', F:'#991B1B' };
  const weekTrend = st.last7Avg < st.prev7Avg ? 'ê°œì„ ì¤‘' : st.last7Avg > st.prev7Avg ? 'ì•…í™”ì¤‘' : 'ìœ ì§€';
  const weekTrendColor = st.last7Avg < st.prev7Avg ? 'var(--success)' : st.last7Avg > st.prev7Avg ? 'var(--danger)' : 'var(--gray)';
  const avgDailyBad = byDate.length ? Math.round(byDate.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0)/byDate.length) : 0;
  html += '<div class="ai-simple-stat-grid">';
  html += `<div class="ai-simple-stat-card"><div class="ai-ssc-icon">ğŸ…</div><div class="ai-ssc-val" style="color:${sigmaColor[sigmaGrade]}">${sigmaGrade}ë“±ê¸‰</div><div class="ai-ssc-lbl">í’ˆì§ˆ ë“±ê¸‰</div><div class="ai-ssc-tip">${sigmaDesc[sigmaGrade]} (${st.sigmaLevel.toFixed(1)}Ïƒ)</div></div>`;
  html += `<div class="ai-simple-stat-card"><div class="ai-ssc-icon">ğŸ“…</div><div class="ai-ssc-val" style="color:${weekTrendColor}">${weekTrend}</div><div class="ai-ssc-lbl">ìµœê·¼ 7ì¼ ì¶”ì´</div><div class="ai-ssc-tip">ì´ë²ˆì£¼ ${pct(st.last7Avg)} / ì§€ë‚œì£¼ ${pct(st.prev7Avg)}</div></div>`;
  html += `<div class="ai-simple-stat-card"><div class="ai-ssc-icon">ğŸ“ˆ</div><div class="ai-ssc-val" style="color:var(--gray)">${fmt(avgDailyBad)}ê°œ</div><div class="ai-ssc-lbl">ì¼í‰ê·  ë¶ˆëŸ‰</div><div class="ai-ssc-tip">ì´ ${fmt(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê±´ / ${kpi.ìƒì‚°ì¼ìˆ˜}ì¼</div></div>`;
  html += '</div>';

  // AI ìë™ ì§„ë‹¨ ë¦¬í¬íŠ¸
  html += '<div class="ai-diagnosis-box"><h3>ğŸ“‹ AI ìë™ ì§„ë‹¨ ë¦¬í¬íŠ¸</h3>';
  for (const sec of diagnosis.sections) {
    if (sec.title.includes('ê¶Œì¥ ì¡°ì¹˜')) continue;
    html += `<div class="ai-diagnosis-section ${sec.style}"><div class="ai-ds-title">${sec.title}</div>${sec.body}</div>`;
  }
  html += '</div>';

  // í’ˆëª© ìœ„í—˜ë„ ìˆœìœ„ (ê°„ì†Œí™”)
  html += '<div class="ai-item-detail"><h3>ğŸ† í’ˆëª© ìœ„í—˜ë„ ìˆœìœ„ (ìƒìœ„ 15)</h3>';
  const maxScore = riskScores.length ? riskScores[0].score : 100;
  riskScores.slice(0, 15).forEach((r, i) => {
    const bgColor = r.grade === 'ìœ„í—˜' ? '#DC2626' : r.grade === 'ì£¼ì˜' ? '#F59E0B' : '#16A34A';
    const barW = Math.max(r.score / maxScore * 120, 4);
    const nameLen = mb ? 20 : 40;
    const dispName = r.í’ˆëª….length > nameLen ? r.í’ˆëª….slice(0, nameLen) + '...' : r.í’ˆëª…;
    const factors = [
      { name: 'ë¶ˆëŸ‰ë¥ ', val: r.rateScore, color: '#DC2626' },
      { name: 'ì¶”ì„¸', val: r.slopeScore, color: '#F59E0B' },
      { name: 'ê·œëª¨', val: r.prodScore, color: '#2563EB' },
      { name: 'ë³€ë™', val: r.volScore, color: '#8B5CF6' }
    ];
    const dominant = factors.reduce((a, b) => a.val >= b.val ? a : b);
    html += `<div class="ai-item-row">
      <div class="ai-item-rank" style="background:${bgColor}">${i+1}</div>
      <div class="ai-item-name-wrap">
        <div class="ai-item-name" title="${r.í’ˆëª…}">${dispName}</div>
        <div class="ai-item-meta">ë¶ˆëŸ‰ë¥  ${pct(r.ë¶ˆëŸ‰ë¥ )} | ì£¼ìš” ì›ì¸: <span style="color:${dominant.color};font-weight:700">${dominant.name}</span></div>
      </div>
      <div class="ai-item-bars">
        <div class="ai-item-bar" style="width:${barW}px;background:${bgColor}"></div>
      </div>
      <div class="ai-item-score" style="color:${bgColor}">${r.score}ì </div>
    </div>`;
  });
  html += '</div>';

  // ë¶ˆëŸ‰ìœ í˜• ë¶„í¬ ì¹´ë“œ
  if (defectCols.length && defectTypes.trends.length) {
    html += '<div class="chart-box"><h3>ğŸ”¬ ë¶ˆëŸ‰ìœ í˜• ë¶„í¬ ë° ì¶”ì„¸</h3>';
    html += '<div class="ai-defect-summary">';
    const totalDefects = defectTypes.trends.reduce((s,t) => s+t.total, 0) || 1;
    defectTypes.trends.filter(t => t.total > 0).forEach(t => {
      const pctVal = (t.total / totalDefects * 100).toFixed(1);
      const trendColorD = t.direction === 'ì¦ê°€' ? '#DC2626' : t.direction === 'ê°ì†Œ' ? '#16A34A' : '#6B7280';
      const trendIcon = t.direction === 'ì¦ê°€' ? 'â–²' : t.direction === 'ê°ì†Œ' ? 'â–¼' : 'â†’';
      html += `<div class="ai-defect-card">
        <div class="ai-dc-name">${t.type} <span style="color:${trendColorD};font-size:12px">${trendIcon} ${t.direction}</span></div>
        <div class="ai-dc-val">${fmt(t.total)}ê±´ (${pctVal}%)</div>
        <div class="ai-dc-bar"><div class="ai-dc-fill" style="width:${pctVal}%;background:${trendColorD}"></div></div>
      </div>`;
    });
    html += '</div></div>';
  }

  // ê²½ê³  ì¹´ë“œ ëª©ë¡
  const warnings = [];
  dangerItems.forEach(r => {
    const slopeText = r.slope > 0.05 ? 'ìƒìŠ¹ì¤‘' : r.slope < -0.05 ? 'ê°œì„ ì¤‘' : 'ì•ˆì •';
    warnings.push({ severity: 'danger', title: r.í’ˆëª…,
      desc: `ë¶ˆëŸ‰ë¥  ${pct(r.ë¶ˆëŸ‰ë¥ )} | ë¶ˆëŸ‰ ${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}/${fmt(r.ìƒì‚°ìˆ˜ëŸ‰)}ê°œ | ì¶”ì„¸: ${slopeText}`,
      scoreText: `ìœ„í—˜ ì ìˆ˜ ${r.score}ì `, item: r.í’ˆëª…, score: r.score });
  });
  dangerAnomalies.slice(0, 5).forEach(a => {
    warnings.push({ severity: 'danger', title: a.desc,
      desc: `${typeof a.date === 'string' ? a.date : dateStr(a.date)}`,
      scoreText: '', score: 100 });
  });
  warnItems.slice(0, 8).forEach(r => {
    warnings.push({ severity: 'warn', title: r.í’ˆëª…,
      desc: `ë¶ˆëŸ‰ë¥  ${pct(r.ë¶ˆëŸ‰ë¥ )} | ë¶ˆëŸ‰ ${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê°œ`,
      scoreText: `ì ìˆ˜ ${r.score}ì `, item: r.í’ˆëª…, score: r.score });
  });
  if (trends.consecutiveWorsen >= 3) {
    warnings.push({ severity: 'warn', title: `${trends.consecutiveWorsen}ì¼ ì—°ì† ì•…í™”`,
      desc: `ë¶ˆëŸ‰ë¥ ì´ ${trends.consecutiveWorsen}ì¼ ì—°ì†ìœ¼ë¡œ ìƒìŠ¹ ì¤‘`, scoreText: '', score: 60 });
  }
  if (trends.crossType === 'dead') {
    warnings.push({ severity: 'warn', title: 'ë¶ˆëŸ‰ë¥  ì•…í™” ì‹ í˜¸ ê°ì§€',
      desc: 'ë‹¨ê¸° í‰ê· ì´ ì¥ê¸° í‰ê· ì„ ë„˜ì–´ì„¬ â€” ì•…í™” ê°€ì† ê°€ëŠ¥ì„±', scoreText: '', score: 55 });
  }
  warnings.sort((a,b) => { if (a.severity !== b.severity) return a.severity === 'danger' ? -1 : 1; return b.score - a.score; });

  if (warnings.length) {
    html += '<div class="chart-box"><h3>âš ï¸ ê²½ê³  ëª©ë¡</h3>';
    warnings.forEach((w, i) => {
      html += `<div class="ai-warning-card ${w.severity}">
        <div class="ai-wc-info">
          <div class="ai-wc-title">${w.severity==='danger'?'ğŸ”´':'ğŸŸ¡'} ${w.title}</div>
          <div class="ai-wc-desc">${w.desc}</div>
          ${w.scoreText ? '<div class="ai-wc-score" style="color:var(--text-light)">'+w.scoreText+'</div>' : ''}
        </div>
        <div class="ai-wc-spark" id="aiSpark${i}"></div>
      </div>`;
    });
    html += '</div>';
  }

  // ì°¨íŠ¸ ì˜ì—­
  html += '<div class="chart-box"><h3>ğŸ“Š í’ˆëª© ìœ„í—˜ë„ ë§¤íŠ¸ë¦­ìŠ¤</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:4px">X=ìƒì‚°ìˆ˜ëŸ‰, Y=ë¶ˆëŸ‰ë¥ , í¬ê¸°=ìœ„í—˜ì ìˆ˜, ìƒ‰=ë“±ê¸‰</p><div id="chartRiskMatrix"></div></div>';
  if (defectCols.length) {
    html += '<div class="chart-box"><h3>ğŸ“ˆ ë¶ˆëŸ‰ìœ í˜•ë³„ ì¶”ì„¸</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:4px">ê° ë¶ˆëŸ‰ìœ í˜•ì˜ ì¼ë³„ ì¶”ì´</p><div id="chartDefectTrends"></div></div>';
  }

  // ì´ìƒ ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸ (ìš©ì–´ ê°„ì†Œí™”)
  if (anomalies.length) {
    const tlUcl = anomalies.filter(a=>a.type==='ucl').length;
    const tlZ = anomalies.filter(a=>a.type==='zscore').length;
    const tlSpike = anomalies.filter(a=>a.type==='spike').length;
    const tlRule = anomalies.filter(a=>a.type==='trend7'||a.type==='bias8').length;
    html += '<div class="ai-timeline"><h3>ğŸ• ì´ìƒ ì´ë²¤íŠ¸ íƒ€ì„ë¼ì¸</h3>';
    html += `<div style="font-size:12px;color:var(--text-light);margin-bottom:10px">ì´ ${anomalies.length}ê±´ â€” ê´€ë¦¬ë²”ìœ„ ì´ˆê³¼ ${tlUcl}ê±´, ê·¹ë‹¨ê°’ ${tlZ}ê±´, ê¸‰ê²©í•œ ì¦ê°€ ${tlSpike}ê±´, ì—°ì† íŒ¨í„´ ${tlRule}ê±´</div>`;
    anomalies.slice(0, 25).forEach(a => {
      const d = typeof a.date === 'string' ? a.date : dateStr(a.date);
      const typeLabel = { ucl:'ê´€ë¦¬ë²”ìœ„ ì´ˆê³¼', zscore:'ê·¹ë‹¨ê°’', spike:'ê¸‰ê²©í•œ ì¦ê°€', trend7:'7ì¼ ì—°ì† ì•…í™”', bias8:'ì§€ì† ê³ ìœ„í—˜' };
      html += `<div class="ai-tl-item">
        <span class="ai-tl-date">${dateKR(d)}</span>
        <span class="ai-tl-badge ${a.severity}">${a.severity==='danger'?'ìœ„í—˜':'ì£¼ì˜'}</span>
        <span style="font-size:10px;color:var(--text-light);min-width:65px">${typeLabel[a.type]||a.type}</span>
        <span class="ai-tl-text">${a.desc}</span>
      </div>`;
    });
    html += '</div>';
  }

  html += '</div>'; // close aiDetailSection

  el.innerHTML = html;

  // ìŠ¤íŒŒí¬ë¼ì¸ì€ ìƒì„¸ ì˜ì—­ ì—´ë¦´ ë•Œ ë Œë”ë§ (ì°¨íŠ¸ëŠ” toggleAIDetailì—ì„œ ì§€ì—° ë Œë”ë§)
  const origToggle = toggleAIDetail;
  const itemDailyMap = new Map();
  if (filtered && filtered.length) {
    const ibd = aggByItemDate(filtered);
    for (const r of ibd) {
      if (!itemDailyMap.has(r.í’ˆëª…)) itemDailyMap.set(r.í’ˆëª…, []);
      itemDailyMap.get(r.í’ˆëª…).push(r.ë¶ˆëŸ‰ë¥  * 100);
    }
  }
  // ìŠ¤íŒŒí¬ë¼ì¸ì€ ìƒì„¸ ì„¹ì…˜ ì²« ì—´ë¦¼ ì‹œ ë Œë”ë§
  const detailEl = document.getElementById('aiDetailSection');
  if (detailEl) {
    const observer = new MutationObserver(() => {
      if (detailEl.style.display !== 'none' && !detailEl.dataset.sparksRendered) {
        detailEl.dataset.sparksRendered = '1';
        warnings.forEach((w, i) => {
          const sparkEl = document.getElementById('aiSpark' + i);
          if (sparkEl && w.item && itemDailyMap.has(w.item)) {
            renderSparkline(sparkEl, itemDailyMap.get(w.item), w.severity === 'danger' ? '#DC2626' : '#F59E0B');
          } else if (sparkEl) {
            renderSparkline(sparkEl, byDate.map(r => r.ë¶ˆëŸ‰ë¥  * 100), '#6B7280');
          }
        });
      }
    });
    observer.observe(detailEl, { attributes: true, attributeFilter: ['style'] });
  }
}

/* ================================================================
   Phase 3: ë‹¤í¬ëª¨ë“œ
   ================================================================ */
/* ëŒ€ì‹œë³´ë“œ ë Œë”ë§
   ================================================================ */
function renderDashboard(kpi, byDate, byItem, totals, alerts, threshold, filtered) {
  // ê¸°ì¡´ Plotly ì°¨íŠ¸ ë©”ëª¨ë¦¬ ì •ë¦¬ (ëª¨ë°”ì¼ ì„±ëŠ¥ ê°œì„ )
  document.querySelectorAll('#dashboard .js-plotly-plot').forEach(p => {
    try { Plotly.purge(p); } catch(e) {}
  });

  $('placeholder').style.display = 'none';
  $('dashboard').style.display = '';

  // ë¶„ì„ ì‹œê° í‘œì‹œ
  const now = new Date();
  const nowLabel = now.getFullYear()+'ë…„ '+(now.getMonth()+1)+'ì›” '+now.getDate()+'ì¼ '
    +String(now.getHours()).padStart(2,'0')+':'+String(now.getMinutes()).padStart(2,'0');
  $('lastAnalysisDate').textContent = 'ìµœê·¼ ë¶„ì„: ' + nowLabel;

  // â”€â”€ íƒ­1: ì „ì²´ ìš”ì•½ (HTML ë¨¼ì € êµ¬ì„± í›„ ì°¨íŠ¸ ìƒì„±) â”€â”€
  const t1 = $('tab1');
  const weekChg = calcWeekChange(filtered);
  const arrow = weekChg.ë³€í™” > 0 ? 'â–²' : weekChg.ë³€í™” < 0 ? 'â–¼' : 'â”€';
  const arrowColor = weekChg.ë³€í™” > 0 ? 'var(--danger)' : weekChg.ë³€í™” < 0 ? 'var(--success)' : 'var(--gray)';
  const chgLabel = weekChg.ë³€í™” > 0 ? 'ì•…í™”' : weekChg.ë³€í™” < 0 ? 'ê°œì„ ' : 'ë³€ë™ì—†ìŒ';

  // ì „ì£¼ ëŒ€ë¹„ ìƒì‚°/ë¶ˆëŸ‰ ë³€í™” ê³„ì‚°
  const t1Trends = analyzeTrends(byDate, filtered);
  const t1Anomalies = detectAnomalies(byDate);
  const t1RiskScores = calcItemRiskScores(byItem, filtered, aiRiskSettings);
  const t1Diagnosis = generateDiagnosisText(kpi, t1Trends, t1Anomalies, analyzeDefectTypes(byDate), t1RiskScores, byDate, targetDefectRate);
  const t1Stats = t1Diagnosis.stats;
  const t1QS = calcQualityScore(kpi, t1Trends, t1Anomalies, t1RiskScores, t1Stats);
  const t1BannerClass = t1QS.score >= 75 ? 'safe' : t1QS.score >= 45 ? 'warn' : 'danger';
  const t1BannerEmoji = t1QS.score >= 75 ? 'ğŸŸ¢' : t1QS.score >= 45 ? 'ğŸŸ¡' : 'ğŸ”´';

  let t1Html = '';

  // [1] í’ˆì§ˆ ìƒíƒœ ë°°ë„ˆ
  const t1TargetOver = kpi.ë¶ˆëŸ‰ë¥  > targetDefectRate;
  const t1TargetBadge = t1TargetOver
    ? `<span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;background:#FEE2E2;color:#DC2626;margin-left:6px">ëª©í‘œ ì´ˆê³¼ +${(kpi.ë¶ˆëŸ‰ë¥  - targetDefectRate).toFixed(2)}%p</span>`
    : `<span style="display:inline-block;padding:2px 8px;border-radius:6px;font-size:11px;font-weight:700;background:#D1FAE5;color:#16A34A;margin-left:6px">ëª©í‘œ ë‹¬ì„±</span>`;
  t1Html += `<div class="t1-status-banner ${t1BannerClass}">
    <span class="t1-sb-score">${t1BannerEmoji} ${t1QS.letterGrade}</span>
    <div class="t1-sb-text">
      í’ˆì§ˆ ì¢…í•© ì ìˆ˜ <b>${t1QS.score}ì </b> â€” ${t1QS.verdict}
      <div class="t1-sb-sub">ë¶ˆëŸ‰ë¥  ${pct(kpi.ë¶ˆëŸ‰ë¥ )} (ëª©í‘œ ${targetDefectRate.toFixed(1)}%) ${t1TargetBadge} | ì–‘í’ˆë¥  ${pct(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ ? kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰/kpi.ì´ìƒì‚°ìˆ˜ëŸ‰*100 : 100)} | ${kpi.í’ˆëª©ìˆ˜}ê°œ í’ˆëª© / ${kpi.ìƒì‚°ì¼ìˆ˜}ì¼ê°„ ë¶„ì„</div>
    </div>
  </div>`;

  // [2] KPI ì¹´ë“œ (8ê°œ)
  const t1YieldRate = kpi.ì´ìƒì‚°ìˆ˜ëŸ‰ ? (kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰/kpi.ì´ìƒì‚°ìˆ˜ëŸ‰*100) : 100;
  const t1DailyProd = kpi.ìƒì‚°ì¼ìˆ˜ ? Math.round(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰/kpi.ìƒì‚°ì¼ìˆ˜) : 0;
  t1Html += '<div id="kpiCards"></div>';

  // [3] ì „ì£¼ ë¹„êµ ì¹´ë“œ
  t1Html += '<div class="kpi-grid week-compare-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:16px">';
  t1Html += `<div class="kpi-card"><div class="value" style="color:var(--primary)">${pct(weekChg.ê¸ˆì£¼)}</div><div class="label">ê¸ˆì£¼ ë¶ˆëŸ‰ë¥ </div></div>`;
  t1Html += `<div class="kpi-card"><div class="value" style="color:var(--gray)">${pct(weekChg.ì „ì£¼)}</div><div class="label">ì „ì£¼ ë¶ˆëŸ‰ë¥ </div></div>`;
  t1Html += `<div class="kpi-card"><div class="value" style="color:${arrowColor}">${arrow} ${pct(Math.abs(weekChg.ë³€í™”))}</div><div class="label">ì „ì£¼ ëŒ€ë¹„ (${chgLabel})</div></div>`;
  t1Html += '</div>';

  // [4] ë¶ˆëŸ‰ë¥  TOP 5 í’ˆëª©
  const t1Top5 = [...byItem].sort((a,b) => b.ë¶ˆëŸ‰ë¥  - a.ë¶ˆëŸ‰ë¥ ).slice(0, 5);
  const t1MaxRate = t1Top5.length ? t1Top5[0].ë¶ˆëŸ‰ë¥  * 100 : 1;
  t1Html += '<div class="chart-box"><h3>ğŸ”´ ë¶ˆëŸ‰ë¥  TOP 5 í’ˆëª©</h3>';
  t1Top5.forEach((r, i) => {
    const rate = r.ë¶ˆëŸ‰ë¥  * 100;
    const barColor = rate >= 5 ? '#DC2626' : rate >= 3 ? '#F59E0B' : '#2563EB';
    const rankColor = i === 0 ? '#DC2626' : i === 1 ? '#F59E0B' : '#6B7280';
    const barW = Math.max(rate / t1MaxRate * 100, 4);
    t1Html += `<div class="t1-top5-bar">
      <div class="t1-top5-rank" style="background:${rankColor}">${i+1}</div>
      <div class="t1-top5-name" title="${r.í’ˆëª…}">${r.í’ˆëª…}</div>
      <div class="t1-top5-barwrap"><div class="t1-top5-fill" style="width:${barW}%;background:${barColor}"></div></div>
      <div class="t1-top5-rate" style="color:${barColor}">${pct(rate)}</div>
    </div>`;
  });
  t1Html += '</div>';

  // [5] ì°¨íŠ¸ 2ì—´: ì´ë™í‰ê·  + ë„ë„›(ë˜ëŠ” íŒŒë ˆí† )
  t1Html += '<div class="t1-chart-row">';
  t1Html += '<div class="chart-box"><h3>ğŸ“ˆ ë¶ˆëŸ‰ë¥  ì¶”ì„¸ (ì´ë™í‰ê· )</h3><div id="chartTrendMA"></div></div>';
  if (defectCols.length) {
    t1Html += '<div class="chart-box"><h3>ğŸ© ë¶ˆëŸ‰ìœ í˜• ë¹„ìœ¨</h3><div id="chartDefectDonut"></div></div>';
  }
  t1Html += '</div>';
  if (defectCols.length) {
    t1Html += '<div class="chart-box"><h3>ğŸ“Š ë¶ˆëŸ‰ ìœ í˜• íŒŒë ˆí†  ë¶„ì„</h3><div id="chartPareto"></div></div>';
  }

  // [6] ìµœê·¼ 7ì¼ ë¯¸ë‹ˆ ì¹´ë“œ
  const t1Last7 = byDate.slice(-7);
  if (t1Last7.length > 1) {
    t1Html += '<div class="chart-box"><h3>ğŸ“… ìµœê·¼ 7ì¼ í˜„í™©</h3>';
    t1Html += '<div class="t1-mini-scroll">';
    t1Last7.forEach((r, i) => {
      const rate = r.ë¶ˆëŸ‰ë¥  * 100;
      const barColor = rate > targetDefectRate ? '#DC2626' : '#16A34A';
      let chg = '';
      if (i > 0) {
        const prev = t1Last7[i-1].ë¶ˆëŸ‰ë¥  * 100;
        const diff = rate - prev;
        if (Math.abs(diff) > 0.001) {
          chg = `<div class="t1-mc-change" style="color:${diff > 0 ? '#DC2626' : '#16A34A'}">${diff > 0 ? 'â–²' : 'â–¼'} ${pct(Math.abs(diff))}</div>`;
        } else {
          chg = '<div class="t1-mc-change" style="color:#6B7280">â”€ ë³€ë™ì—†ìŒ</div>';
        }
      }
      t1Html += `<div class="t1-mini-card">
        <div class="t1-mc-date">${dateKR(r.ìƒì‚°ì¼ì)}</div>
        <div class="t1-mc-rate" style="color:${barColor}">${pct(rate)}</div>
        ${chg}
        <div class="t1-mc-detail">ìƒì‚° ${fmt(r.ìƒì‚°ìˆ˜ëŸ‰)} / ë¶ˆëŸ‰ ${fmt(r.ë¶ˆëŸ‰ìˆ˜ëŸ‰)}</div>
        <div class="t1-mc-bar" style="background:${barColor}"></div>
      </div>`;
    });
    t1Html += '</div></div>';
  }

  // [7] í•µì‹¬ ì¸ì‚¬ì´íŠ¸ ë°•ìŠ¤
  const t1Insights = [];
  // ëª©í‘œ ë¶ˆëŸ‰ë¥  ë‹¬ì„±/ì´ˆê³¼
  if (t1TargetOver) {
    const overDays = byDate.filter(r => r.ë¶ˆëŸ‰ë¥  * 100 > targetDefectRate).length;
    t1Insights.push(`<span style="color:#DC2626">í˜„ì¬ ë¶ˆëŸ‰ë¥  <b>${pct(kpi.ë¶ˆëŸ‰ë¥ )}</b>ë¡œ ëª©í‘œ(${targetDefectRate.toFixed(1)}%)ë¥¼ <b>${(kpi.ë¶ˆëŸ‰ë¥  - targetDefectRate).toFixed(2)}%p ì´ˆê³¼</b>í•˜ê³  ìˆìŠµë‹ˆë‹¤. (${overDays}/${byDate.length}ì¼ ì´ˆê³¼)</span>`);
  } else {
    t1Insights.push(`<span style="color:#16A34A">í˜„ì¬ ë¶ˆëŸ‰ë¥  <b>${pct(kpi.ë¶ˆëŸ‰ë¥ )}</b>ë¡œ ëª©í‘œ(${targetDefectRate.toFixed(1)}%)ë¥¼ <b>ë‹¬ì„±</b>í•˜ê³  ìˆìŠµë‹ˆë‹¤.</span>`);
  }
  // ì „ì£¼ ëŒ€ë¹„
  if (weekChg.ë³€í™” !== 0) {
    t1Insights.push(`ìµœê·¼ 7ì¼ ë¶ˆëŸ‰ë¥ ì´ ì „ì£¼ ëŒ€ë¹„ <b style="color:${weekChg.ë³€í™”>0?'#DC2626':'#16A34A'}">${pct(Math.abs(weekChg.ë³€í™”))} ${weekChg.ë³€í™”>0?'ì•…í™”':'ê°œì„ '}</b>ë˜ì—ˆìŠµë‹ˆë‹¤.`);
  }
  // TOP ë¶ˆëŸ‰ í’ˆëª©
  if (t1Top5.length > 0) {
    t1Insights.push(`ë¶ˆëŸ‰ì´ ê°€ì¥ ë§ì€ í’ˆëª©ì€ <b>${t1Top5[0].í’ˆëª…}</b> (ë¶ˆëŸ‰ë¥  ${pct(t1Top5[0].ë¶ˆëŸ‰ë¥ *100)})ì…ë‹ˆë‹¤.`);
  }
  // ì£¼ìš” ë¶ˆëŸ‰ìœ í˜•
  if (totals.length > 0) {
    const topDefect = totals[0];
    const totalBad = totals.reduce((s,t)=>s+t.ê±´ìˆ˜,0) || 1;
    t1Insights.push(`ì£¼ìš” ë¶ˆëŸ‰ìœ í˜•ì€ <b>${topDefect.ë¶ˆëŸ‰ìœ í˜•}</b>ìœ¼ë¡œ ì „ì²´ì˜ <b>${(topDefect.ê±´ìˆ˜/totalBad*100).toFixed(1)}%</b>ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.`);
  }
  // ì—°ì† ì¶”ì„¸
  if (t1Trends.consecutiveWorsen >= 3) {
    t1Insights.push(`<span style="color:#DC2626"><b>${t1Trends.consecutiveWorsen}ì¼ ì—°ì†</b> ë¶ˆëŸ‰ë¥ ì´ ìƒìŠ¹ ì¤‘ì…ë‹ˆë‹¤. ì›ì¸ íŒŒì•…ì´ í•„ìš”í•©ë‹ˆë‹¤.</span>`);
  } else if (t1Trends.consecutiveImprove >= 3) {
    t1Insights.push(`<span style="color:#16A34A"><b>${t1Trends.consecutiveImprove}ì¼ ì—°ì†</b> ë¶ˆëŸ‰ë¥ ì´ ê°œì„ ë˜ê³  ìˆìŠµë‹ˆë‹¤.</span>`);
  }
  // ì–‘í’ˆë¥ 
  t1Insights.push(`ì „ì²´ ì–‘í’ˆë¥ ì€ <b>${pct(t1YieldRate)}</b>ì´ë©°, ì¼í‰ê·  <b>${fmt(t1DailyProd)}ê°œ</b>ë¥¼ ìƒì‚°í•˜ê³  ìˆìŠµë‹ˆë‹¤.`);

  if (t1Insights.length) {
    t1Html += '<div class="chart-box"><h3>ğŸ’¡ í•µì‹¬ ì¸ì‚¬ì´íŠ¸</h3>';
    t1Html += '<div class="t1-insight-box">';
    t1Insights.forEach(ins => { t1Html += `<div class="t1-ins-item">${ins}</div>`; });
    t1Html += '</div></div>';
  }

  t1.innerHTML = t1Html;

  // KPI ì¹´ë“œ ë Œë”ë§ (ì–‘í’ˆë¥ , ì¼í‰ê· ìƒì‚° ì¶”ê°€)
  const t1KpiEl = $('kpiCards');
  t1KpiEl.innerHTML = '';
  const t1DailyBad = kpi.ìƒì‚°ì¼ìˆ˜ ? Math.round(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰ / kpi.ìƒì‚°ì¼ìˆ˜) : 0;
  const t1OverDays = byDate.filter(r => r.ë¶ˆëŸ‰ë¥  * 100 > targetDefectRate).length;
  const t1Cards = [
    { label:'ì´ ìƒì‚°ìˆ˜ëŸ‰', value: fmt(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰), color:'var(--primary)' },
    { label:'ì´ ì–‘í’ˆìˆ˜ëŸ‰', value: fmt(kpi.ì´ì–‘í’ˆìˆ˜ëŸ‰), color:'var(--success)' },
    { label:'ì´ ë¶ˆëŸ‰ìˆ˜ëŸ‰', value: fmt(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰), color:'var(--danger)' },
    { label:'ë¶ˆëŸ‰ë¥ ', value: pct(kpi.ë¶ˆëŸ‰ë¥ ), color: t1TargetOver ? 'var(--danger)' : 'var(--warning)' },
    { label:'ëª©í‘œ ë¶ˆëŸ‰ë¥ ', value: targetDefectRate.toFixed(1) + '%', color: t1TargetOver ? 'var(--danger)' : 'var(--success)', sub: t1TargetOver ? 'ì´ˆê³¼' : 'ë‹¬ì„±' },
    { label:'ì–‘í’ˆë¥ ', value: pct(t1YieldRate), color:'var(--success)' },
    { label:'ì‹œê·¸ë§ˆ ìˆ˜ì¤€', value: t1Stats.sigmaLevel.toFixed(1) + 'Ïƒ', color:'var(--primary)' },
    { label:'ì¼í‰ê·  ìƒì‚°', value: fmt(t1DailyProd) + 'ê°œ', color:'var(--primary)' },
    { label:'ì¼í‰ê·  ë¶ˆëŸ‰', value: fmt(t1DailyBad) + 'ê°œ', color:'var(--danger)' },
    { label:'ëª©í‘œ ì´ˆê³¼ ì¼ìˆ˜', value: t1OverDays + '/' + byDate.length + 'ì¼', color: t1OverDays > 0 ? 'var(--danger)' : 'var(--success)' },
    { label:'í’ˆëª©ìˆ˜', value: kpi.í’ˆëª©ìˆ˜ + 'ê°œ', color:'var(--gray)' },
    { label:'ìƒì‚°ì¼ìˆ˜', value: kpi.ìƒì‚°ì¼ìˆ˜ + 'ì¼', color:'var(--gray)' },
  ];
  const t1Grid = document.createElement('div');
  t1Grid.className = 'kpi-grid';
  for (const c of t1Cards) {
    t1Grid.innerHTML += `<div class="kpi-card"><div class="value" style="color:${c.color}">${c.value}</div><div class="label">${c.label}${c.sub ? ' <span style="font-size:10px;font-weight:700;color:'+c.color+'">(' + c.sub + ')</span>' : ''}</div></div>`;
  }
  t1KpiEl.appendChild(t1Grid);

  // ì°¨íŠ¸ ë Œë”ë§
  chartTrendMA(byDate, $('chartTrendMA'));
  if (defectCols.length) {
    chartPareto(totals, $('chartPareto'));
    // ë„ë„› ì°¨íŠ¸
    const donutEl = $('chartDefectDonut');
    if (donutEl && totals.length) {
      const top5d = totals.slice(0, 5);
      const otherSum = totals.slice(5).reduce((s,t)=>s+t.ê±´ìˆ˜,0);
      const labels = top5d.map(t=>t.ë¶ˆëŸ‰ìœ í˜•);
      const values = top5d.map(t=>t.ê±´ìˆ˜);
      if (otherSum > 0) { labels.push('ê¸°íƒ€'); values.push(otherSum); }
      Plotly.newPlot(donutEl, [{
        labels, values, type: 'pie', hole: 0.5,
        textinfo: 'label+percent', textposition: 'outside',
        textfont: { size: isMobile() ? 9 : 11 },
        marker: { colors: ['#DC2626','#F59E0B','#2563EB','#8B5CF6','#16A34A','#6B7280'] }
      }], {
        showlegend: false,
        height: chartHeight(350, 280),
        margin: isMobile() ? {t:10,b:10,l:10,r:10} : {t:20,b:20,l:20,r:20},
        annotations: [{ text: fmt(values.reduce((a,b)=>a+b,0)) + 'ê±´', x:0.5, y:0.5, font:{size: isMobile() ? 14 : 18, weight:800}, showarrow:false }]
      }, getPlotCfg());
    }
  }

  // â”€â”€ íƒ­2: ì¼ìë³„ ë¶„ì„ (HTML ë¨¼ì € êµ¬ì„± í›„ ì°¨íŠ¸ ìƒì„±) â”€â”€
  const t2 = $('tab2');
  const byWeek = (filtered && filtered.length) ? aggByWeek(filtered) : [];
  const byMonth = (filtered && filtered.length) ? aggByMonth(filtered) : [];
  const dateHeaders = ['ìƒì‚°ì¼ì','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰',...defectCols,'ë¶ˆëŸ‰ë¥ '];
  let t2Html = '<div class="chart-box"><h3>ì¼ìë³„ ìƒì‚°ìˆ˜ëŸ‰ ë° ë¶ˆëŸ‰ë¥  ì¶”ì´</h3><div id="chartDailyTrend"></div></div>';
  if (defectCols.length) {
    t2Html += '<div class="chart-box"><h3>ì¼ìë³„ ë¶ˆëŸ‰ìœ í˜• êµ¬ì„±</h3><div id="chartDailyStack"></div></div>';
  }
  // ìš”ì¼ë³„ íŒ¨í„´ + ìƒì‚°ëŸ‰ vs ë¶ˆëŸ‰ë¥  ì‚°ì ë„
  t2Html += '<div class="chart-box"><h3>ğŸ“Š ìš”ì¼ë³„ í‰ê·  ë¶ˆëŸ‰ë¥  íŒ¨í„´</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:4px">ì–´ë–¤ ìš”ì¼ì— ë¶ˆëŸ‰ì´ ë§ì€ì§€ íŒ¨í„´ì„ í™•ì¸í•˜ì„¸ìš”</p><div class="weekday-chart-box"><div id="chartWeekday"></div><div id="chartProdVsDefect"></div></div></div>';
  t2Html += `<div class="chart-box"><h3>ì§‘ê³„ ë‹¨ìœ„ ë³€í™˜</h3>
    <div style="display:flex;gap:8px;margin-bottom:12px">
      <button class="btn btn-sm btn-primary" onclick="showAggTable('daily')">ì¼ë³„</button>
      <button class="btn btn-sm" style="background:var(--gray);color:#fff" onclick="showAggTable('weekly')">ì£¼ê°„</button>
      <button class="btn btn-sm" style="background:var(--gray);color:#fff" onclick="showAggTable('monthly')">ì›”ê°„</button>
    </div>
    <div id="aggTableArea"></div></div>`;
  t2.innerHTML = t2Html;
  chartDailyTrend(byDate, $('chartDailyTrend'));
  if (defectCols.length) chartDailyStack(byDate, $('chartDailyStack'));
  chartWeekdayPattern(byDate, $('chartWeekday'));
  chartWeekdayScatter(byDate, $('chartProdVsDefect'));
  window._aggData = {daily:byDate, weekly:byWeek, monthly:byMonth, headers:dateHeaders};
  $('aggTableArea').innerHTML = makeTableEnhanced(dateHeaders, byDate, 'tblDate');
  window.showAggTable = function(mode) {
    const d = window._aggData;
    $('aggTableArea').innerHTML = makeTableEnhanced(d.headers, d[mode], 'tblDate');
  };

  // â”€â”€ íƒ­3: í’ˆëª©ë³„ ë¶„ì„ â”€â”€ (HTMLì„ ë¨¼ì € í•œë²ˆì— êµ¬ì„± í›„ ì°¨íŠ¸ ìƒì„±)
  const t3 = $('tab3');
  const itemHeaders = ['í’ˆëª…','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰','ë¶ˆëŸ‰ë¥ '];
  // í’ˆëª©ë³„ ì¶”ì„¸ ë°°ì§€ (ì „ë°˜ë¶€ vs í›„ë°˜ë¶€ ë¹„êµ)
  const t3Top = [...byItem].sort((a,b) => b.ë¶ˆëŸ‰ë¥  - a.ë¶ˆëŸ‰ë¥ ).slice(0, 15);
  let t3TrendHtml = '<div class="chart-box"><h3>ğŸ“ˆ í’ˆëª©ë³„ ì¶”ì„¸ ë°©í–¥ (ë¶ˆëŸ‰ë¥  TOP 15)</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:8px">ì „ë°˜ë¶€ vs í›„ë°˜ë¶€ ë¶ˆëŸ‰ë¥  ë¹„êµ. â–²ì•…í™”(+0.5%p ì´ìƒ), â–¼ê°œì„ (-0.5%p ì´ìƒ), â”€ì•ˆì •</p>';
  t3TrendHtml += '<div style="display:flex;flex-wrap:wrap;gap:8px">';
  t3Top.forEach(r => {
    const badge = getItemTrendBadge(r.í’ˆëª…, filtered);
    const shortName = r.í’ˆëª….length > 20 ? r.í’ˆëª….slice(0,20) + '...' : r.í’ˆëª…;
    t3TrendHtml += `<div style="background:var(--white);border:1px solid var(--border);border-radius:8px;padding:8px 12px;min-width:180px;flex:1;max-width:280px">
      <div style="font-weight:600;font-size:13px;margin-bottom:2px">${shortName}</div>
      <div style="font-size:12px;color:var(--text-light)">ë¶ˆëŸ‰ë¥  ${pct(r.ë¶ˆëŸ‰ë¥ *100,1)}</div>
      <span class="trend-badge ${badge.cls}">${badge.text}</span>
    </div>`;
  });
  t3TrendHtml += '</div></div>';
  let t3Html = t3TrendHtml;
  t3Html += '<div class="chart-box"><h3>í’ˆëª©ë³„ ë¶ˆëŸ‰ë¥  TOP 15</h3><div id="chartTop15"></div></div>';
  if (defectCols.length) {
    t3Html += '<div class="chart-box"><h3>í’ˆëª© x ë¶ˆëŸ‰ìœ í˜• íˆíŠ¸ë§µ (ìƒ‰ìƒ: ë¶ˆëŸ‰ë¥  / ì…€: ê±´ìˆ˜+ë¹„ìœ¨)</h3><div id="chartHeatmap"></div></div>';
  }
  t3Html += '<div class="chart-box"><h3>ìƒì‚°ìˆ˜ëŸ‰ vs ë¶ˆëŸ‰ë¥  (4ì‚¬ë¶„ë©´ ë¶„ì„)</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:4px">ë²„ë¸” í¬ê¸° = ë¶ˆëŸ‰ìˆ˜ëŸ‰ / ì ì„  = ì¤‘ì•™ê°’ ê¸°ì¤€ì„  / Xì¶•: ë¡œê·¸ ìŠ¤ì¼€ì¼</p><div id="chartScatter"></div></div>';
  t3Html += '<div class="chart-box"><h3>ë‚ ì§œë³„ ëˆ„ì  ë²„ë¸” ì• ë‹ˆë©”ì´ì…˜</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:4px">ì¬ìƒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‚ ì§œê°€ íë¥´ë©° í’ˆëª©ë³„ ìƒì‚°/ë¶ˆëŸ‰ì´ ëˆ„ì ë©ë‹ˆë‹¤</p><div id="chartScatterAnim"></div></div>';
  t3Html += '<div class="chart-box"><h3>í’ˆëª©ë³„ ì§‘ê³„ ë°ì´í„°</h3>' + makeTableEnhanced(itemHeaders, byItem, 'tblItem') + '</div>';
  t3.innerHTML = t3Html;

  // HTML êµ¬ì„± ì™„ë£Œ í›„ ì°¨íŠ¸ ìƒì„±
  chartItemTop15(byItem, $('chartTop15'));
  if (defectCols.length) chartHeatmap(byItem, $('chartHeatmap'));
  chartScatter(byItem, $('chartScatter'));
  if (filtered && filtered.length) {
    chartScatterAnimated(filtered, byDate, $('chartScatterAnim'));
  } else {
    $('chartScatterAnim').innerHTML = '<div class="info-box warn">ì• ë‹ˆë©”ì´ì…˜ì€ ìƒˆë¡œ ë¶„ì„í•  ë•Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤. (ì´ì „ ì €ì¥ ë°ì´í„°ì—ì„œëŠ” ì§€ì›ë˜ì§€ ì•ŠìŒ)</div>';
  }

  // â”€â”€ íƒ­4: ì•Œë¦¼ & ë¦¬í¬íŠ¸ â”€â”€
  const t4 = $('tab4');

  // ìë™ ìš”ì•½ í…ìŠ¤íŠ¸ (ìƒë‹¨ ë°°ì¹˜)
  const summaryText = `ë¶„ì„ ê¸°ê°„ ${byDate.length > 0 ? dateKRFull(byDate[0].ìƒì‚°ì¼ì) + ' ~ ' + dateKRFull(byDate[byDate.length-1].ìƒì‚°ì¼ì) : ''} ê¸°ì¤€, ì´ ìƒì‚°ìˆ˜ëŸ‰ ${fmt(kpi.ì´ìƒì‚°ìˆ˜ëŸ‰)}ê°œ ì¤‘ ë¶ˆëŸ‰ ${fmt(kpi.ì´ë¶ˆëŸ‰ìˆ˜ëŸ‰)}ê°œ (ë¶ˆëŸ‰ë¥  ${pct(kpi.ë¶ˆëŸ‰ë¥ )})ê°€ ë°œìƒí•˜ì˜€ìŠµë‹ˆë‹¤.${weekChg.ë³€í™” !== 0 ? ' ì „ì£¼ ëŒ€ë¹„ ë¶ˆëŸ‰ë¥ ì´ ' + pct(Math.abs(weekChg.ë³€í™”)) + (weekChg.ë³€í™” > 0 ? ' ì•…í™”' : ' ê°œì„ ') + 'ë˜ì—ˆìŠµë‹ˆë‹¤.' : ''}${alerts.length > 0 ? ' ë¶ˆëŸ‰ë¥  ' + threshold + '% ì´ˆê³¼ í’ˆëª©ì€ ' + alerts.length + 'ê±´ì…ë‹ˆë‹¤.' : ''}`;
  let alertHtml = `<div class="chart-box"><h3>ìë™ ìš”ì•½</h3><div class="info-box info" style="line-height:1.6">${summaryText}</div></div>`;

  alertHtml += `<div class="chart-box"><h3>ë¶ˆëŸ‰ë¥  ${threshold}% ì´ˆê³¼ í’ˆëª©</h3>`;
  if (!alerts.length) {
    alertHtml += `<div class="info-box success">ë¶ˆëŸ‰ë¥  ${threshold}%ë¥¼ ì´ˆê³¼í•˜ëŠ” í’ˆëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
  } else {
    alertHtml += `<div class="info-box warn" style="margin-bottom:12px">ì´ˆê³¼ í’ˆëª©: ${alerts.length}ê±´</div>`;
    const alertHeaders = ['í’ˆëª…','ìƒì‚°ìˆ˜ëŸ‰','ì–‘í’ˆìˆ˜ëŸ‰','ë¶ˆëŸ‰ìˆ˜ëŸ‰','ë¶ˆëŸ‰ë¥ '];
    alertHtml += makeTableEnhanced(alertHeaders, alerts, 'tblAlerts');
  }
  alertHtml += '</div>';

  alertHtml += `<div class="chart-box"><h3>ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ</h3>
    <div class="export-bar">
      <button class="btn btn-success" id="btnExportExcel" style="flex:1;min-width:150px">
        Excel ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
      </button>
      <button class="btn btn-danger" id="btnExportPDF" style="flex:1;min-width:150px">
        PDF ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  </div>`;

  t4.innerHTML = alertHtml;

  if ($('btnExportExcel')) $('btnExportExcel').addEventListener('click', () => {
    exportExcel(kpi, byDate, byItem, totals);
  });
  if ($('btnExportPDF')) $('btnExportPDF').addEventListener('click', () => {
    exportPDF();
  });

  // â”€â”€ íƒ­5: p ê´€ë¦¬ë„ (HTML ë¨¼ì € êµ¬ì„±) â”€â”€
  const t5 = $('tab5');
  const spcTotalBad = byDate.reduce((s,r)=>s+r.ë¶ˆëŸ‰ìˆ˜ëŸ‰,0);
  const spcTotalProd = byDate.reduce((s,r)=>s+r.ìƒì‚°ìˆ˜ëŸ‰,0);
  const spcPbar = spcTotalProd ? spcTotalBad/spcTotalProd : 0;
  const spcPbarPct = spcPbar * 100;
  const spcAvgN = byDate.length ? Math.round(spcTotalProd / byDate.length) : 1;
  const spcUCLavg = (spcPbar + 3*Math.sqrt(spcPbar*(1-spcPbar)/Math.max(spcAvgN,1)))*100;
  const spcLCLavg = Math.max(0, (spcPbar - 3*Math.sqrt(spcPbar*(1-spcPbar)/Math.max(spcAvgN,1)))*100);
  const spcOutCount = byDate.filter(r => {
    const pi = r.ë¶ˆëŸ‰ë¥ *100;
    const ni = Math.max(r.ìƒì‚°ìˆ˜ëŸ‰, 1);
    const ucli = (spcPbar + 3*Math.sqrt(spcPbar*(1-spcPbar)/ni))*100;
    const lcli = Math.max(0,(spcPbar - 3*Math.sqrt(spcPbar*(1-spcPbar)/ni))*100);
    return pi > ucli || pi < lcli;
  }).length;

  let t5Html = `<div class="chart-box">
    <h3>p ê´€ë¦¬ë„ (ë¶ˆëŸ‰ë¥  ê´€ë¦¬)</h3>
    <p style="font-size:12px;color:var(--text-light);margin-bottom:4px">
      <span style="color:#DC2626;font-weight:700">â— ë¹¨ê°„ì </span> ê´€ë¦¬í•œê³„ ì´íƒˆ &nbsp;|&nbsp;
      <span style="color:#F59E0B;font-weight:700">â— ë…¸ë€ì </span> ì—°ì† ê·œì¹™ ìœ„ë°˜ &nbsp;|&nbsp;
      <span style="color:#2563EB;font-weight:700">â— íŒŒë€ì </span> ì •ìƒ
    </p>
    <p style="font-size:11px;color:var(--text-light);margin-bottom:8px">
      UCLáµ¢ = pÌ„ + 3âˆš(pÌ„(1âˆ’pÌ„)/náµ¢) &nbsp; LCLáµ¢ = pÌ„ âˆ’ 3âˆš(pÌ„(1âˆ’pÌ„)/náµ¢) &nbsp; â€» ê²€ì‚¬ìˆ˜(náµ¢)ì— ë”°ë¼ ê´€ë¦¬í•œê³„ ë³€ë™
    </p>
    <div id="chartSPC"></div>
  </div>`;
  t5Html += `<div class="chart-box"><h3>p ê´€ë¦¬ë„ ìš”ì•½</h3>
    <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="kpi-card"><div class="value" style="color:var(--primary)">${pct(spcPbarPct)}</div><div class="label">pÌ„ (ì¤‘ì‹¬ì„ )</div></div>
      <div class="kpi-card"><div class="value" style="color:var(--danger)">${pct(spcUCLavg)}</div><div class="label">UCL (í‰ê·  náµ¢ ê¸°ì¤€)</div></div>
      <div class="kpi-card"><div class="value" style="color:var(--warning)">${pct(spcLCLavg)}</div><div class="label">LCL (í‰ê·  náµ¢ ê¸°ì¤€)</div></div>
    </div>
    <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr);margin-top:10px">
      <div class="kpi-card"><div class="value" style="color:var(--gray)">${fmt(spcAvgN)}</div><div class="label">í‰ê·  ì„œë¸Œê·¸ë£¹ í¬ê¸°</div></div>
      <div class="kpi-card"><div class="value" style="color:${spcOutCount>0?'var(--danger)':'var(--success)'}">${spcOutCount}ê±´</div><div class="label">ê´€ë¦¬ì´íƒˆ íšŸìˆ˜</div></div>
      <div class="kpi-card"><div class="value" style="color:${spcOutCount===0?'var(--success)':'var(--danger)'}">${spcOutCount===0?'ì•ˆì •':'ë¶ˆì•ˆì •'}</div><div class="label">ê³µì • ìƒíƒœ</div></div>
    </div>
  </div>`;
  t5.innerHTML = t5Html;
  chartSPC(byDate, $('chartSPC'));

  // â”€â”€ íƒ­6: ìˆ˜ìœ¨ ë¶„ì„ (HTML ë¨¼ì € êµ¬ì„±) â”€â”€
  const t6 = $('tab6');
  t6.innerHTML = '<div class="chart-box"><h3>ğŸ¯ ìˆ˜ìœ¨ ëª©í‘œ ë‹¬ì„± í˜„í™© (ëª©í‘œ: 98%)</h3><div id="yieldTargetArea"></div></div>'
    + '<div class="chart-box"><h3>ì „ì²´ ìˆ˜ìœ¨ (ì–‘í’ˆë¥ )</h3><div id="chartYieldGauge"></div></div>'
    + '<div class="chart-box"><h3>ğŸ“Š ìˆ˜ìœ¨ êµ¬ê°„ë³„ í’ˆëª© ë¶„í¬</h3><p style="font-size:11px;color:var(--text-light);margin-top:-8px;margin-bottom:4px">í’ˆëª©ë“¤ì˜ ìˆ˜ìœ¨ì´ ì–´ë–¤ êµ¬ê°„ì— ë¶„í¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”</p><div id="chartYieldDist"></div></div>'
    + '<div class="chart-box"><h3>ì¼ìë³„ ìˆ˜ìœ¨ ì¶”ì´</h3><div id="chartYieldTrend"></div></div>'
    + '<div class="chart-box"><h3>í’ˆëª©ë³„ ìˆ˜ìœ¨ í•˜ìœ„ 20 (ëª©í‘œì„ : 98%)</h3><div id="chartYieldItem"></div></div>';
  renderYieldTarget(byItem, kpi, $('yieldTargetArea'));
  chartYieldGauge(kpi, $('chartYieldGauge'));
  chartYieldDistribution(byItem, $('chartYieldDist'));
  chartYieldTrend(byDate, $('chartYieldTrend'));
  chartYieldByItem(byItem, $('chartYieldItem'));

  // â”€â”€ íƒ­7: ê¸°ê°„ ë¹„êµ â”€â”€
  renderPeriodComparison(filtered, $('tab7'));

  // â”€â”€ íƒ­8: í’ˆëª© ì‹¬ì¸µë¶„ì„ â”€â”€
  renderDrilldown(filtered, byItem, $('tab8'));

  // â”€â”€ íƒ­9: AI í’ˆì§ˆì§„ë‹¨ â”€â”€
  renderAIDiagnosis(kpi, byDate, byItem, filtered);

  // ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ (ì´ˆê¸° ë Œë” í›„ + ëª¨ë°”ì¼ ì§€ì—° ëŒ€ì‘)
  requestAnimationFrame(() => {
    window.dispatchEvent(new Event('resize'));
    // ëª¨ë°”ì¼ì—ì„œ ì¶”ê°€ ì§€ì—° ë¦¬ì‚¬ì´ì¦ˆ (ë¸Œë¼ìš°ì € ë ˆì´ì•„ì›ƒ ì™„ë£Œ ëŒ€ê¸°)
    if (isMobile()) {
      setTimeout(() => {
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab) {
          activeTab.querySelectorAll('.js-plotly-plot').forEach(p => {
            try { Plotly.Plots.resize(p); } catch(e) {}
          });
        }
      }, 500);
    }
  });
}

/* ================================================================
   í™”ë©´ ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì°¨íŠ¸ ì¬ì¡°ì •
   ================================================================ */
/* ================================================================
   PDF ë¦¬í¬íŠ¸ ë‚´ë³´ë‚´ê¸°
   ================================================================ */
async function exportPDF() {
  const btn = $('btnExportPDF');
  btn.textContent = 'PDF ìƒì„± ì¤‘...';
  btn.disabled = true;
  try {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    const tabs = ['tab1', 'tab5', 'tab6'];
    const tabNames = ['ì „ì²´ ìš”ì•½', 'SPC ê´€ë¦¬ë„', 'ìˆ˜ìœ¨ ë¶„ì„'];

    for (let i = 0; i < tabs.length; i++) {
      const tabEl = $(tabs[i]);
      switchTab(tabs[i]);
      await new Promise(r => setTimeout(r, 500));
      tabEl.querySelectorAll('.js-plotly-plot').forEach(p => Plotly.Plots.resize(p));
      await new Promise(r => setTimeout(r, 300));

      const canvas = await html2canvas(tabEl, { scale: 1.5, useCORS: true, backgroundColor: document.body.classList.contains('dark') ? '#111827' : '#FFFFFF' });
      const imgData = canvas.toDataURL('image/jpeg', 0.85);
      if (i > 0) pdf.addPage();
      const pw = pdf.internal.pageSize.getWidth() - 20;
      const ph = canvas.height * pw / canvas.width;
      pdf.setFontSize(14);
      pdf.text(tabNames[i], 10, 12);
      pdf.addImage(imgData, 'JPEG', 10, 18, pw, Math.min(ph, pdf.internal.pageSize.getHeight() - 25));
    }

    // ì²« íƒ­ìœ¼ë¡œ ë³µê·€
    switchTab('tab1');

    pdf.save('ìƒì‚°í˜„í™©_ë¶„ì„_ë¦¬í¬íŠ¸.pdf');
  } catch (e) {
    showToast('PDF ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + e.message, 'error');
  } finally {
    btn.textContent = 'PDF ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ';
    btn.disabled = false;
  }
}

let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    document.querySelectorAll('.js-plotly-plot').forEach(p => Plotly.Plots.resize(p));
    // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ FAB í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
    const fab = $('mobileAnalyzeFab');
    if (!isMobile()) {
      fab.classList.remove('show');
    } else if ($('analyzeArea').style.display !== 'none' && $('dashboard').style.display === 'none') {
      fab.classList.add('show');
    }
  }, 200);
});

/* ================================================================
   GitHub ì—‘ì…€ ìë™ ë¡œë“œ (ì ‘ì† ì‹œ ìµœì‹  ë°ì´í„° ìë™ í‘œì‹œ)
   ================================================================ */
(async function autoLoadFromGitHub() {
  const EXCEL_URL = 'https://raw.githubusercontent.com/99805106aa-web/namdogeum-dashboard/main/data.xlsx';
  try {
    const response = await fetch(EXCEL_URL);
    if (!response.ok) return;
    const arrayBuffer = await response.arrayBuffer();
    workbook = XLSX.read(new Uint8Array(arrayBuffer), { type: 'array', cellDates: true });
    const fd = document.getElementById('fileDrop');
    if (fd) fd.innerHTML = '<div style="color:var(--primary);font-weight:600;font-size:13px">âœ… ìµœì‹  ë°ì´í„° ìë™ ë¡œë“œë¨ (GitHub)</div>';
    populateSheets();
    await new Promise(r => setTimeout(r, 300));
    $('btnAnalyze').click();
  } catch(e) { /* ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ, ì•„ë˜ localStorage ë³µì›ìœ¼ë¡œ fallback */ }
})();

/* ================================================================
   í˜ì´ì§€ ë¡œë“œ ì‹œ ë§ˆì§€ë§‰ ë¶„ì„ ê²°ê³¼ ë³µì›
   ================================================================ */
(function restoreLastAnalysis() {
  try {
    const saved = localStorage.getItem('ndm_lastAnalysis');
    if (!saved) return;
    const d = JSON.parse(saved);
    const ts = new Date(d.timestamp);
    const dateLabel = ts.getFullYear() + 'ë…„ ' + (ts.getMonth()+1) + 'ì›” ' + ts.getDate() + 'ì¼ '
      + String(ts.getHours()).padStart(2,'0') + ':' + String(ts.getMinutes()).padStart(2,'0');
    $('lastAnalysisDate').textContent = 'ìµœê·¼ ë¶„ì„: ' + dateLabel;

    // ì €ì¥ëœ defectCols ë³µì›
    if (d.defectColsSaved) defectCols = d.defectColsSaved;

    // filtered ì›ë³¸ ë°ì´í„° ë³µì› (í’ˆëª© ì‹¬ì¸µë¶„ì„, ê¸°ê°„ë¹„êµ, ì• ë‹ˆë©”ì´ì…˜ ë“±ì— í•„ìš”)
    const filteredData = d.filtered && d.filtered.length ? d.filtered : [];

    // cleanedData ë³µì› â†’ í•„í„° ì ìš©/ë¶„ì„ ì‹œì‘ì´ ë™ì‘í•˜ë„ë¡
    if (filteredData.length) {
      cleanedData = filteredData;
      // ë‚ ì§œë¥¼ Date ê°ì²´ë¡œ ë³µì› (JSON ì§ë ¬í™” ì‹œ ë¬¸ìì—´ë¡œ ë³€í™˜ë¨)
      cleanedData.forEach(r => {
        if (r.ìƒì‚°ì¼ì && !(r.ìƒì‚°ì¼ì instanceof Date)) r.ìƒì‚°ì¼ì = new Date(r.ìƒì‚°ì¼ì);
      });
    }

    // í•„í„° ë‚ ì§œ/í’ˆëª© ë³µì›
    const dates = cleanedData.length ? cleanedData.map(r => dateStr(r.ìƒì‚°ì¼ì)).sort() : [];
    if (dates.length) {
      $('filterStart').value = dates[0];
      $('filterEnd').value = dates[dates.length-1];
      $('filterStart').min = dates[0];
      $('filterStart').max = dates[dates.length-1];
      $('filterEnd').min = dates[0];
      $('filterEnd').max = dates[dates.length-1];
      $('filterDateRange').textContent = `ë°ì´í„° ë²”ìœ„: ${dates[0]} ~ ${dates[dates.length-1]} (${[...new Set(dates)].length}ì¼)`;
      // í’ˆëª© í•„í„° ì„¤ì •
      const items = [...new Set(cleanedData.map(r => r.í’ˆëª…))].sort();
      setupItemFilter(items);
    } else if (d.filterStart && d.filterEnd) {
      $('filterStart').value = d.filterStart;
      $('filterEnd').value = d.filterEnd;
      $('filterDateRange').textContent = `ë°ì´í„° ë²”ìœ„: ${d.filterStart} ~ ${d.filterEnd}`;
    }

    // ëŒ€ì‹œë³´ë“œ ë Œë”ë§
    renderDashboard(d.kpi, d.byDate, d.byItem, d.totals, d.alerts, d.threshold, filteredData);

    // ì•ˆë‚´ ë©”ì‹œì§€
    const notice = document.createElement('div');
    notice.className = 'info-box info';
    notice.style.cssText = 'margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px';
    const noticeText = filteredData.length > 0
      ? `ì´ì „ ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤ (${dateLabel}). í•„í„° ì ìš© ë° ì¬ë¶„ì„ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.`
      : `ì´ì „ ë¶„ì„ ê²°ê³¼ë¥¼ í‘œì‹œ ì¤‘ì…ë‹ˆë‹¤ (${dateLabel}). ìƒˆ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ì „ì²´ ê¸°ëŠ¥ì´ í™œì„±í™”ë©ë‹ˆë‹¤.`;
    notice.innerHTML = `<span>${noticeText}</span>
      <button class="btn btn-sm" style="background:var(--gray);color:#fff" onclick="this.parentElement.remove()">ë‹«ê¸°</button>`;
    $('dashboard').insertBefore(notice, $('dashboard').firstChild);
  } catch(e) { /* ë³µì› ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ */ }
})();

</script>
</body>
</html>
